"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[135],{8688:(e,t,n)=>{n.d(t,{GG:()=>ue,My:()=>lW,P:()=>l$,aU:()=>ll,gS:()=>ut,rJ:()=>lr});var r,i,s,a,o=n(944),l=n(8024),u=n(1437),h=n(8966),c=n(7898),d=n(426),f=n(2818),m=n(5714).Buffer;let g="@firebase/firestore",p="4.9.3";class y{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}y.UNAUTHENTICATED=new y(null),y.GOOGLE_CREDENTIALS=new y("google-credentials-uid"),y.FIRST_PARTY=new y("first-party-uid"),y.MOCK_USER=new y("mock-user");let w="12.7.0",v=new u.Vy("@firebase/firestore");function I(){return v.logLevel}function T(e,...t){if(v.logLevel<=u.$b.DEBUG){let n=t.map(_);v.debug(`Firestore (${w}): ${e}`,...n)}}function E(e,...t){if(v.logLevel<=u.$b.ERROR){let n=t.map(_);v.error(`Firestore (${w}): ${e}`,...n)}}function b(e,...t){if(v.logLevel<=u.$b.WARN){let n=t.map(_);v.warn(`Firestore (${w}): ${e}`,...n)}}function _(e){if("string"==typeof e)return e;try{return JSON.stringify(e)}catch(t){return e}}function S(e,t,n){let r="Unexpected state";"string"==typeof t?r=t:n=t,x(e,r,n)}function x(e,t,n){let r=`FIRESTORE (${w}) INTERNAL ASSERTION FAILED: ${t} (ID: ${e.toString(16)})`;if(void 0!==n)try{r+=" CONTEXT: "+JSON.stringify(n)}catch(e){r+=" CONTEXT: "+n}throw E(r),Error(r)}function N(e,t,n,r){let i="Unexpected state";"string"==typeof n?i=n:r=n,e||x(t,i,r)}let D={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class C extends h.g{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class A{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class k{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class V{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(y.UNAUTHENTICATED))}shutdown(){}}class R{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class M{constructor(e){this.t=e,this.currentUser=y.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){N(void 0===this.o,42304);let n=this.i,r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve(),i=new A;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new A,e.enqueueRetryable(()=>r(this.currentUser))};let s=()=>{let t=i;e.enqueueRetryable(async()=>{await t.promise,await r(this.currentUser)})},a=e=>{T("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.o&&(this.auth.addAuthTokenListener(this.o),s())};this.t.onInit(e=>a(e)),setTimeout(()=>{if(!this.auth){let e=this.t.getImmediate({optional:!0});e?a(e):(T("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new A)}},0),s()}getToken(){let e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then(t=>this.i!==e?(T("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(N("string"==typeof t.accessToken,31837,{l:t}),new k(t.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){let e=this.auth&&this.auth.getUid();return N(null===e||"string"==typeof e,2055,{h:e}),new y(e)}}class O{constructor(e,t,n){this.P=e,this.T=t,this.I=n,this.type="FirstParty",this.user=y.FIRST_PARTY,this.A=new Map}R(){return this.I?this.I():null}get headers(){this.A.set("X-Goog-AuthUser",this.P);let e=this.R();return e&&this.A.set("Authorization",e),this.T&&this.A.set("X-Goog-Iam-Authorization-Token",this.T),this.A}}class F{constructor(e,t,n){this.P=e,this.T=t,this.I=n}getToken(){return Promise.resolve(new O(this.P,this.T,this.I))}start(e,t){e.enqueueRetryable(()=>t(y.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class P{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e,t){this.V=t,this.forceRefresh=!1,this.appCheck=null,this.m=null,this.p=null,(0,o.xZ)(e)&&e.settings.appCheckToken&&(this.p=e.settings.appCheckToken)}start(e,t){N(void 0===this.o,3512);let n=e=>{null!=e.error&&T("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);let n=e.token!==this.m;return this.m=e.token,T("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable(()=>n(t))};let r=e=>{T("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.o&&this.appCheck.addTokenListener(this.o)};this.V.onInit(e=>r(e)),setTimeout(()=>{if(!this.appCheck){let e=this.V.getImmediate({optional:!0});e?r(e):T("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}},0)}getToken(){if(this.p)return Promise.resolve(new P(this.p));let e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(N("string"==typeof e.token,44558,{tokenResult:e}),this.m=e.token,new P(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}class U{static newId(){let e=62*Math.floor(256/62),t="";for(;t.length<20;){let n=function(e){let t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(40);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let e=0;e<40;e++)n[e]=Math.floor(256*Math.random());return n}(0);for(let r=0;r<n.length;++r)t.length<20&&n[r]<e&&(t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(n[r]%62))}return t}}function q(e,t){return e<t?-1:e>t?1:0}function B(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=e.charAt(r),i=t.charAt(r);if(n!==i)return z(n)===z(i)?q(n,i):z(n)?1:-1}return q(e.length,t.length)}function z(e){let t=e.charCodeAt(0);return t>=55296&&t<=57343}function K(e,t,n){return e.length===t.length&&e.every((e,r)=>n(e,t[r]))}let $="__name__";class G{constructor(e,t,n){void 0===t?t=0:t>e.length&&S(637,{offset:t,range:e.length}),void 0===n?n=e.length-t:n>e.length-t&&S(1746,{length:n,range:e.length-t}),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===G.comparator(this,e)}child(e){let t=this.segments.slice(this.offset,this.limit());return e instanceof G?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){let n=Math.min(e.length,t.length);for(let r=0;r<n;r++){let n=G.compareSegments(e.get(r),t.get(r));if(0!==n)return n}return q(e.length,t.length)}static compareSegments(e,t){let n=G.isNumericId(e),r=G.isNumericId(t);return n&&!r?-1:!n&&r?1:n&&r?G.extractNumericId(e).compare(G.extractNumericId(t)):B(e,t)}static isNumericId(e){return e.startsWith("__id")&&e.endsWith("__")}static extractNumericId(e){return c.jz.fromString(e.substring(4,e.length-2))}}class j extends G{construct(e,t,n){return new j(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){let t=[];for(let n of e){if(n.indexOf("//")>=0)throw new C(D.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>e.length>0))}return new j(t)}static emptyPath(){return new j([])}}let Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends G{construct(e,t,n){return new W(e,t,n)}static isValidIdentifier(e){return Q.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e)).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&this.get(0)===$}static keyField(){return new W([$])}static fromServerFormat(e){let t=[],n="",r=0,i=()=>{if(0===n.length)throw new C(D.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""},s=!1;for(;r<e.length;){let t=e[r];if("\\"===t){if(r+1===e.length)throw new C(D.INVALID_ARGUMENT,"Path has trailing escape character: "+e);let t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new C(D.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?s=!s:"."!==t||s?n+=t:i(),r++}if(i(),s)throw new C(D.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class H{constructor(e){this.path=e}static fromPath(e){return new H(j.fromString(e))}static fromName(e){return new H(j.fromString(e).popFirst(5))}static empty(){return new H(j.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===j.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return j.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new H(new j(e.slice()))}}function J(e,t,n){if(!n)throw new C(D.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Y(e){if(!H.isDocumentKey(e))throw new C(D.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function X(e){if(H.isDocumentKey(e))throw new C(D.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Z(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}function ee(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{var t;let n=(t=e).constructor?t.constructor.name:null;return n?`a custom ${n} object`:"an object"}}return"function"==typeof e?"a function":S(12329,{type:typeof e})}function et(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new C(D.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{let n=ee(e);throw new C(D.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function en(e,t){let n={typeString:e};return t&&(n.value=t),n}function er(e,t){let n;if(!Z(e))throw new C(D.INVALID_ARGUMENT,"JSON must be an object");for(let r in t)if(t[r]){let i=t[r].typeString,s="value"in t[r]?{value:t[r].value}:void 0;if(!(r in e)){n=`JSON missing required field: '${r}'`;break}let a=e[r];if(i&&typeof a!==i){n=`JSON field '${r}' must be a ${i}.`;break}if(void 0!==s&&a!==s.value){n=`Expected '${r}' field to equal '${s.value}'`;break}}if(n)throw new C(D.INVALID_ARGUMENT,n);return!0}class ei{static now(){return ei.fromMillis(Date.now())}static fromDate(e){return ei.fromMillis(e.getTime())}static fromMillis(e){let t=Math.floor(e/1e3),n=Math.floor((e-1e3*t)*1e6);return new ei(t,n)}constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0||t>=1e9)throw new C(D.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-0xe7791f700||e>=0x3afff44180)throw new C(D.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?q(this.nanoseconds,e.nanoseconds):q(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{type:ei._jsonSchemaVersion,seconds:this.seconds,nanoseconds:this.nanoseconds}}static fromJSON(e){if(er(e,ei._jsonSchema))return new ei(e.seconds,e.nanoseconds)}valueOf(){return String(this.seconds- -0xe7791f700).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}ei._jsonSchemaVersion="firestore/timestamp/1.0",ei._jsonSchema={type:en("string",ei._jsonSchemaVersion),seconds:en("number"),nanoseconds:en("number")};class es{static fromTimestamp(e){return new es(e)}static min(){return new es(new ei(0,0))}static max(){return new es(new ei(0x3afff4417f,0x3b9ac9ff))}constructor(e){this.timestamp=e}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ea{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function eo(e){return e.fields.find(e=>2===e.kind)}function el(e){return e.fields.filter(e=>2!==e.kind)}ea.UNKNOWN_ID=-1;class eu{constructor(e,t){this.fieldPath=e,this.kind=t}}class eh{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new eh(0,ef.min())}}function ec(e,t){let n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1;return new ef(es.fromTimestamp(1e9===r?new ei(n+1,0):new ei(n,r)),H.empty(),t)}function ed(e){return new ef(e.readTime,e.key,-1)}class ef{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ef(es.min(),H.empty(),-1)}static max(){return new ef(es.max(),H.empty(),-1)}}function em(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=H.comparator(e.documentKey,t.documentKey))?n:q(e.largestBatchId,t.largestBatchId)}let eg="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ep{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ey(e){if(e.code!==D.FAILED_PRECONDITION||e.message!==eg)throw e;T("LocalStore","Unexpectedly lost primary lease")}class ew{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&S(59440),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ew((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{let t=e();return t instanceof ew?t:ew.resolve(t)}catch(e){return ew.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):ew.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):ew.reject(t)}static resolve(e){return new ew((t,n)=>{t(e)})}static reject(e){return new ew((t,n)=>{n(e)})}static waitFor(e){return new ew((t,n)=>{let r=0,i=0,s=!1;e.forEach(e=>{++r,e.next(()=>{++i,s&&i===r&&t()},e=>n(e))}),s=!0,i===r&&t()})}static or(e){let t=ew.resolve(!1);for(let n of e)t=t.next(e=>e?ew.resolve(e):n());return t}static forEach(e,t){let n=[];return e.forEach((e,r)=>{n.push(t.call(this,e,r))}),this.waitFor(n)}static mapArray(e,t){return new ew((n,r)=>{let i=e.length,s=Array(i),a=0;for(let o=0;o<i;o++){let l=o;t(e[l]).next(e=>{s[l]=e,++a===i&&n(s)},e=>r(e))}})}static doWhile(e,t){return new ew((n,r)=>{let i=()=>{!0===e()?t().next(()=>{i()},r):n()};i()})}}let ev="SimpleDb";class eI{static open(e,t,n,r){try{return new eI(t,e.transaction(r,n))}catch(e){throw new e_(t,e)}}constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.S=new A,this.transaction.oncomplete=()=>{this.S.resolve()},this.transaction.onabort=()=>{t.error?this.S.reject(new e_(e,t.error)):this.S.resolve()},this.transaction.onerror=t=>{let n=eC(t.target.error);this.S.reject(new e_(e,n))}}get D(){return this.S.promise}abort(e){e&&this.S.reject(e),this.aborted||(T(ev,"Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}C(){let e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){return new ex(this.transaction.objectStore(e))}}class eT{static delete(e){return T(ev,"Removing database:",e),eN((0,h.mS)().indexedDB.deleteDatabase(e)).toPromise()}static v(){if(!(0,h.zW)())return!1;if(eT.F())return!0;let e=(0,h.ZQ)(),t=eT.M(e),n=eE(e);return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||0<t&&t<10||0<n&&n<4.5)}static F(){return void 0!==f&&"YES"===f.__PRIVATE_env?.__PRIVATE_USE_MOCK_PERSISTENCE}static O(e,t){return e.store(t)}static M(e){let t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i);return Number(t?t[1].split("_").slice(0,2).join("."):"-1")}constructor(e,t,n){this.name=e,this.version=t,this.N=n,this.B=null,12.2===eT.M((0,h.ZQ)())&&E("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}async L(e){return this.db||(T(ev,"Opening database:",this.name),this.db=await new Promise((t,n)=>{let r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{t(e.target.result)},r.onblocked=()=>{n(new e_(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{let r=t.target.error;"VersionError"===r.name?n(new C(D.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new C(D.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new e_(e,r))},r.onupgradeneeded=e=>{T(ev,'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);let t=e.target.result;this.N.k(t,r.transaction,e.oldVersion,this.version).next(()=>{T(ev,"Database upgrade to version "+this.version+" complete")})}})),this.q&&(this.db.onversionchange=e=>this.q(e)),this.db}$(e){this.q=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){let i="readonly"===t,s=0;for(;;){++s;try{this.db=await this.L(e);let t=eI.open(this.db,e,i?"readonly":"readwrite",n),s=r(t).next(e=>(t.C(),e)).catch(e=>(t.abort(e),ew.reject(e))).toPromise();return s.catch(()=>{}),await t.D,s}catch(t){let e="FirebaseError"!==t.name&&s<3;if(T(ev,"Transaction failed with error:",t.message,"Retrying:",e),this.close(),!e)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}function eE(e){let t=e.match(/Android ([\d.]+)/i);return Number(t?t[1].split(".").slice(0,2).join("."):"-1")}class eb{constructor(e){this.U=e,this.K=!1,this.W=null}get isDone(){return this.K}get G(){return this.W}set cursor(e){this.U=e}done(){this.K=!0}j(e){this.W=e}delete(){return eN(this.U.delete())}}class e_ extends C{constructor(e,t){super(D.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function eS(e){return"IndexedDbTransactionError"===e.name}class ex{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(T(ev,"PUT",this.store.name,e,t),n=this.store.put(t,e)):(T(ev,"PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),eN(n)}add(e){return T(ev,"ADD",this.store.name,e,e),eN(this.store.add(e))}get(e){return eN(this.store.get(e)).next(t=>(void 0===t&&(t=null),T(ev,"GET",this.store.name,e,t),t))}delete(e){return T(ev,"DELETE",this.store.name,e),eN(this.store.delete(e))}count(){return T(ev,"COUNT",this.store.name),eN(this.store.count())}J(e,t){let n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){let e=r.getAll(n.range);return new ew((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}{let e=this.cursor(n),t=[];return this.H(e,(e,n)=>{t.push(n)}).next(()=>t)}}Y(e,t){let n=this.store.getAll(e,null===t?void 0:t);return new ew((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}})}Z(e,t){T(ev,"DELETE ALL",this.store.name);let n=this.options(e,t);n.X=!1;let r=this.cursor(n);return this.H(r,(e,t,n)=>n.delete())}ee(e,t){let n;t?n=e:(n={},t=e);let r=this.cursor(n);return this.H(r,t)}te(e){let t=this.cursor({});return new ew((n,r)=>{t.onerror=e=>{r(eC(e.target.error))},t.onsuccess=t=>{let r=t.target.result;r?e(r.primaryKey,r.value).next(e=>{e?r.continue():n()}):n()}})}H(e,t){let n=[];return new ew((r,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{let i=e.target.result;if(!i)return void r();let s=new eb(i),a=t(i.primaryKey,i.value,s);if(a instanceof ew){let e=a.catch(e=>(s.done(),ew.reject(e)));n.push(e)}s.isDone?r():null===s.G?i.continue():i.continue(s.G)}}).next(()=>ew.waitFor(n))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){let n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function eN(e){return new ew((t,n)=>{e.onsuccess=e=>{t(e.target.result)},e.onerror=e=>{n(eC(e.target.error))}})}let eD=!1;function eC(e){let t=eT.M((0,h.ZQ)());if(t>=12.2&&t<13){let t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){let e=new C("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return eD||(eD=!0,setTimeout(()=>{throw e},0)),e}}return e}let eA="IndexBackfiller";class ek{constructor(e,t){this.asyncQueue=e,this.ne=t,this.task=null}start(){this.re(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}re(e){T(eA,`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{let e=await this.ne.ie();T(eA,`Documents written: ${e}`)}catch(e){eS(e)?T(eA,"Ignoring IndexedDB error during index backfill: ",e):await ey(e)}await this.re(6e4)})}}class eV{constructor(e,t){this.localStore=e,this.persistence=t}async ie(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",t=>this.se(t,e))}se(e,t){let n=new Set,r=t,i=!0;return ew.doWhile(()=>!0===i&&r>0,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>{if(null!==t&&!n.has(t))return T(eA,`Processing collection: ${t}`),this.oe(e,t,r).next(e=>{r-=e,n.add(t)});i=!1})).next(()=>t-r)}oe(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next(r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next(n=>{let i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next(()=>this._e(r,n)).next(n=>(T(eA,`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n))).next(()=>i.size)}))}_e(e,t){let n=e;return t.changes.forEach((e,t)=>{let r=ed(t);em(r,n)>0&&(n=r)}),new ef(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class eR{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ae(e),this.ue=e=>t.writeSequenceNumber(e))}ae(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){let e=++this.previousValue;return this.ue&&this.ue(e),e}}function eM(e){return null==e}function eO(e){return 0===e&&1/e==-1/0}function eF(e){return"number"==typeof e&&Number.isInteger(e)&&!eO(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function eP(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t+="\x01\x01"),t=function(e,t){let n=t,r=e.length;for(let t=0;t<r;t++){let r=e.charAt(t);switch(r){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=r}}return n}(e.get(n),t);return t+"\x01\x01"}function eL(e){let t=e.length;if(N(t>=2,64408,{path:e}),2===t)return N("\x01"===e.charAt(0)&&"\x01"===e.charAt(1),56145,{path:e}),j.emptyPath();let n=t-2,r=[],i="";for(let s=0;s<t;){let t=e.indexOf("\x01",s);switch((t<0||t>n)&&S(50515,{path:e}),e.charAt(t+1)){case"\x01":let a;let o=e.substring(s,t);0===i.length?a=o:(i+=o,a=i,i=""),r.push(a);break;case"\x10":i+=e.substring(s,t),i+="\0";break;case"\x11":i+=e.substring(s,t+1);break;default:S(61167,{path:e})}s=t+2}return new j(r)}eR.ce=-1;let eU="remoteDocuments",eq="owner",eB="owner",ez="mutationQueues",eK="mutations",e$="batchId",eG="userMutationsIndex",ej=["userId","batchId"],eQ={},eW="documentMutations",eH="remoteDocumentsV14",eJ=["prefixPath","collectionGroup","readTime","documentId"],eY="documentKeyIndex",eX=["prefixPath","collectionGroup","documentId"],eZ="collectionGroupIndex",e0=["collectionGroup","readTime","prefixPath","documentId"],e1="remoteDocumentGlobal",e2="remoteDocumentGlobalKey",e4="targets",e5="queryTargetsIndex",e6=["canonicalId","targetId"],e3="targetDocuments",e8=["targetId","path"],e9="documentTargetsIndex",e7=["path","targetId"],te="targetGlobalKey",tt="targetGlobal",tn="collectionParents",tr=["collectionId","parent"],ti="clientMetadata",ts="bundles",ta="namedQueries",to="indexConfiguration",tl="collectionGroupIndex",tu="indexState",th=["indexId","uid"],tc="sequenceNumberIndex",td=["uid","sequenceNumber"],tf="indexEntries",tm=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],tg="documentKeyIndex",tp=["indexId","uid","orderedDocumentKey"],ty="documentOverlays",tw=["userId","collectionPath","documentId"],tv="collectionPathOverlayIndex",tI=["userId","collectionPath","largestBatchId"],tT="collectionGroupOverlayIndex",tE=["userId","collectionGroup","largestBatchId"],tb="globals",t_=[ez,eK,eW,eU,e4,eq,tt,e3,ti,e1,tn,ts,ta],tS=[...t_,ty],tx=[ez,eK,eW,eH,e4,eq,tt,e3,ti,e1,tn,ts,ta,ty],tN=[...tx,to,tu,tf],tD=[...tN,tb];class tC extends ep{constructor(e,t){super(),this.le=e,this.currentSequenceNumber=t}}function tA(e,t){return eT.O(e.le,t)}function tk(e){let t=0;for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function tV(e,t){for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function tR(e){for(let t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tM{constructor(e,t){this.comparator=e,this.root=t||tF.EMPTY}insert(e,t){return new tM(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,tF.BLACK,null,null))}remove(e){return new tM(this.comparator,this.root.remove(e,this.comparator).copy(null,null,tF.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){let n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){let r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return -1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal((t,n)=>(e(t,n),!1))}toString(){let e=[];return this.inorderTraversal((t,n)=>(e.push(`${t}:${n}`),!1)),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new tO(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new tO(this.root,e,this.comparator,!1)}getReverseIterator(){return new tO(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new tO(this.root,e,this.comparator,!0)}}class tO{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&r&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop(),t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;let e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class tF{constructor(e,t,n,r,i){this.key=e,this.value=t,this.color=null!=n?n:tF.RED,this.left=null!=r?r:tF.EMPTY,this.right=null!=i?i:tF.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,i){return new tF(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this,i=n(e,r.key);return(r=i<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===i?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return tF.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),(e=e.copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(0>t(e,r.key))r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return tF.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=(e=e.rotateRight()).colorFlip()),e}rotateLeft(){let e=this.copy(null,null,tF.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){let e=this.copy(null,null,tF.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){let e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){return Math.pow(2,this.check())<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw S(43730,{key:this.key,value:this.value});if(this.right.isRed())throw S(14113,{key:this.key,value:this.value});let e=this.left.check();if(e!==this.right.check())throw S(27949);return e+(this.isRed()?0:1)}}tF.EMPTY=null,tF.RED=!0,tF.BLACK=!1,tF.EMPTY=new class{constructor(){this.size=0}get key(){throw S(57766)}get value(){throw S(16141)}get color(){throw S(16727)}get left(){throw S(29726)}get right(){throw S(36894)}copy(e,t,n,r,i){return this}insert(e,t,n){return new tF(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class tP{constructor(e){this.comparator=e,this.data=new tM(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal((t,n)=>(e(t),!1))}forEachInRange(e,t){let n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){let r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){let t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tL(this.data.getIterator())}getIteratorFrom(e){return new tL(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof tP)||this.size!==e.size)return!1;let t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){let e=[];return this.forEach(t=>{e.push(t)}),e}toString(){let e=[];return this.forEach(t=>e.push(t)),"SortedSet("+e.toString()+")"}copy(e){let t=new tP(this.comparator);return t.data=e,t}}class tL{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function tU(e){return e.hasNext()?e.getNext():void 0}class tq{constructor(e){this.fields=e,e.sort(W.comparator)}static empty(){return new tq([])}unionWith(e){let t=new tP(W.comparator);for(let e of this.fields)t=t.add(e);for(let n of e)t=t.add(n);return new tq(t.toArray())}covers(e){for(let t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return K(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class tB extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class tz{constructor(e){this.binaryString=e}static fromBase64String(e){return new tz(function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new tB("Invalid base64 string: "+e):e}}(e))}static fromUint8Array(e){return new tz(function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e))}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return btoa(this.binaryString)}toUint8Array(){return function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return q(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}tz.EMPTY_BYTE_STRING=new tz("");let tK=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function t$(e){if(N(!!e,39018),"string"==typeof e){let t=0,n=tK.exec(e);if(N(!!n,46558,{timestamp:e}),n[1]){let e=n[1];t=Number(e=(e+"000000000").substr(0,9))}return{seconds:Math.floor(new Date(e).getTime()/1e3),nanos:t}}return{seconds:tG(e.seconds),nanos:tG(e.nanos)}}function tG(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function tj(e){return"string"==typeof e?tz.fromBase64String(e):tz.fromUint8Array(e)}let tQ="server_timestamp",tW="__type__",tH="__previous_value__",tJ="__local_write_time__";function tY(e){return(e?.mapValue?.fields||{})[tW]?.stringValue===tQ}function tX(e){let t=e.mapValue.fields[tH];return tY(t)?tX(t):t}function tZ(e){let t=t$(e.mapValue.fields[tJ].timestampValue);return new ei(t.seconds,t.nanos)}class t0{constructor(e,t,n,r,i,s,a,o,l,u){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=i,this.forceLongPolling=s,this.autoDetectLongPolling=a,this.longPollingOptions=o,this.useFetchStreams=l,this.isUsingEmulator=u}}let t1="(default)";class t2{constructor(e,t){this.projectId=e,this.database=t||t1}static empty(){return new t2("","")}get isDefaultDatabase(){return this.database===t1}isEqual(e){return e instanceof t2&&e.projectId===this.projectId&&e.database===this.database}}let t4="__type__",t5="__max__",t6={mapValue:{fields:{__type__:{stringValue:t5}}}},t3="__vector__",t8="value",t9={nullValue:"NULL_VALUE"};function t7(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?tY(e)?4:nm(e)?0x1fffffffffffff:nd(e)?10:11:S(28295,{value:e})}function ne(e,t){if(e===t)return!0;let n=t7(e);if(n!==t7(t))return!1;switch(n){case 0:case 0x1fffffffffffff:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return tZ(e).isEqual(tZ(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;let n=t$(e.timestampValue),r=t$(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return tj(e.bytesValue).isEqual(tj(t.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return tG(e.geoPointValue.latitude)===tG(t.geoPointValue.latitude)&&tG(e.geoPointValue.longitude)===tG(t.geoPointValue.longitude);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return tG(e.integerValue)===tG(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){let n=tG(e.doubleValue),r=tG(t.doubleValue);return n===r?eO(n)===eO(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return K(e.arrayValue.values||[],t.arrayValue.values||[],ne);case 10:case 11:return function(e,t){let n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(tk(n)!==tk(r))return!1;for(let e in n)if(n.hasOwnProperty(e)&&(void 0===r[e]||!ne(n[e],r[e])))return!1;return!0}(e,t);default:return S(52216,{left:e})}}function nt(e,t){return void 0!==(e.values||[]).find(e=>ne(e,t))}function nn(e,t){if(e===t)return 0;let n=t7(e),r=t7(t);if(n!==r)return q(n,r);switch(n){case 0:case 0x1fffffffffffff:return 0;case 1:return q(e.booleanValue,t.booleanValue);case 2:return function(e,t){let n=tG(e.integerValue||e.doubleValue),r=tG(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return nr(e.timestampValue,t.timestampValue);case 4:return nr(tZ(e),tZ(t));case 5:return B(e.stringValue,t.stringValue);case 6:return function(e,t){let n=tj(e),r=tj(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){let n=e.split("/"),r=t.split("/");for(let e=0;e<n.length&&e<r.length;e++){let t=q(n[e],r[e]);if(0!==t)return t}return q(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){let n=q(tG(e.latitude),tG(t.latitude));return 0!==n?n:q(tG(e.longitude),tG(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return ni(e.arrayValue,t.arrayValue);case 10:return function(e,t){let n=e.fields||{},r=t.fields||{},i=n[t8]?.arrayValue,s=r[t8]?.arrayValue,a=q(i?.values?.length||0,s?.values?.length||0);return 0!==a?a:ni(i,s)}(e.mapValue,t.mapValue);case 11:return function(e,t){if(e===t6.mapValue&&t===t6.mapValue)return 0;if(e===t6.mapValue)return 1;if(t===t6.mapValue)return -1;let n=e.fields||{},r=Object.keys(n),i=t.fields||{},s=Object.keys(i);r.sort(),s.sort();for(let e=0;e<r.length&&e<s.length;++e){let t=B(r[e],s[e]);if(0!==t)return t;let a=nn(n[r[e]],i[s[e]]);if(0!==a)return a}return q(r.length,s.length)}(e.mapValue,t.mapValue);default:throw S(23264,{he:n})}}function nr(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return q(e,t);let n=t$(e),r=t$(t),i=q(n.seconds,r.seconds);return 0!==i?i:q(n.nanos,r.nanos)}function ni(e,t){let n=e.values||[],r=t.values||[];for(let e=0;e<n.length&&e<r.length;++e){let t=nn(n[e],r[e]);if(t)return t}return q(n.length,r.length)}function ns(e){var t,n;return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){let t=t$(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?tj(e.bytesValue).toBase64():"referenceValue"in e?(t=e.referenceValue,H.fromName(t).toString()):"geoPointValue"in e?(n=e.geoPointValue,`geo(${n.latitude},${n.longitude})`):"arrayValue"in e?function(e){let t="[",n=!0;for(let r of e.values||[])n?n=!1:t+=",",t+=ns(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){let t=Object.keys(e.fields||{}).sort(),n="{",r=!0;for(let i of t)r?r=!1:n+=",",n+=`${i}:${ns(e.fields[i])}`;return n+"}"}(e.mapValue):S(61005,{value:e})}function na(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function no(e){return!!e&&"integerValue"in e}function nl(e){return!!e&&"arrayValue"in e}function nu(e){return!!e&&"nullValue"in e}function nh(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function nc(e){return!!e&&"mapValue"in e}function nd(e){return(e?.mapValue?.fields||{})[t4]?.stringValue===t3}function nf(e){if(e.geoPointValue)return{geoPointValue:{...e.geoPointValue}};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:{...e.timestampValue}};if(e.mapValue){let t={mapValue:{fields:{}}};return tV(e.mapValue.fields,(e,n)=>t.mapValue.fields[e]=nf(n)),t}if(e.arrayValue){let t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nf(e.arrayValue.values[n]);return t}return{...e}}function nm(e){return(((e.mapValue||{}).fields||{}).__type__||{}).stringValue===t5}let ng={mapValue:{fields:{[t4]:{stringValue:t3},[t8]:{arrayValue:{}}}}};function np(e,t){let n=nn(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function ny(e,t){let n=nn(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class nw{constructor(e){this.value=e}static empty(){return new nw({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(!nc(t=(t.mapValue.fields||{})[e.get(n)]))return null;return(t=(t.mapValue.fields||{})[e.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nf(t)}setAll(e){let t=W.emptyPath(),n={},r=[];e.forEach((e,i)=>{if(!t.isImmediateParentOf(i)){let e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=i.popLast()}e?n[i.lastSegment()]=nf(e):r.push(i.lastSegment())});let i=this.getFieldsMap(t);this.applyChanges(i,n,r)}delete(e){let t=this.field(e.popLast());nc(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return ne(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];nc(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){for(let r of(tV(t,(t,n)=>e[t]=n),n))delete e[r]}clone(){return new nw(nf(this.value))}}class nv{constructor(e,t,n,r,i,s,a){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=i,this.data=s,this.documentState=a}static newInvalidDocument(e){return new nv(e,0,es.min(),es.min(),es.min(),nw.empty(),0)}static newFoundDocument(e,t,n,r){return new nv(e,1,t,es.min(),n,r,0)}static newNoDocument(e,t){return new nv(e,2,t,es.min(),es.min(),nw.empty(),0)}static newUnknownDocument(e,t){return new nv(e,3,t,es.min(),es.min(),nw.empty(),2)}convertToFoundDocument(e,t){return this.createTime.isEqual(es.min())&&(2===this.documentType||0===this.documentType)&&(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=nw.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=nw.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=es.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof nv&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new nv(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class nI{constructor(e,t){this.position=e,this.inclusive=t}}function nT(e,t,n){let r=0;for(let i=0;i<e.position.length;i++){let s=t[i],a=e.position[i];if(r=s.field.isKeyField()?H.comparator(H.fromName(a.referenceValue),n.key):nn(a,n.data.field(s.field)),"desc"===s.dir&&(r*=-1),0!==r)break}return r}function nE(e,t){if(null===e)return null===t;if(null===t||e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!ne(e.position[n],t.position[n]))return!1;return!0}class nb{constructor(e,t="asc"){this.field=e,this.dir=t}}class n_{}class nS extends n_{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nV(e,t,n):"array-contains"===t?new nF(e,n):"in"===t?new nP(e,n):"not-in"===t?new nL(e,n):"array-contains-any"===t?new nU(e,n):new nS(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new nR(e,n):new nM(e,n)}matches(e){let t=e.data.field(this.field);return"!="===this.op?null!==t&&void 0===t.nullValue&&this.matchesComparison(nn(t,this.value)):null!==t&&t7(this.value)===t7(t)&&this.matchesComparison(nn(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return S(47266,{operator:this.op})}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class nx extends n_{constructor(e,t){super(),this.filters=e,this.op=t,this.Pe=null}static create(e,t){return new nx(e,t)}matches(e){return nN(this)?void 0===this.filters.find(t=>!t.matches(e)):void 0!==this.filters.find(t=>t.matches(e))}getFlattenedFilters(){return null!==this.Pe||(this.Pe=this.filters.reduce((e,t)=>e.concat(t.getFlattenedFilters()),[])),this.Pe}getFilters(){return Object.assign([],this.filters)}}function nN(e){return"and"===e.op}function nD(e){return"or"===e.op}function nC(e){return nA(e)&&nN(e)}function nA(e){for(let t of e.filters)if(t instanceof nx)return!1;return!0}function nk(e,t){let n=e.filters.concat(t);return nx.create(n,e.op)}class nV extends nS{constructor(e,t,n){super(e,t,n),this.key=H.fromName(n.referenceValue)}matches(e){let t=H.comparator(e.key,this.key);return this.matchesComparison(t)}}class nR extends nS{constructor(e,t){super(e,"in",t),this.keys=nO("in",t)}matches(e){return this.keys.some(t=>t.isEqual(e.key))}}class nM extends nS{constructor(e,t){super(e,"not-in",t),this.keys=nO("not-in",t)}matches(e){return!this.keys.some(t=>t.isEqual(e.key))}}function nO(e,t){return(t.arrayValue?.values||[]).map(e=>H.fromName(e.referenceValue))}class nF extends nS{constructor(e,t){super(e,"array-contains",t)}matches(e){let t=e.data.field(this.field);return nl(t)&&nt(t.arrayValue,this.value)}}class nP extends nS{constructor(e,t){super(e,"in",t)}matches(e){let t=e.data.field(this.field);return null!==t&&nt(this.value.arrayValue,t)}}class nL extends nS{constructor(e,t){super(e,"not-in",t)}matches(e){if(nt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;let t=e.data.field(this.field);return null!==t&&void 0===t.nullValue&&!nt(this.value.arrayValue,t)}}class nU extends nS{constructor(e,t){super(e,"array-contains-any",t)}matches(e){let t=e.data.field(this.field);return!(!nl(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>nt(this.value.arrayValue,e))}}class nq{constructor(e,t=null,n=[],r=[],i=null,s=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=i,this.startAt=s,this.endAt=a,this.Te=null}}function nB(e,t=null,n=[],r=[],i=null,s=null,a=null){return new nq(e,t,n,r,i,s,a)}function nz(e){if(null===e.Te){let t=e.path.canonicalString();null!==e.collectionGroup&&(t+="|cg:"+e.collectionGroup),t+="|f:",t+=e.filters.map(e=>(function e(t){if(t instanceof nS)return t.field.canonicalString()+t.op.toString()+ns(t.value);if(nC(t))return t.filters.map(t=>e(t)).join(",");{let n=t.filters.map(t=>e(t)).join(",");return`${t.op}(${n})`}})(e)).join(","),t+="|ob:",t+=e.orderBy.map(e=>e.field.canonicalString()+e.dir).join(","),null==e.limit||(t+="|l:",t+=e.limit),e.startAt&&(t+="|lb:",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map(e=>ns(e)).join(",")),e.endAt&&(t+="|ub:",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map(e=>ns(e)).join(",")),e.Te=t}return e.Te}function nK(e,t){if(e.limit!==t.limit||e.orderBy.length!==t.orderBy.length)return!1;for(let i=0;i<e.orderBy.length;i++){var n,r;if(n=e.orderBy[i],r=t.orderBy[i],!(n.dir===r.dir&&n.field.isEqual(r.field)))return!1}if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!function e(t,n){return t instanceof nS?n instanceof nS&&t.op===n.op&&t.field.isEqual(n.field)&&ne(t.value,n.value):t instanceof nx?n instanceof nx&&t.op===n.op&&t.filters.length===n.filters.length&&t.filters.reduce((t,r,i)=>t&&e(r,n.filters[i]),!0):void S(19439)}(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!nE(e.startAt,t.startAt)&&nE(e.endAt,t.endAt)}function n$(e){return H.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function nG(e,t){return e.filters.filter(e=>e instanceof nS&&e.field.isEqual(t))}function nj(e,t,n){let r=t9,i=!0;for(let n of nG(e,t)){let e=t9,t=!0;switch(n.op){case"<":case"<=":var s;e="nullValue"in(s=n.value)?t9:"booleanValue"in s?{booleanValue:!1}:"integerValue"in s||"doubleValue"in s?{doubleValue:NaN}:"timestampValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in s?{stringValue:""}:"bytesValue"in s?{bytesValue:""}:"referenceValue"in s?na(t2.empty(),H.empty()):"geoPointValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in s?{arrayValue:{}}:"mapValue"in s?nd(s)?ng:{mapValue:{}}:S(35942,{value:s});break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=t9}0>np({value:r,inclusive:i},{value:e,inclusive:t})&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];0>np({value:r,inclusive:i},{value:e,inclusive:n.inclusive})&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}function nQ(e,t,n){let r=t6,i=!0;for(let n of nG(e,t)){let e=t6,t=!0;switch(n.op){case">=":case">":var s;e="nullValue"in(s=n.value)?{booleanValue:!1}:"booleanValue"in s?{doubleValue:NaN}:"integerValue"in s||"doubleValue"in s?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in s?{stringValue:""}:"stringValue"in s?{bytesValue:""}:"bytesValue"in s?na(t2.empty(),H.empty()):"referenceValue"in s?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in s?{arrayValue:{}}:"arrayValue"in s?ng:"mapValue"in s?nd(s)?{mapValue:{}}:t6:S(61959,{value:s}),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=t6}ny({value:r,inclusive:i},{value:e,inclusive:t})>0&&(r=e,i=t)}if(null!==n){for(let s=0;s<e.orderBy.length;++s)if(e.orderBy[s].field.isEqual(t)){let e=n.position[s];ny({value:r,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(r=e,i=n.inclusive);break}}return{value:r,inclusive:i}}class nW{constructor(e,t=null,n=[],r=[],i=null,s="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=i,this.limitType=s,this.startAt=a,this.endAt=o,this.Ie=null,this.Ee=null,this.de=null,this.startAt,this.endAt}}function nH(e){return new nW(e)}function nJ(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function nY(e){return null!==e.collectionGroup}function nX(e){if(null===e.Ie){let t;e.Ie=[];let n=new Set;for(let t of e.explicitOrderBy)e.Ie.push(t),n.add(t.field.canonicalString());let r=e.explicitOrderBy.length>0?e.explicitOrderBy[e.explicitOrderBy.length-1].dir:"asc";(t=new tP(W.comparator),e.filters.forEach(e=>{e.getFlattenedFilters().forEach(e=>{e.isInequality()&&(t=t.add(e.field))})}),t).forEach(t=>{n.has(t.canonicalString())||t.isKeyField()||e.Ie.push(new nb(t,r))}),n.has(W.keyField().canonicalString())||e.Ie.push(new nb(W.keyField(),r))}return e.Ie}function nZ(e){return e.Ee||(e.Ee=function(e,t){if("F"===e.limitType)return nB(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map(e=>{let t="desc"===e.dir?"asc":"desc";return new nb(e.field,t)});let n=e.endAt?new nI(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new nI(e.startAt.position,e.startAt.inclusive):null;return nB(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}(e,nX(e))),e.Ee}function n0(e,t){let n=e.filters.concat([t]);return new nW(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function n1(e,t,n){return new nW(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function n2(e,t){return nK(nZ(e),nZ(t))&&e.limitType===t.limitType}function n4(e){return`${nz(nZ(e))}|lt:${e.limitType}`}function n5(e){var t;let n;return`Query(target=${n=(t=nZ(e)).path.canonicalString(),null!==t.collectionGroup&&(n+=" collectionGroup="+t.collectionGroup),t.filters.length>0&&(n+=`, filters: [${t.filters.map(e=>(function e(t){return t instanceof nS?`${t.field.canonicalString()} ${t.op} ${ns(t.value)}`:t instanceof nx?t.op.toString()+" {"+t.getFilters().map(e).join(" ,")+"}":"Filter"})(e)).join(", ")}]`),null==t.limit||(n+=", limit: "+t.limit),t.orderBy.length>0&&(n+=`, orderBy: [${t.orderBy.map(e=>`${e.field.canonicalString()} (${e.dir})`).join(", ")}]`),t.startAt&&(n+=", startAt: ",n+=t.startAt.inclusive?"b:":"a:",n+=t.startAt.position.map(e=>ns(e)).join(",")),t.endAt&&(n+=", endAt: ",n+=t.endAt.inclusive?"a:":"b:",n+=t.endAt.position.map(e=>ns(e)).join(",")),`Target(${n})`}; limitType=${e.limitType})`}function n6(e,t){return t.isFoundDocument()&&function(e,t){let n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):H.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(let n of nX(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(let n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&(!e.startAt||!!function(e,t,n){let r=nT(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,nX(e),t))&&(!e.endAt||!!function(e,t,n){let r=nT(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,nX(e),t))}function n3(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function n8(e){return(t,n)=>{let r=!1;for(let i of nX(e)){let e=function(e,t,n){let r=e.field.isKeyField()?H.comparator(t.key,n.key):function(e,t,n){let r=t.data.field(e),i=n.data.field(e);return null!==r&&null!==i?nn(r,i):S(42886)}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return -1*r;default:return S(19790,{direction:e.dir})}}(i,t,n);if(0!==e)return e;r=r||i.field.isKeyField()}return 0}}class n9{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n){for(let[t,r]of n)if(this.equalsFn(t,e))return r}}has(e){return void 0!==this.get(e)}set(e,t){let n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<r.length;n++)if(this.equalsFn(r[n][0],e))return void(r[n]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){let t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){tV(this.inner,(t,n)=>{for(let[t,r]of n)e(t,r)})}isEmpty(){return tR(this.inner)}size(){return this.innerSize}}let n7=new tM(H.comparator),re=new tM(H.comparator);function rt(...e){let t=re;for(let n of e)t=t.insert(n.key,n);return t}function rn(e){let t=re;return e.forEach((e,n)=>t=t.insert(e,n.overlayedDocument)),t}function rr(){return new n9(e=>e.toString(),(e,t)=>e.isEqual(t))}let ri=new tM(H.comparator),rs=new tP(H.comparator);function ra(...e){let t=rs;for(let n of e)t=t.add(n);return t}let ro=new tP(q);function rl(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:eO(t)?"-0":t}}function ru(e){return{integerValue:""+e}}function rh(e,t){return eF(t)?ru(t):rl(e,t)}class rc{constructor(){this._=void 0}}function rd(e,t){return e instanceof rw?no(t)||t&&"doubleValue"in t?t:{integerValue:0}:null}class rf extends rc{}class rm extends rc{constructor(e){super(),this.elements=e}}function rg(e,t){let n=rI(t);for(let t of e.elements)n.some(e=>ne(e,t))||n.push(t);return{arrayValue:{values:n}}}class rp extends rc{constructor(e){super(),this.elements=e}}function ry(e,t){let n=rI(t);for(let t of e.elements)n=n.filter(e=>!ne(e,t));return{arrayValue:{values:n}}}class rw extends rc{constructor(e,t){super(),this.serializer=e,this.Ae=t}}function rv(e){return tG(e.integerValue||e.doubleValue)}function rI(e){return nl(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class rT{constructor(e,t){this.field=e,this.transform=t}}class rE{constructor(e,t){this.version=e,this.transformResults=t}}class rb{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new rb}static exists(e){return new rb(void 0,e)}static updateTime(e){return new rb(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function r_(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class rS{}function rx(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new rM(e.key,rb.none()):new rC(e.key,e.data,rb.none());{let n=e.data,r=nw.empty(),i=new tP(W.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),i=i.add(e)}return new rA(e.key,r,new tq(i.toArray()),rb.none())}}function rN(e,t,n,r){return e instanceof rC?function(e,t,n,r){if(!r_(e.precondition,t))return n;let i=e.value.clone(),s=rR(e.fieldTransforms,r,t);return i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,r):e instanceof rA?function(e,t,n,r){if(!r_(e.precondition,t))return n;let i=rR(e.fieldTransforms,r,t),s=t.data;return(s.setAll(rk(e)),s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null===n)?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map(e=>e.field))}(e,t,n,r):r_(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function rD(e,t){var n,r;return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||!(!n||!r)&&K(n,r,(e,t)=>{var n,r;return e.field.isEqual(t.field)&&(n=e.transform,r=t.transform,n instanceof rm&&r instanceof rm||n instanceof rp&&r instanceof rp?K(n.elements,r.elements,ne):n instanceof rw&&r instanceof rw?ne(n.Ae,r.Ae):n instanceof rf&&r instanceof rf)})))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class rC extends rS{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class rA extends rS{constructor(e,t,n,r,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function rk(e){let t=new Map;return e.fieldMask.fields.forEach(n=>{if(!n.isEmpty()){let r=e.data.field(n);t.set(n,r)}}),t}function rV(e,t,n){let r=new Map;N(e.length===n.length,32656,{Re:n.length,Ve:e.length});for(let s=0;s<n.length;s++){var i;let a=e[s],o=a.transform,l=t.data.field(a.field);r.set(a.field,(i=n[s],o instanceof rm?rg(o,l):o instanceof rp?ry(o,l):i))}return r}function rR(e,t,n){let r=new Map;for(let i of e){let e=i.transform,s=n.data.field(i.field);r.set(i.field,e instanceof rf?function(e,t){let n={fields:{[tW]:{stringValue:tQ},[tJ]:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&tY(t)&&(t=tX(t)),t&&(n.fields[tH]=t),{mapValue:n}}(t,s):e instanceof rm?rg(e,s):e instanceof rp?ry(e,s):function(e,t){let n=rd(e,t),r=rv(n)+rv(e.Ae);return no(n)&&no(e.Ae)?ru(r):rl(e.serializer,r)}(e,s))}return r}class rM extends rS{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class rO extends rS{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class rF{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){let n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){let i=this.mutations[t];if(i.key.isEqual(e.key)){var r;r=n[t],i instanceof rC?function(e,t,n){let r=e.value.clone(),i=rV(e.fieldTransforms,t,n.transformResults);r.setAll(i),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(i,e,r):i instanceof rA?function(e,t,n){if(!r_(e.precondition,t))return void t.convertToUnknownDocument(n.version);let r=rV(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(rk(e)),i.setAll(r),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(i,e,r):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,e,r)}}}applyToLocalView(e,t){for(let n of this.baseMutations)n.key.isEqual(e.key)&&(t=rN(n,e,t,this.localWriteTime));for(let n of this.mutations)n.key.isEqual(e.key)&&(t=rN(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){let n=rr();return this.mutations.forEach(r=>{let i=e.get(r.key),s=i.overlayedDocument,a=this.applyToLocalView(s,i.mutatedFields),o=rx(s,a=t.has(r.key)?null:a);null!==o&&n.set(r.key,o),s.isValidDocument()||s.convertToNoDocument(es.min())}),n}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),ra())}isEqual(e){return this.batchId===e.batchId&&K(this.mutations,e.mutations,(e,t)=>rD(e,t))&&K(this.baseMutations,e.baseMutations,(e,t)=>rD(e,t))}}class rP{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){N(e.mutations.length===n.length,58842,{me:e.mutations.length,fe:n.length});let r=ri,i=e.mutations;for(let e=0;e<i.length;e++)r=r.insert(i[e].key,n[e].version);return new rP(e,t,n,r)}}class rL{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class rU{constructor(e,t){this.count=e,this.unchangedNames=t}}function rq(e){if(void 0===e)return E("GRPC error has no .code"),D.UNKNOWN;switch(e){case r.OK:return D.OK;case r.CANCELLED:return D.CANCELLED;case r.UNKNOWN:return D.UNKNOWN;case r.DEADLINE_EXCEEDED:return D.DEADLINE_EXCEEDED;case r.RESOURCE_EXHAUSTED:return D.RESOURCE_EXHAUSTED;case r.INTERNAL:return D.INTERNAL;case r.UNAVAILABLE:return D.UNAVAILABLE;case r.UNAUTHENTICATED:return D.UNAUTHENTICATED;case r.INVALID_ARGUMENT:return D.INVALID_ARGUMENT;case r.NOT_FOUND:return D.NOT_FOUND;case r.ALREADY_EXISTS:return D.ALREADY_EXISTS;case r.PERMISSION_DENIED:return D.PERMISSION_DENIED;case r.FAILED_PRECONDITION:return D.FAILED_PRECONDITION;case r.ABORTED:return D.ABORTED;case r.OUT_OF_RANGE:return D.OUT_OF_RANGE;case r.UNIMPLEMENTED:return D.UNIMPLEMENTED;case r.DATA_LOSS:return D.DATA_LOSS;default:return S(39323,{code:e})}}(i=r||(r={}))[i.OK=0]="OK",i[i.CANCELLED=1]="CANCELLED",i[i.UNKNOWN=2]="UNKNOWN",i[i.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",i[i.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",i[i.NOT_FOUND=5]="NOT_FOUND",i[i.ALREADY_EXISTS=6]="ALREADY_EXISTS",i[i.PERMISSION_DENIED=7]="PERMISSION_DENIED",i[i.UNAUTHENTICATED=16]="UNAUTHENTICATED",i[i.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",i[i.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",i[i.ABORTED=10]="ABORTED",i[i.OUT_OF_RANGE=11]="OUT_OF_RANGE",i[i.UNIMPLEMENTED=12]="UNIMPLEMENTED",i[i.INTERNAL=13]="INTERNAL",i[i.UNAVAILABLE=14]="UNAVAILABLE",i[i.DATA_LOSS=15]="DATA_LOSS";let rB=new c.jz([0xffffffff,0xffffffff],0);function rz(e){let t=(new TextEncoder).encode(e),n=new c.VV;return n.update(t),new Uint8Array(n.digest())}function rK(e){let t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),i=t.getUint32(8,!0),s=t.getUint32(12,!0);return[new c.jz([n,r],0),new c.jz([i,s],0)]}class r${constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new rG(`Invalid padding: ${t}`);if(n<0||e.length>0&&0===this.hashCount)throw new rG(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new rG(`Invalid padding when bitmap length is 0: ${t}`);this.ge=8*e.length-t,this.pe=c.jz.fromNumber(this.ge)}ye(e,t,n){let r=e.add(t.multiply(c.jz.fromNumber(n)));return 1===r.compare(rB)&&(r=new c.jz([r.getBits(0),r.getBits(1)],0)),r.modulo(this.pe).toNumber()}we(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.ge)return!1;let[t,n]=rK(rz(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);if(!this.we(r))return!1}return!0}static create(e,t,n){let r=new r$(new Uint8Array(Math.ceil(e/8)),e%8==0?0:8-e%8,t);return n.forEach(e=>r.insert(e)),r}insert(e){if(0===this.ge)return;let[t,n]=rK(rz(e));for(let e=0;e<this.hashCount;e++){let r=this.ye(t,n,e);this.Se(r)}}Se(e){let t=Math.floor(e/8);this.bitmap[t]|=1<<e%8}}class rG extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class rj{constructor(e,t,n,r,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){let r=new Map;return r.set(e,rQ.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new rj(es.min(),r,new tM(q),n7,ra())}}class rQ{constructor(e,t,n,r,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new rQ(n,t,ra(),ra(),ra())}}class rW{constructor(e,t,n,r){this.be=e,this.removedTargetIds=t,this.key=n,this.De=r}}class rH{constructor(e,t){this.targetId=e,this.Ce=t}}class rJ{constructor(e,t,n=tz.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class rY{constructor(){this.ve=0,this.Fe=r0(),this.Me=tz.EMPTY_BYTE_STRING,this.xe=!1,this.Oe=!0}get current(){return this.xe}get resumeToken(){return this.Me}get Ne(){return 0!==this.ve}get Be(){return this.Oe}Le(e){e.approximateByteSize()>0&&(this.Oe=!0,this.Me=e)}ke(){let e=ra(),t=ra(),n=ra();return this.Fe.forEach((r,i)=>{switch(i){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:S(38017,{changeType:i})}}),new rQ(this.Me,this.xe,e,t,n)}qe(){this.Oe=!1,this.Fe=r0()}Qe(e,t){this.Oe=!0,this.Fe=this.Fe.insert(e,t)}$e(e){this.Oe=!0,this.Fe=this.Fe.remove(e)}Ue(){this.ve+=1}Ke(){this.ve-=1,N(this.ve>=0,3241,{ve:this.ve})}We(){this.Oe=!0,this.xe=!0}}class rX{constructor(e){this.Ge=e,this.ze=new Map,this.je=n7,this.Je=rZ(),this.He=rZ(),this.Ye=new tM(q)}Ze(e){for(let t of e.be)e.De&&e.De.isFoundDocument()?this.Xe(t,e.De):this.et(t,e.key,e.De);for(let t of e.removedTargetIds)this.et(t,e.key,e.De)}tt(e){this.forEachTarget(e,t=>{let n=this.nt(t);switch(e.state){case 0:this.rt(t)&&n.Le(e.resumeToken);break;case 1:n.Ke(),n.Ne||n.qe(),n.Le(e.resumeToken);break;case 2:n.Ke(),n.Ne||this.removeTarget(t);break;case 3:this.rt(t)&&(n.We(),n.Le(e.resumeToken));break;case 4:this.rt(t)&&(this.it(t),n.Le(e.resumeToken));break;default:S(56790,{state:e.state})}})}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ze.forEach((e,n)=>{this.rt(n)&&t(n)})}st(e){let t=e.targetId,n=e.Ce.count,r=this.ot(t);if(r){let i=r.target;if(n$(i)){if(0===n){let e=new H(i.path);this.et(t,e,nv.newNoDocument(e,es.min()))}else N(1===n,20013,{expectedCount:n})}else{let r=this._t(t);if(r!==n){let n=this.ut(e),i=n?this.ct(n,e,r):1;0!==i&&(this.it(t),this.Ye=this.Ye.insert(t,2===i?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch"))}}}}ut(e){let t,n;let r=e.Ce.unchangedNames;if(!r||!r.bits)return null;let{bits:{bitmap:i="",padding:s=0},hashCount:a=0}=r;try{t=tj(i).toUint8Array()}catch(e){if(e instanceof tB)return b("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{n=new r$(t,s,a)}catch(e){return b(e instanceof rG?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===n.ge?null:n}ct(e,t,n){return t.Ce.count===n-this.Pt(e,t.targetId)?0:2}Pt(e,t){let n=this.Ge.getRemoteKeysForTarget(t),r=0;return n.forEach(n=>{let i=this.Ge.ht(),s=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;e.mightContain(s)||(this.et(t,n,null),r++)}),r}Tt(e){let t=new Map;this.ze.forEach((n,r)=>{let i=this.ot(r);if(i){if(n.current&&n$(i.target)){let t=new H(i.target.path);this.It(t).has(r)||this.Et(r,t)||this.et(r,t,nv.newNoDocument(t,e))}n.Be&&(t.set(r,n.ke()),n.qe())}});let n=ra();this.He.forEach((e,t)=>{let r=!0;t.forEachWhile(e=>{let t=this.ot(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)}),r&&(n=n.add(e))}),this.je.forEach((t,n)=>n.setReadTime(e));let r=new rj(e,t,this.Ye,this.je,n);return this.je=n7,this.Je=rZ(),this.He=rZ(),this.Ye=new tM(q),r}Xe(e,t){if(!this.rt(e))return;let n=this.Et(e,t.key)?2:0;this.nt(e).Qe(t.key,n),this.je=this.je.insert(t.key,t),this.Je=this.Je.insert(t.key,this.It(t.key).add(e)),this.He=this.He.insert(t.key,this.dt(t.key).add(e))}et(e,t,n){if(!this.rt(e))return;let r=this.nt(e);this.Et(e,t)?r.Qe(t,1):r.$e(t),this.He=this.He.insert(t,this.dt(t).delete(e)),this.He=this.He.insert(t,this.dt(t).add(e)),n&&(this.je=this.je.insert(t,n))}removeTarget(e){this.ze.delete(e)}_t(e){let t=this.nt(e).ke();return this.Ge.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Ue(e){this.nt(e).Ue()}nt(e){let t=this.ze.get(e);return t||(t=new rY,this.ze.set(e,t)),t}dt(e){let t=this.He.get(e);return t||(t=new tP(q),this.He=this.He.insert(e,t)),t}It(e){let t=this.Je.get(e);return t||(t=new tP(q),this.Je=this.Je.insert(e,t)),t}rt(e){let t=null!==this.ot(e);return t||T("WatchChangeAggregator","Detected inactive target",e),t}ot(e){let t=this.ze.get(e);return t&&t.Ne?null:this.Ge.At(e)}it(e){this.ze.set(e,new rY),this.Ge.getRemoteKeysForTarget(e).forEach(t=>{this.et(e,t,null)})}Et(e,t){return this.Ge.getRemoteKeysForTarget(e).has(t)}}function rZ(){return new tM(H.comparator)}function r0(){return new tM(H.comparator)}let r1={asc:"ASCENDING",desc:"DESCENDING"},r2={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},r4={and:"AND",or:"OR"};class r5{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function r6(e,t){return e.useProto3Json||null==t?t:{value:t}}function r3(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function r8(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function r9(e){return N(!!e,49232),es.fromTimestamp(function(e){let t=t$(e);return new ei(t.seconds,t.nanos)}(e))}function r7(e,t){return ie(e,t).canonicalString()}function ie(e,t){let n=new j(["projects",e.projectId,"databases",e.database]).child("documents");return void 0===t?n:n.child(t)}function it(e){let t=j.fromString(e);return N(iv(t),10190,{key:t.toString()}),t}function ir(e,t){return r7(e.databaseId,t.path)}function ii(e,t){let n=it(t);if(n.get(1)!==e.databaseId.projectId)throw new C(D.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new C(D.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new H(il(n))}function is(e,t){return r7(e.databaseId,t)}function ia(e){let t=it(e);return 4===t.length?j.emptyPath():il(t)}function io(e){return new j(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function il(e){return N(e.length>4&&"documents"===e.get(4),29091,{key:e.toString()}),e.popFirst(5)}function iu(e,t,n){return{name:ir(e,t),fields:n.value.mapValue.fields}}function ih(e,t,n){let r=ii(e,t.name),i=r9(t.updateTime),s=t.createTime?r9(t.createTime):es.min(),a=new nw({mapValue:{fields:t.fields}}),o=nv.newFoundDocument(r,i,s,a);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function ic(e,t){var n;let r;if(t instanceof rC)r={update:iu(e,t.key,t.value)};else if(t instanceof rM)r={delete:ir(e,t.key)};else if(t instanceof rA)r={update:iu(e,t.key,t.data),updateMask:function(e){let t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof rO))return S(16599,{Vt:t.type});r={verify:ir(e,t.key)}}return t.fieldTransforms.length>0&&(r.updateTransforms=t.fieldTransforms.map(e=>(function(e,t){let n=t.transform;if(n instanceof rf)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rm)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof rp)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof rw)return{fieldPath:t.field.canonicalString(),increment:n.Ae};throw S(20930,{transform:t.transform})})(0,e))),t.precondition.isNone||(r.currentDocument=void 0!==(n=t.precondition).updateTime?{updateTime:r3(e,n.updateTime.toTimestamp())}:void 0!==n.exists?{exists:n.exists}:S(27497)),r}function id(e,t){var n;let r=t.currentDocument?void 0!==(n=t.currentDocument).updateTime?rb.updateTime(r9(n.updateTime)):void 0!==n.exists?rb.exists(n.exists):rb.none():rb.none(),i=t.updateTransforms?t.updateTransforms.map(t=>{let n;return n=null,"setToServerValue"in t?(N("REQUEST_TIME"===t.setToServerValue,16630,{proto:t}),n=new rf):"appendMissingElements"in t?n=new rm(t.appendMissingElements.values||[]):"removeAllFromArray"in t?n=new rp(t.removeAllFromArray.values||[]):"increment"in t?n=new rw(e,t.increment):S(16584,{proto:t}),new rT(W.fromServerFormat(t.fieldPath),n)}):[];if(t.update){t.update.name;let n=ii(e,t.update.name),s=new nw({mapValue:{fields:t.update.fields}});return t.updateMask?new rA(n,s,new tq((t.updateMask.fieldPaths||[]).map(e=>W.fromServerFormat(e))),r,i):new rC(n,s,r,i)}return t.delete?new rM(ii(e,t.delete),r):t.verify?new rO(ii(e,t.verify),r):S(1463,{proto:t})}function im(e,t){return{documents:[is(e,t.path)]}}function ig(e,t){var n,r;let i;let s={structuredQuery:{}},a=t.path;null!==t.collectionGroup?(i=a,s.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(i=a.popLast(),s.structuredQuery.from=[{collectionId:a.lastSegment()}]),s.parent=is(e,i);let o=function(e){if(0!==e.length)return function e(t){return t instanceof nS?function(e){if("=="===e.op){if(nh(e.value))return{unaryFilter:{field:iy(e.field),op:"IS_NAN"}};if(nu(e.value))return{unaryFilter:{field:iy(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(nh(e.value))return{unaryFilter:{field:iy(e.field),op:"IS_NOT_NAN"}};if(nu(e.value))return{unaryFilter:{field:iy(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:iy(e.field),op:r2[e.op],value:e.value}}}(t):t instanceof nx?function(t){let n=t.getFilters().map(t=>e(t));return 1===n.length?n[0]:{compositeFilter:{op:r4[t.op],filters:n}}}(t):S(54877,{filter:t})}(nx.create(e,"and"))}(t.filters);o&&(s.structuredQuery.where=o);let l=function(e){if(0!==e.length)return e.map(e=>({field:iy(e.field),direction:r1[e.dir]}))}(t.orderBy);l&&(s.structuredQuery.orderBy=l);let u=r6(e,t.limit);return null!==u&&(s.structuredQuery.limit=u),t.startAt&&(s.structuredQuery.startAt={before:(n=t.startAt).inclusive,values:n.position}),t.endAt&&(s.structuredQuery.endAt={before:!(r=t.endAt).inclusive,values:r.position}),{ft:s,parent:i}}function ip(e){var t;let n,r=ia(e.parent),i=e.structuredQuery,s=i.from?i.from.length:0,a=null;if(s>0){N(1===s,65062);let e=i.from[0];e.allDescendants?a=e.collectionId:r=r.child(e.collectionId)}let o=[];i.where&&(o=function(e){let t=function e(t){return void 0!==t.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":let t=iw(e.unaryFilter.field);return nS.create(t,"==",{doubleValue:NaN});case"IS_NULL":let n=iw(e.unaryFilter.field);return nS.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":let r=iw(e.unaryFilter.field);return nS.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":let i=iw(e.unaryFilter.field);return nS.create(i,"!=",{nullValue:"NULL_VALUE"});case"OPERATOR_UNSPECIFIED":return S(61313);default:return S(60726)}}(t):void 0!==t.fieldFilter?nS.create(iw(t.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";case"OPERATOR_UNSPECIFIED":return S(58110);default:return S(50506)}}(t.fieldFilter.op),t.fieldFilter.value):void 0!==t.compositeFilter?nx.create(t.compositeFilter.filters.map(t=>e(t)),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return S(1026)}}(t.compositeFilter.op)):S(30097,{filter:t})}(e);return t instanceof nx&&nC(t)?t.getFilters():[t]}(i.where));let l=[];i.orderBy&&(l=i.orderBy.map(e=>new nb(iw(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))));let u=null;i.limit&&(u=null==(n="object"==typeof(t=i.limit)?t.value:t)?null:n);let h=null;i.startAt&&(h=function(e){let t=!!e.before;return new nI(e.values||[],t)}(i.startAt));let c=null;return i.endAt&&(c=function(e){let t=!e.before;return new nI(e.values||[],t)}(i.endAt)),new nW(r,a,l,o,u,"F",h,c)}function iy(e){return{fieldPath:e.canonicalString()}}function iw(e){return W.fromServerFormat(e.fieldPath)}function iv(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class iI{constructor(e,t,n,r,i=es.min(),s=es.min(),a=tz.EMPTY_BYTE_STRING,o=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=s,this.resumeToken=a,this.expectedCount=o}withSequenceNumber(e){return new iI(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new iI(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new iI(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new iI(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class iT{constructor(e){this.yt=e}}function iE(e,t){let n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:ib(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument()){var i;r.document={name:ir(i=e.yt,t.key),fields:t.data.value.mapValue.fields,updateTime:r3(i,t.version.toTimestamp()),createTime:r3(i,t.createTime.toTimestamp())}}else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:i_(t.version)};else{if(!t.isUnknownDocument())return S(57904,{document:t});r.unknownDocument={path:n.path.toArray(),version:i_(t.version)}}return r}function ib(e){let t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function i_(e){let t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function iS(e){let t=new ei(e.seconds,e.nanoseconds);return es.fromTimestamp(t)}function ix(e,t){let n=(t.baseMutations||[]).map(t=>id(e.yt,t));for(let e=0;e<t.mutations.length-1;++e){let n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){let r=t.mutations[e+1];n.updateTransforms=r.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}let r=t.mutations.map(t=>id(e.yt,t)),i=ei.fromMillis(t.localWriteTimeMs);return new rF(t.batchId,i,n,r)}function iN(e){let t=iS(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?iS(e.lastLimboFreeSnapshotVersion):es.min();return new iI(void 0!==e.query.documents?function(e){let t=e.documents.length;return N(1===t,1966,{count:t}),nZ(nH(ia(e.documents[0])))}(e.query):nZ(ip(e.query)),e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,tz.fromBase64String(e.resumeToken))}function iD(e,t){let n;let r=i_(t.snapshotVersion),i=i_(t.lastLimboFreeSnapshotVersion);n=n$(t.target)?im(e.yt,t.target):ig(e.yt,t.target).ft;let s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:nz(t.target),readTime:r,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:i,query:n}}function iC(e){let t=ip({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?n1(t,t.limit,"L"):t}function iA(e,t){return new rL(t.largestBatchId,id(e.yt,t.overlayMutation))}function ik(e,t){let n=t.path.lastSegment();return[e,eP(t.path.popLast()),n]}function iV(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:i_(r.readTime),documentKey:eP(r.documentKey.path),largestBatchId:r.largestBatchId}}class iR{getBundleMetadata(e,t){return tA(e,ts).get(t).next(e=>{if(e)return{id:e.bundleId,createTime:iS(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return tA(e,ts).put({bundleId:t.id,createTime:i_(r9(t.createTime)),version:t.version})}getNamedQuery(e,t){return tA(e,ta).get(t).next(e=>{if(e)return{name:e.name,query:iC(e.bundledQuery),readTime:iS(e.readTime)}})}saveNamedQuery(e,t){return tA(e,ta).put({name:t.name,readTime:i_(r9(t.readTime)),bundledQuery:t.bundledQuery})}}class iM{constructor(e,t){this.serializer=e,this.userId=t}static wt(e,t){return new iM(e,t.uid||"")}getOverlay(e,t){return tA(e,ty).get(ik(this.userId,t)).next(e=>e?iA(this.serializer,e):null)}getOverlays(e,t){let n=rr();return ew.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){let r=[];return n.forEach((n,i)=>{let s=new rL(t,i);r.push(this.St(e,s))}),ew.waitFor(r)}removeOverlaysForBatchId(e,t,n){let r=new Set;t.forEach(e=>r.add(eP(e.getCollectionPath())));let i=[];return r.forEach(t=>{let r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(tA(e,ty).Z(tv,r))}),ew.waitFor(i)}getOverlaysForCollection(e,t,n){let r=rr(),i=eP(t),s=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return tA(e,ty).J(tv,s).next(e=>{for(let t of e){let e=iA(this.serializer,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,r){let i;let s=rr(),a=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return tA(e,ty).ee({index:tT,range:a},(e,t,n)=>{let a=iA(this.serializer,t);s.size()<r||a.largestBatchId===i?(s.set(a.getKey(),a),i=a.largestBatchId):n.done()}).next(()=>s)}St(e,t){return tA(e,ty).put(function(e,t,n){let[r,i,s]=ik(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:ic(e.yt,n.mutation)}}(this.serializer,this.userId,t))}}class iO{bt(e){return tA(e,tb)}getSessionToken(e){return this.bt(e).get("sessionToken").next(e=>{let t=e?.value;return t?tz.fromUint8Array(t):tz.EMPTY_BYTE_STRING})}setSessionToken(e,t){return this.bt(e).put({name:"sessionToken",value:t.toUint8Array()})}}class iF{constructor(){}Dt(e,t){this.Ct(e,t),t.vt()}Ct(e,t){if("nullValue"in e)this.Ft(t,5);else if("booleanValue"in e)this.Ft(t,10),t.Mt(e.booleanValue?1:0);else if("integerValue"in e)this.Ft(t,15),t.Mt(tG(e.integerValue));else if("doubleValue"in e){let n=tG(e.doubleValue);isNaN(n)?this.Ft(t,13):(this.Ft(t,15),eO(n)?t.Mt(0):t.Mt(n))}else if("timestampValue"in e){let n=e.timestampValue;this.Ft(t,20),"string"==typeof n&&(n=t$(n)),t.xt(`${n.seconds||""}`),t.Mt(n.nanos||0)}else if("stringValue"in e)this.Ot(e.stringValue,t),this.Nt(t);else if("bytesValue"in e)this.Ft(t,30),t.Bt(tj(e.bytesValue)),this.Nt(t);else if("referenceValue"in e)this.Lt(e.referenceValue,t);else if("geoPointValue"in e){let n=e.geoPointValue;this.Ft(t,45),t.Mt(n.latitude||0),t.Mt(n.longitude||0)}else"mapValue"in e?nm(e)?this.Ft(t,Number.MAX_SAFE_INTEGER):nd(e)?this.kt(e.mapValue,t):(this.qt(e.mapValue,t),this.Nt(t)):"arrayValue"in e?(this.Qt(e.arrayValue,t),this.Nt(t)):S(19022,{$t:e})}Ot(e,t){this.Ft(t,25),this.Ut(e,t)}Ut(e,t){t.xt(e)}qt(e,t){let n=e.fields||{};for(let e of(this.Ft(t,55),Object.keys(n)))this.Ot(e,t),this.Ct(n[e],t)}kt(e,t){let n=e.fields||{};this.Ft(t,53);let r=n[t8].arrayValue?.values?.length||0;this.Ft(t,15),t.Mt(tG(r)),this.Ot(t8,t),this.Ct(n[t8],t)}Qt(e,t){let n=e.values||[];for(let e of(this.Ft(t,50),n))this.Ct(e,t)}Lt(e,t){this.Ft(t,37),H.fromName(e).path.forEach(e=>{this.Ft(t,60),this.Ut(e,t)})}Ft(e,t){e.Mt(t)}Nt(e){e.Mt(2)}}function iP(e){return Math.ceil((64-function(e){let t=0;for(let n=0;n<8;++n){let r=function(e){if(0===e)return 8;let t=0;return e>>4||(t+=4,e<<=4),e>>6||(t+=2,e<<=2),e>>7||(t+=1),t}(255&e[n]);if(t+=r,8!==r)break}return t}(e))/8)}iF.Kt=new iF;class iL{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Wt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Gt(n.value),n=t.next();this.zt()}jt(e){let t=e[Symbol.iterator](),n=t.next();for(;!n.done;)this.Jt(n.value),n=t.next();this.Ht()}Yt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Gt(e);else if(e<2048)this.Gt(960|e>>>6),this.Gt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Gt(480|e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e);else{let e=t.codePointAt(0);this.Gt(240|e>>>18),this.Gt(128|63&e>>>12),this.Gt(128|63&e>>>6),this.Gt(128|63&e)}}this.zt()}Zt(e){for(let t of e){let e=t.charCodeAt(0);if(e<128)this.Jt(e);else if(e<2048)this.Jt(960|e>>>6),this.Jt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Jt(480|e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e);else{let e=t.codePointAt(0);this.Jt(240|e>>>18),this.Jt(128|63&e>>>12),this.Jt(128|63&e>>>6),this.Jt(128|63&e)}}this.Ht()}Xt(e){let t=this.en(e),n=iP(t);this.tn(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}nn(e){let t=this.en(e),n=iP(t);this.tn(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}rn(){this.sn(255),this.sn(255)}_n(){this.an(255),this.an(255)}reset(){this.position=0}seed(e){this.tn(e.length),this.buffer.set(e,this.position),this.position+=e.length}un(){return this.buffer.slice(0,this.position)}en(e){let t=function(e){let t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Gt(e){let t=255&e;0===t?(this.sn(0),this.sn(255)):255===t?(this.sn(255),this.sn(0)):this.sn(t)}Jt(e){let t=255&e;0===t?(this.an(0),this.an(255)):255===t?(this.an(255),this.an(0)):this.an(e)}zt(){this.sn(0),this.sn(1)}Ht(){this.an(0),this.an(1)}sn(e){this.tn(1),this.buffer[this.position++]=e}an(e){this.tn(1),this.buffer[this.position++]=~e}tn(e){let t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);let r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class iU{constructor(e){this.cn=e}Bt(e){this.cn.Wt(e)}xt(e){this.cn.Yt(e)}Mt(e){this.cn.Xt(e)}vt(){this.cn.rn()}}class iq{constructor(e){this.cn=e}Bt(e){this.cn.jt(e)}xt(e){this.cn.Zt(e)}Mt(e){this.cn.nn(e)}vt(){this.cn._n()}}class iB{constructor(){this.cn=new iL,this.ln=new iU(this.cn),this.hn=new iq(this.cn)}seed(e){this.cn.seed(e)}Pn(e){return 0===e?this.ln:this.hn}un(){return this.cn.un()}reset(){this.cn.reset()}}class iz{constructor(e,t,n,r){this.Tn=e,this.In=t,this.En=n,this.dn=r}An(){let e=this.dn.length,t=0===e||255===this.dn[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.dn,0),t!==e?n.set([0],this.dn.length):++n[n.length-1],new iz(this.Tn,this.In,this.En,n)}Rn(e,t,n){return{indexId:this.Tn,uid:e,arrayValue:iG(this.En),directionalValue:iG(this.dn),orderedDocumentKey:iG(t),documentKey:n.path.toArray()}}Vn(e,t,n){let r=this.Rn(e,t,n);return[r.indexId,r.uid,r.arrayValue,r.directionalValue,r.orderedDocumentKey,r.documentKey]}}function iK(e,t){let n=e.Tn-t.Tn;return 0!==n?n:0!==(n=i$(e.En,t.En))?n:0!==(n=i$(e.dn,t.dn))?n:H.comparator(e.In,t.In)}function i$(e,t){for(let n=0;n<e.length&&n<t.length;++n){let r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}function iG(e){return(0,h.Ov)()?function(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return t}(e):e}function ij(e){return"string"!=typeof e?e:function(e){let t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(e)}class iQ{constructor(e){for(let t of(this.mn=new tP((e,t)=>W.comparator(e.field,t.field)),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.fn=e.orderBy,this.gn=[],e.filters))t.isInequality()?this.mn=this.mn.add(t):this.gn.push(t)}get pn(){return this.mn.size>1}yn(e){if(N(e.collectionGroup===this.collectionId,49279),this.pn)return!1;let t=eo(e);if(void 0!==t&&!this.wn(t))return!1;let n=el(e),r=new Set,i=0,s=0;for(;i<n.length&&this.wn(n[i]);++i)r=r.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(this.mn.size>0){let e=this.mn.getIterator().getNext();if(!r.has(e.field.canonicalString())){let t=n[i];if(!this.Sn(e,t)||!this.bn(this.fn[s++],t))return!1}++i}for(;i<n.length;++i){let e=n[i];if(s>=this.fn.length||!this.bn(this.fn[s++],e))return!1}return!0}Dn(){if(this.pn)return null;let e=new tP(W.comparator),t=[];for(let n of this.gn)if(!n.field.isKeyField()){if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new eu(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new eu(n.field,0))}}for(let n of this.fn)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new eu(n.field,"asc"===n.dir?0:1)));return new ea(ea.UNKNOWN_ID,this.collectionId,t,eh.empty())}wn(e){for(let t of this.gn)if(this.Sn(t,e))return!0;return!1}Sn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;let n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}bn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function iW(e){return e instanceof nS}function iH(e){return e instanceof nx&&nC(e)}function iJ(e){return iW(e)||iH(e)||function(e){if(e instanceof nx&&nD(e)){for(let t of e.getFilters())if(!iW(t)&&!iH(t))return!1;return!0}return!1}(e)}function iY(e,t){return N(e instanceof nS||e instanceof nx,38388),N(t instanceof nS||t instanceof nx,25473),iZ(e instanceof nS?t instanceof nS?nx.create([e,t],"and"):iX(e,t):t instanceof nS?iX(t,e):function(e,t){if(N(e.filters.length>0&&t.filters.length>0,48005),nN(e)&&nN(t))return nk(e,t.getFilters());let n=nD(e)?e:t,r=nD(e)?t:e,i=n.filters.map(e=>iY(e,r));return nx.create(i,"or")}(e,t))}function iX(e,t){if(nN(t))return nk(t,e.getFilters());{let n=t.filters.map(t=>iY(e,t));return nx.create(n,"or")}}function iZ(e){if(N(e instanceof nS||e instanceof nx,11850),e instanceof nS)return e;let t=e.getFilters();if(1===t.length)return iZ(t[0]);if(nA(e))return e;let n=t.map(e=>iZ(e)),r=[];return n.forEach(t=>{t instanceof nS?r.push(t):t instanceof nx&&(t.op===e.op?r.push(...t.filters):r.push(t))}),1===r.length?r[0]:nx.create(r,e.op)}class i0{constructor(){this.Cn=new i1}addToCollectionParentIndex(e,t){return this.Cn.add(t),ew.resolve()}getCollectionParents(e,t){return ew.resolve(this.Cn.getEntries(t))}addFieldIndex(e,t){return ew.resolve()}deleteFieldIndex(e,t){return ew.resolve()}deleteAllFieldIndexes(e){return ew.resolve()}createTargetIndexes(e,t){return ew.resolve()}getDocumentsMatchingTarget(e,t){return ew.resolve(null)}getIndexType(e,t){return ew.resolve(0)}getFieldIndexes(e,t){return ew.resolve([])}getNextCollectionGroupToUpdate(e){return ew.resolve(null)}getMinOffset(e,t){return ew.resolve(ef.min())}getMinOffsetFromCollectionGroup(e,t){return ew.resolve(ef.min())}updateCollectionGroup(e,t,n){return ew.resolve()}updateIndexEntries(e,t){return ew.resolve()}}class i1{constructor(){this.index={}}add(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new tP(j.comparator),i=!r.has(n);return this.index[t]=r.add(n),i}has(e){let t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new tP(j.comparator)).toArray()}}let i2="IndexedDbIndexManager",i4=new Uint8Array(0);class i5{constructor(e,t){this.databaseId=t,this.vn=new i1,this.Fn=new n9(e=>nz(e),(e,t)=>nK(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.vn.has(t)){let n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener(()=>{this.vn.add(t)});let i={collectionId:n,parent:eP(r)};return tA(e,tn).put(i)}return ew.resolve()}getCollectionParents(e,t){let n=[],r=IDBKeyRange.bound([t,""],[t+"\0",""],!1,!0);return tA(e,tn).J(r).next(e=>{for(let r of e){if(r.collectionId!==t)break;n.push(eL(r.parent))}return n})}addFieldIndex(e,t){let n=tA(e,to),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])};delete r.indexId;let i=n.add(r);if(t.indexState){let n=tA(e,tu);return i.next(e=>{n.put(iV(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))})}return i.next()}deleteFieldIndex(e,t){let n=tA(e,to),r=tA(e,tu),i=tA(e,tf);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}deleteAllFieldIndexes(e){let t=tA(e,to),n=tA(e,tf),r=tA(e,tu);return t.Z().next(()=>n.Z()).next(()=>r.Z())}createTargetIndexes(e,t){return ew.forEach(this.Mn(t),t=>this.getIndexType(e,t).next(n=>{if(0===n||1===n){let n=new iQ(t).Dn();if(null!=n)return this.addFieldIndex(e,n)}}))}getDocumentsMatchingTarget(e,t){let n=tA(e,tf),r=!0,i=new Map;return ew.forEach(this.Mn(t),t=>this.xn(e,t).next(e=>{r&&(r=!!e),i.set(t,e)})).next(()=>{if(r){let e=ra(),r=[];return ew.forEach(i,(i,s)=>{T(i2,`Using index id=${i.indexId}|cg=${i.collectionGroup}|f=${i.fields.map(e=>`${e.fieldPath}:${e.kind}`).join(",")} to execute ${nz(t)}`);let a=function(e,t){let n=eo(t);if(void 0===n)return null;for(let t of nG(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(s,i),o=function(e,t){let n=new Map;for(let r of el(t))for(let t of nG(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(s,i),l=function(e,t){let n=[],r=!0;for(let i of el(t)){let t=0===i.kind?nj(e,i.fieldPath,e.startAt):nQ(e,i.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new nI(n,r)}(s,i),u=function(e,t){let n=[],r=!0;for(let i of el(t)){let t=0===i.kind?nQ(e,i.fieldPath,e.endAt):nj(e,i.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new nI(n,r)}(s,i),h=this.On(i,s,l),c=this.On(i,s,u),d=this.Nn(i,s,o),f=this.Bn(i.indexId,a,h,l.inclusive,c,u.inclusive,d);return ew.forEach(f,i=>n.Y(i,t.limit).next(t=>{t.forEach(t=>{let n=H.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))})}))}).next(()=>r)}return ew.resolve(null)})}Mn(e){let t=this.Fn.get(e);return t||(t=0===e.filters.length?[e]:(function(e){if(0===e.getFilters().length)return[];let t=function e(t){if(N(t instanceof nS||t instanceof nx,34018),t instanceof nS)return t;if(1===t.filters.length)return e(t.filters[0]);let n=t.filters.map(t=>e(t)),r=nx.create(n,t.op);return iJ(r=iZ(r))?r:(N(r instanceof nx,64498),N(nN(r),40251),N(r.filters.length>1,57927),r.filters.reduce((e,t)=>iY(e,t)))}(function e(t){if(N(t instanceof nS||t instanceof nx,20012),t instanceof nS){if(t instanceof nP){let e=t.value.arrayValue?.values?.map(e=>nS.create(t.field,"==",e))||[];return nx.create(e,"or")}return t}let n=t.filters.map(t=>e(t));return nx.create(n,t.op)}(e));return N(iJ(t),7391),iW(t)||iH(t)?[t]:t.getFilters()})(nx.create(e.filters,"and")).map(t=>nB(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt)),this.Fn.set(e,t)),t}Bn(e,t,n,r,i,s,a){let o=(null!=t?t.length:1)*Math.max(n.length,i.length),l=o/(null!=t?t.length:1),u=[];for(let h=0;h<o;++h){let o=t?this.Ln(t[h/l]):i4,c=this.kn(e,o,n[h%l],r),d=this.qn(e,o,i[h%l],s),f=a.map(t=>this.kn(e,o,t,!0));u.push(...this.createRange(c,d,f))}return u}kn(e,t,n,r){let i=new iz(e,H.empty(),t,n);return r?i:i.An()}qn(e,t,n,r){let i=new iz(e,H.empty(),t,n);return r?i.An():i}xn(e,t){let n=new iQ(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next(e=>{let t=null;for(let r of e)n.yn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t})}getIndexType(e,t){let n=2,r=this.Mn(t);return ew.forEach(r,t=>this.xn(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new tP(W.comparator),n=!1;for(let r of e.filters)for(let e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(let n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>null!==t.limit&&r.length>1&&2===n?1:n)}Qn(e,t){let n=new iB;for(let r of el(e)){let e=t.data.field(r.fieldPath);if(null==e)return null;let i=n.Pn(r.kind);iF.Kt.Dt(e,i)}return n.un()}Ln(e){let t=new iB;return iF.Kt.Dt(e,t.Pn(0)),t.un()}$n(e,t){let n=new iB;return iF.Kt.Dt(na(this.databaseId,t),n.Pn(function(e){let t=el(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.un()}Nn(e,t,n){if(null===n)return[];let r=[];r.push(new iB);let i=0;for(let s of el(e)){let e=n[i++];for(let n of r)if(this.Un(t,s.fieldPath)&&nl(e))r=this.Kn(r,s,e);else{let t=n.Pn(s.kind);iF.Kt.Dt(e,t)}}return this.Wn(r)}On(e,t,n){return this.Nn(e,t,n.position)}Wn(e){let t=[];for(let n=0;n<e.length;++n)t[n]=e[n].un();return t}Kn(e,t,n){let r=[...e],i=[];for(let e of n.arrayValue.values||[])for(let n of r){let r=new iB;r.seed(n.un()),iF.Kt.Dt(e,r.Pn(t.kind)),i.push(r)}return i}Un(e,t){return!!e.filters.find(e=>e instanceof nS&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){let n=tA(e,to),r=tA(e,tu);return(t?n.J(tl,IDBKeyRange.bound(t,t)):n.J()).next(e=>{let t=[];return ew.forEach(e,e=>r.get([e.indexId,this.uid]).next(n=>{t.push(function(e,t){let n=t?new eh(t.sequenceNumber,new ef(iS(t.readTime),new H(eL(t.documentKey)),t.largestBatchId)):eh.empty(),r=e.fields.map(([e,t])=>new eu(W.fromServerFormat(e),t));return new ea(e.indexId,e.collectionGroup,r,n)}(e,n))})).next(()=>t)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{let n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:q(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,t,n){let r=tA(e,to),i=tA(e,tu);return this.Gn(e).next(e=>r.J(tl,IDBKeyRange.bound(t,t)).next(t=>ew.forEach(t,t=>i.put(iV(t.indexId,this.uid,e,n)))))}updateIndexEntries(e,t){let n=new Map;return ew.forEach(t,(t,r)=>{let i=n.get(t.collectionGroup);return(i?ew.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next(i=>(n.set(t.collectionGroup,i),ew.forEach(i,n=>this.zn(e,t,n).next(t=>{let i=this.jn(r,n);return t.isEqual(i)?ew.resolve():this.Jn(e,r,n,t,i)}))))})}Hn(e,t,n,r){return tA(e,tf).put(r.Rn(this.uid,this.$n(n,t.key),t.key))}Yn(e,t,n,r){return tA(e,tf).delete(r.Vn(this.uid,this.$n(n,t.key),t.key))}zn(e,t,n){let r=tA(e,tf),i=new tP(iK);return r.ee({index:tg,range:IDBKeyRange.only([n.indexId,this.uid,iG(this.$n(n,t))])},(e,r)=>{i=i.add(new iz(n.indexId,t,ij(r.arrayValue),ij(r.directionalValue)))}).next(()=>i)}jn(e,t){let n=new tP(iK),r=this.Qn(t,e);if(null==r)return n;let i=eo(t);if(null!=i){let s=e.data.field(i.fieldPath);if(nl(s))for(let i of s.arrayValue.values||[])n=n.add(new iz(t.indexId,e.key,this.Ln(i),r))}else n=n.add(new iz(t.indexId,e.key,i4,r));return n}Jn(e,t,n,r,i){T(i2,"Updating index entries for document '%s'",t.key);let s=[];return function(e,t,n,r,i){let s=e.getIterator(),a=t.getIterator(),o=tU(s),l=tU(a);for(;o||l;){let e=!1,t=!1;if(o&&l){let r=n(o,l);r<0?t=!0:r>0&&(e=!0)}else null!=o?t=!0:e=!0;e?(r(l),l=tU(a)):t?(i(o),o=tU(s)):(o=tU(s),l=tU(a))}}(r,i,iK,r=>{s.push(this.Hn(e,t,n,r))},r=>{s.push(this.Yn(e,t,n,r))}),ew.waitFor(s)}Gn(e){let t=1;return tA(e,tu).ee({index:tc,reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,n,r)=>{r.done(),t=n.sequenceNumber+1}).next(()=>t)}createRange(e,t,n){n=n.sort((e,t)=>iK(e,t)).filter((e,t,n)=>!t||0!==iK(e,n[t-1]));let r=[];for(let i of(r.push(e),n)){let n=iK(i,e),s=iK(i,t);if(0===n)r[0]=e.An();else if(n>0&&s<0)r.push(i),r.push(i.An());else if(s>0)break}r.push(t);let i=[];for(let e=0;e<r.length;e+=2){if(this.Zn(r[e],r[e+1]))return[];let t=r[e].Vn(this.uid,i4,H.empty()),n=r[e+1].Vn(this.uid,i4,H.empty());i.push(IDBKeyRange.bound(t,n))}return i}Zn(e,t){return iK(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(i6)}getMinOffset(e,t){return ew.mapArray(this.Mn(t),t=>this.xn(e,t).next(e=>e||S(44426))).next(i6)}}function i6(e){N(0!==e.length,28825);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){let i=e[r].indexState.offset;0>em(i,t)&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new ef(t.readTime,t.documentKey,n)}let i3={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class i8{static withCacheSize(e){return new i8(e,i8.DEFAULT_COLLECTION_PERCENTILE,i8.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}}function i9(e,t,n){let r=e.store(eK),i=e.store(eW),s=[],a=IDBKeyRange.only(n.batchId),o=0,l=r.ee({range:a},(e,t,n)=>(o++,n.delete()));s.push(l.next(()=>{N(1===o,47070,{batchId:n.batchId})}));let u=[];for(let e of n.mutations){var h,c;let r=(h=e.key.path,c=n.batchId,[t,eP(h),c]);s.push(i.delete(r)),u.push(e.key)}return ew.waitFor(s).next(()=>u)}function i7(e){let t;if(!e)return 0;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw S(14731);t=e.noDocument}return JSON.stringify(t).length}i8.DEFAULT_COLLECTION_PERCENTILE=10,i8.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,i8.DEFAULT=new i8(0x2800000,i8.DEFAULT_COLLECTION_PERCENTILE,i8.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),i8.DISABLED=new i8(-1,0,0);class se{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Xn={}}static wt(e,t,n,r){return N(""!==e.uid,64387),new se(e.isAuthenticated()?e.uid:"",t,n,r)}checkEmpty(e){let t=!0,n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return sn(e).ee({index:eG,range:n},(e,n,r)=>{t=!1,r.done()}).next(()=>t)}addMutationBatch(e,t,n,r){let i=tA(e,eW),s=sn(e);return s.add({}).next(a=>{N("number"==typeof a,49019);let o=new rF(a,t,n,r),l=function(e,t,n){let r=n.baseMutations.map(t=>ic(e.yt,t)),i=n.mutations.map(t=>ic(e.yt,t));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:i}}(this.serializer,this.userId,o),u=[],h=new tP((e,t)=>q(e.canonicalString(),t.canonicalString()));for(let e of r){let t=[this.userId,eP(e.key.path),a];h=h.add(e.key.path.popLast()),u.push(s.put(l)),u.push(i.put(t,eQ))}return h.forEach(t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))}),e.addOnCommittedListener(()=>{this.Xn[a]=o.keys()}),ew.waitFor(u).next(()=>o)})}lookupMutationBatch(e,t){return sn(e).get(t).next(e=>e?(N(e.userId===this.userId,48,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),ix(this.serializer,e)):null)}er(e,t){return this.Xn[t]?ew.resolve(this.Xn[t]):this.lookupMutationBatch(e,t).next(e=>{if(e){let n=e.keys();return this.Xn[t]=n,n}return null})}getNextMutationBatchAfterBatchId(e,t){let n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]),i=null;return sn(e).ee({index:eG,range:r},(e,t,r)=>{t.userId===this.userId&&(N(t.batchId>=n,47524,{tr:n}),i=ix(this.serializer,t)),r.done()}).next(()=>i)}getHighestUnacknowledgedBatchId(e){let t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]),n=-1;return sn(e).ee({index:eG,range:t,reverse:!0},(e,t,r)=>{n=t.batchId,r.done()}).next(()=>n)}getAllMutationBatches(e){let t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return sn(e).J(eG,t).next(e=>e.map(e=>ix(this.serializer,e)))}getAllMutationBatchesAffectingDocumentKey(e,t){let n=[this.userId,eP(t.path)],r=IDBKeyRange.lowerBound(n),i=[];return tA(e,eW).ee({range:r},(n,r,s)=>{let[a,o,l]=n,u=eL(o);if(a===this.userId&&t.path.isEqual(u))return sn(e).get(l).next(e=>{if(!e)throw S(61480,{nr:n,batchId:l});N(e.userId===this.userId,10503,"Unexpected user for mutation batch",{userId:e.userId,batchId:l}),i.push(ix(this.serializer,e))});s.done()}).next(()=>i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tP(q),r=[];return t.forEach(t=>{let i=[this.userId,eP(t.path)],s=IDBKeyRange.lowerBound(i),a=tA(e,eW).ee({range:s},(e,r,i)=>{let[s,a,o]=e,l=eL(a);s===this.userId&&t.path.isEqual(l)?n=n.add(o):i.done()});r.push(a)}),ew.waitFor(r).next(()=>this.rr(e,n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=[this.userId,eP(n)],s=IDBKeyRange.lowerBound(i),a=new tP(q);return tA(e,eW).ee({range:s},(e,t,i)=>{let[s,o,l]=e,u=eL(o);s===this.userId&&n.isPrefixOf(u)?u.length===r&&(a=a.add(l)):i.done()}).next(()=>this.rr(e,a))}rr(e,t){let n=[],r=[];return t.forEach(t=>{r.push(sn(e).get(t).next(e=>{if(null===e)throw S(35274,{batchId:t});N(e.userId===this.userId,9748,"Unexpected user for mutation batch",{userId:e.userId,batchId:t}),n.push(ix(this.serializer,e))}))}),ew.waitFor(r).next(()=>n)}removeMutationBatch(e,t){return i9(e.le,this.userId,t).next(n=>(e.addOnCommittedListener(()=>{this.ir(t.batchId)}),ew.forEach(n,t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))}ir(e){delete this.Xn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next(t=>{if(!t)return ew.resolve();let n=IDBKeyRange.lowerBound([this.userId]),r=[];return tA(e,eW).ee({range:n},(e,t,n)=>{if(e[0]===this.userId){let t=eL(e[1]);r.push(t)}else n.done()}).next(()=>{N(0===r.length,56720,{sr:r.map(e=>e.canonicalString())})})})}containsKey(e,t){return st(e,this.userId,t)}_r(e){return tA(e,ez).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function st(e,t,n){let r=[t,eP(n.path)],i=r[1],s=IDBKeyRange.lowerBound(r),a=!1;return tA(e,eW).ee({range:s,X:!0},(e,n,r)=>{let[s,o,l]=e;s===t&&o===i&&(a=!0),r.done()}).next(()=>a)}function sn(e){return tA(e,eK)}class sr{constructor(e){this.ar=e}next(){return this.ar+=2,this.ar}static ur(){return new sr(0)}static cr(){return new sr(-1)}}class si{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.lr(e).next(t=>{let n=new sr(t.highestTargetId);return t.highestTargetId=n.next(),this.hr(e,t).next(()=>t.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.lr(e).next(e=>es.fromTimestamp(new ei(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.lr(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(e,t,n){return this.lr(e).next(r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.hr(e,r)))}addTargetData(e,t){return this.Pr(e,t).next(()=>this.lr(e).next(n=>(n.targetCount+=1,this.Tr(t,n),this.hr(e,n))))}updateTargetData(e,t){return this.Pr(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next(()=>tA(e,e4).delete(t.targetId)).next(()=>this.lr(e)).next(t=>(N(t.targetCount>0,8065),t.targetCount-=1,this.hr(e,t)))}removeTargets(e,t,n){let r=0,i=[];return tA(e,e4).ee((s,a)=>{let o=iN(a);o.sequenceNumber<=t&&null===n.get(o.targetId)&&(r++,i.push(this.removeTargetData(e,o)))}).next(()=>ew.waitFor(i)).next(()=>r)}forEachTarget(e,t){return tA(e,e4).ee((e,n)=>{t(iN(n))})}lr(e){return tA(e,tt).get(te).next(e=>(N(null!==e,2888),e))}hr(e,t){return tA(e,tt).put(te,t)}Pr(e,t){return tA(e,e4).put(iD(this.serializer,t))}Tr(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.lr(e).next(e=>e.targetCount)}getTargetData(e,t){let n=nz(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]),i=null;return tA(e,e4).ee({range:r,index:e5},(e,n,r)=>{let s=iN(n);nK(t,s.target)&&(i=s,r.done())}).next(()=>i)}addMatchingKeys(e,t,n){let r=[],i=ss(e);return t.forEach(t=>{let s=eP(t.path);r.push(i.put({targetId:n,path:s})),r.push(this.referenceDelegate.addReference(e,n,t))}),ew.waitFor(r)}removeMatchingKeys(e,t,n){let r=ss(e);return ew.forEach(t,t=>{let i=eP(t.path);return ew.waitFor([r.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])})}removeMatchingKeysForTargetId(e,t){let n=ss(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){let n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ss(e),i=ra();return r.ee({range:n,X:!0},(e,t,n)=>{let r=new H(eL(e[1]));i=i.add(r)}).next(()=>i)}containsKey(e,t){let n=eP(t.path),r=IDBKeyRange.bound([n],[n+"\0"],!1,!0),i=0;return ss(e).ee({index:e9,X:!0,range:r},([e,t],n,r)=>{0!==e&&(i++,r.done())}).next(()=>i>0)}At(e,t){return tA(e,e4).get(t).next(e=>e?iN(e):null)}}function ss(e){return tA(e,e3)}let sa="LruGarbageCollector";function so([e,t],[n,r]){let i=q(e,n);return 0===i?q(t,r):i}class sl{constructor(e){this.Ir=e,this.buffer=new tP(so),this.Er=0}dr(){return++this.Er}Ar(e){let t=[e,this.dr()];if(this.buffer.size<this.Ir)this.buffer=this.buffer.add(t);else{let e=this.buffer.last();0>so(t,e)&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class su{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Rr=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Vr(6e4)}stop(){this.Rr&&(this.Rr.cancel(),this.Rr=null)}get started(){return null!==this.Rr}Vr(e){T(sa,`Garbage collection scheduled in ${e}ms`),this.Rr=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Rr=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){eS(e)?T(sa,"Ignoring IndexedDB error during garbage collection: ",e):await ey(e)}await this.Vr(3e5)})}}class sh{constructor(e,t){this.mr=e,this.params=t}calculateTargetCount(e,t){return this.mr.gr(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return ew.resolve(eR.ce);let n=new sl(t);return this.mr.forEachTarget(e,e=>n.Ar(e.sequenceNumber)).next(()=>this.mr.pr(e,e=>n.Ar(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.mr.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.mr.removeOrphanedDocuments(e,t)}collect(e,t){return -1===this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector","Garbage collection skipped; disabled"),ew.resolve(i3)):this.getCacheSize(e).next(n=>n<this.params.cacheSizeCollectionThreshold?(T("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),i3):this.yr(e,t))}getCacheSize(e){return this.mr.getCacheSize(e)}yr(e,t){let n,r,i,s,a,o,l;let h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next(t=>(t>this.params.maximumSequenceNumbersToCollect?(T("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,s=Date.now(),this.nthSequenceNumber(e,r))).next(r=>(n=r,a=Date.now(),this.removeTargets(e,n,t))).next(t=>(i=t,o=Date.now(),this.removeOrphanedDocuments(e,n))).next(e=>(l=Date.now(),I()<=u.$b.DEBUG&&T("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${s-h}ms
	Determined least recently used ${r} in `+(a-s)+"ms\n"+`	Removed ${i} targets in `+(o-a)+"ms\n"+`	Removed ${e} documents in `+(l-o)+"ms\n"+`Total Duration: ${l-h}ms`),ew.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:i,documentsRemoved:e})))}}class sc{constructor(e,t){this.db=e,this.garbageCollector=new sh(this,t)}gr(e){let t=this.wr(e);return this.db.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}pr(e,t){return this.Sr(e,(e,n)=>t(n))}addReference(e,t,n){return sd(e,n)}removeReference(e,t,n){return sd(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return sd(e,t)}br(e,t){let n;return n=!1,tA(e,ez).te(r=>st(e,r,t).next(e=>(e&&(n=!0),ew.resolve(!e)))).next(()=>n)}removeOrphanedDocuments(e,t){let n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[],i=0;return this.Sr(e,(s,a)=>{if(a<=t){let t=this.br(e,s).next(t=>{if(!t)return i++,n.getEntry(e,s).next(()=>(n.removeEntry(s,es.min()),ss(e).delete([0,eP(s.path)])))});r.push(t)}}).next(()=>ew.waitFor(r)).next(()=>n.apply(e)).next(()=>i)}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return sd(e,t)}Sr(e,t){let n=ss(e),r,i=eR.ce;return n.ee({index:e9},([e,n],{path:s,sequenceNumber:a})=>{0===e?(i!==eR.ce&&t(new H(eL(r)),i),i=a,r=s):i=eR.ce}).next(()=>{i!==eR.ce&&t(new H(eL(r)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function sd(e,t){var n;return ss(e).put((n=e.currentSequenceNumber,{targetId:0,path:eP(t.path),sequenceNumber:n}))}class sf{constructor(){this.changes=new n9(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,nv.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();let n=this.changes.get(t);return void 0!==n?ew.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class sm{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return tA(e,eH).put(n)}removeEntry(e,t,n){return tA(e,eH).delete(function(e,t){let n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],ib(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next(n=>(n.byteSize+=t,this.Dr(e,n)))}getEntry(e,t){let n=nv.newInvalidDocument(t);return tA(e,eH).ee({index:eY,range:IDBKeyRange.only(sp(t))},(e,r)=>{n=this.Cr(t,r)}).next(()=>n)}vr(e,t){let n={size:0,document:nv.newInvalidDocument(t)};return tA(e,eH).ee({index:eY,range:IDBKeyRange.only(sp(t))},(e,r)=>{n={document:this.Cr(t,r),size:i7(r)}}).next(()=>n)}getEntries(e,t){let n=n7;return this.Fr(e,t,(e,t)=>{let r=this.Cr(e,t);n=n.insert(e,r)}).next(()=>n)}Mr(e,t){let n=n7,r=new tM(H.comparator);return this.Fr(e,t,(e,t)=>{let i=this.Cr(e,t);n=n.insert(e,i),r=r.insert(e,i7(t))}).next(()=>({documents:n,Or:r}))}Fr(e,t,n){if(t.isEmpty())return ew.resolve();let r=new tP(sw);t.forEach(e=>r=r.add(e));let i=IDBKeyRange.bound(sp(r.first()),sp(r.last())),s=r.getIterator(),a=s.getNext();return tA(e,eH).ee({index:eY,range:i},(e,t,r)=>{let i=H.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;a&&0>sw(a,i);)n(a,null),a=s.getNext();a&&a.isEqual(i)&&(n(a,t),a=s.hasNext()?s.getNext():null),a?r.j(sp(a)):r.done()}).next(()=>{for(;a;)n(a,null),a=s.hasNext()?s.getNext():null})}getDocumentsMatchingQuery(e,t,n,r,i){let s=t.path,a=[s.popLast().toArray(),s.lastSegment(),ib(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[s.popLast().toArray(),s.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return tA(e,eH).J(IDBKeyRange.bound(a,o,!0)).next(e=>{i?.incrementDocumentReadCount(e.length);let n=n7;for(let i of e){let e=this.Cr(H.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(n6(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n})}getAllFromCollectionGroup(e,t,n,r){let i=n7,s=sy(t,n),a=sy(t,ef.max());return tA(e,eH).ee({index:eZ,range:IDBKeyRange.bound(s,a,!0)},(e,t,n)=>{let s=this.Cr(H.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(i=i.insert(s.key,s)).size===r&&n.done()}).next(()=>i)}newChangeBuffer(e){return new sg(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return tA(e,e1).get(e2).next(e=>(N(!!e,20021),e))}Dr(e,t){return tA(e,e1).put(e2,t)}Cr(e,t){if(t){let e=function(e,t){let n;if(t.document)n=ih(e.yt,t.document,!!t.hasCommittedMutations);else if(t.noDocument){let e=H.fromSegments(t.noDocument.path),r=iS(t.noDocument.readTime);n=nv.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return S(56709);{let e=H.fromSegments(t.unknownDocument.path),r=iS(t.unknownDocument.version);n=nv.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){let t=new ei(e[0],e[1]);return es.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!(e.isNoDocument()&&e.version.isEqual(es.min())))return e}return nv.newInvalidDocument(e)}}class sg extends sf{constructor(e,t){super(),this.Nr=e,this.trackRemovals=t,this.Br=new n9(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(e){let t=[],n=0,r=new tP((e,t)=>q(e.canonicalString(),t.canonicalString()));return this.changes.forEach((i,s)=>{let a=this.Br.get(i);if(t.push(this.Nr.removeEntry(e,i,a.readTime)),s.isValidDocument()){let o=iE(this.Nr.serializer,s);r=r.add(i.path.popLast());let l=i7(o);n+=l-a.size,t.push(this.Nr.addEntry(e,i,o))}else if(n-=a.size,this.trackRemovals){let n=iE(this.Nr.serializer,s.convertToNoDocument(es.min()));t.push(this.Nr.addEntry(e,i,n))}}),r.forEach(n=>{t.push(this.Nr.indexManager.addToCollectionParentIndex(e,n))}),t.push(this.Nr.updateMetadata(e,n)),ew.waitFor(t)}getFromCache(e,t){return this.Nr.vr(e,t).next(e=>(this.Br.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Nr.Mr(e,t).next(({documents:e,Or:t})=>(t.forEach((t,n)=>{this.Br.set(t,{size:n,readTime:e.get(t).readTime})}),e))}}function sp(e){let t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function sy(e,t){let n=t.documentKey.path.toArray();return[e,ib(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function sw(e,t){let n=e.path.toArray(),r=t.path.toArray(),i=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(i=q(n[e],r[e]))return i;return(i=q(n.length,r.length))||(i=q(n[n.length-2],r[r.length-2]))||q(n[n.length-1],r[r.length-1])}class sv{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class sI{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next(r=>(n=r,this.remoteDocumentCache.getEntry(e,t))).next(e=>(null!==n&&rN(n.mutation,e,tq.empty(),ei.now()),e))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.getLocalViewOfDocuments(e,t,ra()).next(()=>t))}getLocalViewOfDocuments(e,t,n=ra()){let r=rr();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let t=rt();return e.forEach((e,n)=>{t=t.insert(e,n.overlayedDocument)}),t}))}getOverlayedDocuments(e,t){let n=rr();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,ra()))}populateOverlays(e,t,n){let r=[];return n.forEach(e=>{t.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,n)=>{t.set(e,n)})})}computeViews(e,t,n,r){let i=n7,s=rr(),a=rr();return t.forEach((e,t)=>{let a=n.get(t.key);r.has(t.key)&&(void 0===a||a.mutation instanceof rA)?i=i.insert(t.key,t):void 0!==a?(s.set(t.key,a.mutation.getFieldMask()),rN(a.mutation,t,a.mutation.getFieldMask(),ei.now())):s.set(t.key,tq.empty())}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>s.set(e,t)),t.forEach((e,t)=>a.set(e,new sv(t,s.get(e)??null))),a))}recalculateAndSaveOverlays(e,t){let n=rr(),r=new tM((e,t)=>e-t),i=ra();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next(e=>{for(let i of e)i.keys().forEach(e=>{let s=t.get(e);if(null===s)return;let a=n.get(e)||tq.empty();a=i.applyToLocalView(s,a),n.set(e,a);let o=(r.get(i.batchId)||ra()).add(e);r=r.insert(i.batchId,o)})}).next(()=>{let s=[],a=r.getReverseIterator();for(;a.hasNext();){let r=a.getNext(),o=r.key,l=r.value,u=rr();l.forEach(e=>{if(!i.has(e)){let r=rx(t.get(e),n.get(e));null!==r&&u.set(e,r),i=i.add(e)}}),s.push(this.documentOverlayCache.saveOverlays(e,o,u))}return ew.waitFor(s)}).next(()=>n)}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next(t=>this.recalculateAndSaveOverlays(e,t))}getDocumentsMatchingQuery(e,t,n,r){return H.isDocumentKey(t.path)&&null===t.collectionGroup&&0===t.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):nY(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next(i=>{let s=r-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-i.size):ew.resolve(rr()),a=-1,o=i;return s.next(t=>ew.forEach(t,(t,n)=>(a<n.largestBatchId&&(a=n.largestBatchId),i.get(t)?ew.resolve():this.remoteDocumentCache.getEntry(e,t).next(e=>{o=o.insert(t,e)}))).next(()=>this.populateOverlays(e,t,i)).next(()=>this.computeViews(e,o,t,ra())).next(e=>({batchId:a,changes:rn(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new H(t)).next(e=>{let t=rt();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t})}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){let i=t.collectionGroup,s=rt();return this.indexManager.getCollectionParents(e,i).next(a=>ew.forEach(a,a=>{let o=new nW(a.child(i),null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(e,o,n,r).next(e=>{e.forEach((e,t)=>{s=s.insert(e,t)})})}).next(()=>s))}getDocumentsMatchingCollectionQuery(e,t,n,r){let i;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next(s=>(i=s,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,i,r))).next(e=>{i.forEach((t,n)=>{let r=n.getKey();null===e.get(r)&&(e=e.insert(r,nv.newInvalidDocument(r)))});let n=rt();return e.forEach((e,r)=>{let s=i.get(e);void 0!==s&&rN(s.mutation,r,tq.empty(),ei.now()),n6(t,r)&&(n=n.insert(e,r))}),n})}}class sT{constructor(e){this.serializer=e,this.Lr=new Map,this.kr=new Map}getBundleMetadata(e,t){return ew.resolve(this.Lr.get(t))}saveBundleMetadata(e,t){return this.Lr.set(t.id,{id:t.id,version:t.version,createTime:r9(t.createTime)}),ew.resolve()}getNamedQuery(e,t){return ew.resolve(this.kr.get(t))}saveNamedQuery(e,t){return this.kr.set(t.name,{name:t.name,query:iC(t.bundledQuery),readTime:r9(t.readTime)}),ew.resolve()}}class sE{constructor(){this.overlays=new tM(H.comparator),this.qr=new Map}getOverlay(e,t){return ew.resolve(this.overlays.get(t))}getOverlays(e,t){let n=rr();return ew.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(e,t,n){return n.forEach((n,r)=>{this.St(e,t,r)}),ew.resolve()}removeOverlaysForBatchId(e,t,n){let r=this.qr.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.qr.delete(n)),ew.resolve()}getOverlaysForCollection(e,t,n){let r=rr(),i=t.length+1,s=new H(t.child("")),a=this.overlays.getIteratorFrom(s);for(;a.hasNext();){let e=a.getNext().value,s=e.getKey();if(!t.isPrefixOf(s.path))break;s.path.length===i&&e.largestBatchId>n&&r.set(e.getKey(),e)}return ew.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let i=new tM((e,t)=>e-t),s=this.overlays.getIterator();for(;s.hasNext();){let e=s.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=rr(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}let a=rr(),o=i.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return ew.resolve(a)}St(e,t,n){let r=this.overlays.get(n.key);if(null!==r){let e=this.qr.get(r.largestBatchId).delete(n.key);this.qr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new rL(t,n));let i=this.qr.get(t);void 0===i&&(i=ra(),this.qr.set(t,i)),this.qr.set(t,i.add(n.key))}}class sb{constructor(){this.sessionToken=tz.EMPTY_BYTE_STRING}getSessionToken(e){return ew.resolve(this.sessionToken)}setSessionToken(e,t){return this.sessionToken=t,ew.resolve()}}class s_{constructor(){this.Qr=new tP(sS.$r),this.Ur=new tP(sS.Kr)}isEmpty(){return this.Qr.isEmpty()}addReference(e,t){let n=new sS(e,t);this.Qr=this.Qr.add(n),this.Ur=this.Ur.add(n)}Wr(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.Gr(new sS(e,t))}zr(e,t){e.forEach(e=>this.removeReference(e,t))}jr(e){let t=new H(new j([])),n=new sS(t,e),r=new sS(t,e+1),i=[];return this.Ur.forEachInRange([n,r],e=>{this.Gr(e),i.push(e.key)}),i}Jr(){this.Qr.forEach(e=>this.Gr(e))}Gr(e){this.Qr=this.Qr.delete(e),this.Ur=this.Ur.delete(e)}Hr(e){let t=new H(new j([])),n=new sS(t,e),r=new sS(t,e+1),i=ra();return this.Ur.forEachInRange([n,r],e=>{i=i.add(e.key)}),i}containsKey(e){let t=new sS(e,0),n=this.Qr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class sS{constructor(e,t){this.key=e,this.Yr=t}static $r(e,t){return H.comparator(e.key,t.key)||q(e.Yr,t.Yr)}static Kr(e,t){return q(e.Yr,t.Yr)||H.comparator(e.key,t.key)}}class sx{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.tr=1,this.Zr=new tP(sS.$r)}checkEmpty(e){return ew.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){let i=this.tr;this.tr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];let s=new rF(i,t,n,r);for(let t of(this.mutationQueue.push(s),r))this.Zr=this.Zr.add(new sS(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ew.resolve(s)}lookupMutationBatch(e,t){return ew.resolve(this.Xr(t))}getNextMutationBatchAfterBatchId(e,t){let n=this.ei(t+1),r=n<0?0:n;return ew.resolve(this.mutationQueue.length>r?this.mutationQueue[r]:null)}getHighestUnacknowledgedBatchId(){return ew.resolve(0===this.mutationQueue.length?-1:this.tr-1)}getAllMutationBatches(e){return ew.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){let n=new sS(t,0),r=new sS(t,Number.POSITIVE_INFINITY),i=[];return this.Zr.forEachInRange([n,r],e=>{let t=this.Xr(e.Yr);i.push(t)}),ew.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new tP(q);return t.forEach(e=>{let t=new sS(e,0),r=new sS(e,Number.POSITIVE_INFINITY);this.Zr.forEachInRange([t,r],e=>{n=n.add(e.Yr)})}),ew.resolve(this.ti(n))}getAllMutationBatchesAffectingQuery(e,t){let n=t.path,r=n.length+1,i=n;H.isDocumentKey(i)||(i=i.child(""));let s=new sS(new H(i),0),a=new tP(q);return this.Zr.forEachWhile(e=>{let t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(a=a.add(e.Yr)),!0)},s),ew.resolve(this.ti(a))}ti(e){let t=[];return e.forEach(e=>{let n=this.Xr(e);null!==n&&t.push(n)}),t}removeMutationBatch(e,t){N(0===this.ni(t.batchId,"removed"),55003),this.mutationQueue.shift();let n=this.Zr;return ew.forEach(t.mutations,r=>{let i=new sS(r.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)}).next(()=>{this.Zr=n})}ir(e){}containsKey(e,t){let n=new sS(t,0),r=this.Zr.firstAfterOrEqual(n);return ew.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,ew.resolve()}ni(e,t){return this.ei(e)}ei(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Xr(e){let t=this.ei(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class sN{constructor(e){this.ri=e,this.docs=new tM(H.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){let n=t.key,r=this.docs.get(n),i=r?r.size:0,s=this.ri(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:s}),this.size+=s-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){let t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){let n=this.docs.get(t);return ew.resolve(n?n.document.mutableCopy():nv.newInvalidDocument(t))}getEntries(e,t){let n=n7;return t.forEach(e=>{let t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():nv.newInvalidDocument(e))}),ew.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let i=n7,s=t.path,a=new H(s.child("__id-9223372036854775808__")),o=this.docs.getIteratorFrom(a);for(;o.hasNext();){let{key:e,value:{document:a}}=o.getNext();if(!s.isPrefixOf(e.path))break;e.path.length>s.length+1||0>=em(ed(a),n)||(r.has(a.key)||n6(t,a))&&(i=i.insert(a.key,a.mutableCopy()))}return ew.resolve(i)}getAllFromCollectionGroup(e,t,n,r){S(9500)}ii(e,t){return ew.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new sD(this)}getSize(e){return ew.resolve(this.size)}}class sD extends sf{constructor(e){super(),this.Nr=e}applyChanges(e){let t=[];return this.changes.forEach((n,r)=>{r.isValidDocument()?t.push(this.Nr.addEntry(e,r)):this.Nr.removeEntry(n)}),ew.waitFor(t)}getFromCache(e,t){return this.Nr.getEntry(e,t)}getAllFromCache(e,t){return this.Nr.getEntries(e,t)}}class sC{constructor(e){this.persistence=e,this.si=new n9(e=>nz(e),nK),this.lastRemoteSnapshotVersion=es.min(),this.highestTargetId=0,this.oi=0,this._i=new s_,this.targetCount=0,this.ai=sr.ur()}forEachTarget(e,t){return this.si.forEach((e,n)=>t(n)),ew.resolve()}getLastRemoteSnapshotVersion(e){return ew.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ew.resolve(this.oi)}allocateTargetId(e){return this.highestTargetId=this.ai.next(),ew.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.oi&&(this.oi=t),ew.resolve()}Pr(e){this.si.set(e.target,e);let t=e.targetId;t>this.highestTargetId&&(this.ai=new sr(t),this.highestTargetId=t),e.sequenceNumber>this.oi&&(this.oi=e.sequenceNumber)}addTargetData(e,t){return this.Pr(t),this.targetCount+=1,ew.resolve()}updateTargetData(e,t){return this.Pr(t),ew.resolve()}removeTargetData(e,t){return this.si.delete(t.target),this._i.jr(t.targetId),this.targetCount-=1,ew.resolve()}removeTargets(e,t,n){let r=0,i=[];return this.si.forEach((s,a)=>{a.sequenceNumber<=t&&null===n.get(a.targetId)&&(this.si.delete(s),i.push(this.removeMatchingKeysForTargetId(e,a.targetId)),r++)}),ew.waitFor(i).next(()=>r)}getTargetCount(e){return ew.resolve(this.targetCount)}getTargetData(e,t){let n=this.si.get(t)||null;return ew.resolve(n)}addMatchingKeys(e,t,n){return this._i.Wr(t,n),ew.resolve()}removeMatchingKeys(e,t,n){this._i.zr(t,n);let r=this.persistence.referenceDelegate,i=[];return r&&t.forEach(t=>{i.push(r.markPotentiallyOrphaned(e,t))}),ew.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this._i.jr(t),ew.resolve()}getMatchingKeysForTargetId(e,t){let n=this._i.Hr(t);return ew.resolve(n)}containsKey(e,t){return ew.resolve(this._i.containsKey(t))}}class sA{constructor(e,t){this.ui={},this.overlays={},this.ci=new eR(0),this.li=!1,this.li=!0,this.hi=new sb,this.referenceDelegate=e(this),this.Pi=new sC(this),this.indexManager=new i0,this.remoteDocumentCache=new sN(e=>this.referenceDelegate.Ti(e)),this.serializer=new iT(t),this.Ii=new sT(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.li=!1,Promise.resolve()}get started(){return this.li}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new sE,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.ui[e.toKey()];return n||(n=new sx(t,this.referenceDelegate),this.ui[e.toKey()]=n),n}getGlobalsCache(){return this.hi}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ii}runTransaction(e,t,n){T("MemoryPersistence","Starting transaction:",e);let r=new sk(this.ci.next());return this.referenceDelegate.Ei(),n(r).next(e=>this.referenceDelegate.di(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ai(e,t){return ew.or(Object.values(this.ui).map(n=>()=>n.containsKey(e,t)))}}class sk extends ep{constructor(e){super(),this.currentSequenceNumber=e}}class sV{constructor(e){this.persistence=e,this.Ri=new s_,this.Vi=null}static mi(e){return new sV(e)}get fi(){if(this.Vi)return this.Vi;throw S(60996)}addReference(e,t,n){return this.Ri.addReference(n,t),this.fi.delete(n.toString()),ew.resolve()}removeReference(e,t,n){return this.Ri.removeReference(n,t),this.fi.add(n.toString()),ew.resolve()}markPotentiallyOrphaned(e,t){return this.fi.add(t.toString()),ew.resolve()}removeTarget(e,t){this.Ri.jr(t.targetId).forEach(e=>this.fi.add(e.toString()));let n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.fi.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}Ei(){this.Vi=new Set}di(e){let t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ew.forEach(this.fi,n=>{let r=H.fromPath(n);return this.gi(e,r).next(e=>{e||t.removeEntry(r,es.min())})}).next(()=>(this.Vi=null,t.apply(e)))}updateLimboDocument(e,t){return this.gi(e,t).next(e=>{e?this.fi.delete(t.toString()):this.fi.add(t.toString())})}Ti(e){return 0}gi(e,t){return ew.or([()=>ew.resolve(this.Ri.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ai(e,t)])}}class sR{constructor(e,t){this.persistence=e,this.pi=new n9(e=>eP(e.path),(e,t)=>e.isEqual(t)),this.garbageCollector=new sh(this,t)}static mi(e,t){return new sR(e,t)}Ei(){}di(e){return ew.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}gr(e){let t=this.wr(e);return this.persistence.getTargetCache().getTargetCount(e).next(e=>t.next(t=>e+t))}wr(e){let t=0;return this.pr(e,e=>{t++}).next(()=>t)}pr(e,t){return ew.forEach(this.pi,(n,r)=>this.br(e,n,r).next(e=>e?ew.resolve():t(r)))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0,r=this.persistence.getRemoteDocumentCache(),i=r.newChangeBuffer();return r.ii(e,r=>this.br(e,r,t).next(e=>{e||(n++,i.removeEntry(r,es.min()))})).next(()=>i.apply(e)).next(()=>n)}markPotentiallyOrphaned(e,t){return this.pi.set(t,e.currentSequenceNumber),ew.resolve()}removeTarget(e,t){let n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.pi.set(n,e.currentSequenceNumber),ew.resolve()}removeReference(e,t,n){return this.pi.set(n,e.currentSequenceNumber),ew.resolve()}updateLimboDocument(e,t){return this.pi.set(t,e.currentSequenceNumber),ew.resolve()}Ti(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=function e(t){switch(t7(t)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:let n=tX(t);return n?16+e(n):16;case 5:return 2*t.stringValue.length;case 6:return tj(t.bytesValue).approximateByteSize();case 7:return t.referenceValue.length;case 9:return(t.arrayValue.values||[]).reduce((t,n)=>t+e(n),0);case 10:case 11:var r;let i;return r=t.mapValue,i=0,tV(r.fields,(t,n)=>{i+=t.length+e(n)}),i;default:throw S(13486,{value:t})}}(e.data.value)),t}br(e,t,n){return ew.or([()=>this.persistence.Ai(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{let e=this.pi.get(t);return ew.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class sM{constructor(e){this.serializer=e}k(e,t,n,r){let i=new eI("createOrUpgrade",t);n<1&&r>=1&&(!function(e){e.createObjectStore(eq)}(e),e.createObjectStore(ez,{keyPath:"userId"}),e.createObjectStore(eK,{keyPath:e$,autoIncrement:!0}).createIndex(eG,ej,{unique:!0}),e.createObjectStore(eW),sO(e),function(e){e.createObjectStore(eU)}(e));let s=ew.resolve();return n<3&&r>=3&&(0!==n&&(e.deleteObjectStore(e3),e.deleteObjectStore(e4),e.deleteObjectStore(tt),sO(e)),s=s.next(()=>(function(e){let t=e.store(tt),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:es.min().toTimestamp(),targetCount:0};return t.put(te,n)})(i))),n<4&&r>=4&&(0!==n&&(s=s.next(()=>i.store(eK).J().next(t=>{e.deleteObjectStore(eK),e.createObjectStore(eK,{keyPath:e$,autoIncrement:!0}).createIndex(eG,ej,{unique:!0});let n=i.store(eK),r=t.map(e=>n.put(e));return ew.waitFor(r)}))),s=s.next(()=>{!function(e){e.createObjectStore(ti,{keyPath:"clientId"})}(e)})),n<5&&r>=5&&(s=s.next(()=>this.yi(i))),n<6&&r>=6&&(s=s.next(()=>((function(e){e.createObjectStore(e1)})(e),this.wi(i)))),n<7&&r>=7&&(s=s.next(()=>this.Si(i))),n<8&&r>=8&&(s=s.next(()=>this.bi(e,i))),n<9&&r>=9&&(s=s.next(()=>{e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&r>=10&&(s=s.next(()=>this.Di(i))),n<11&&r>=11&&(s=s.next(()=>{(function(e){e.createObjectStore(ts,{keyPath:"bundleId"})})(e),function(e){e.createObjectStore(ta,{keyPath:"name"})}(e)})),n<12&&r>=12&&(s=s.next(()=>{!function(e){let t=e.createObjectStore(ty,{keyPath:tw});t.createIndex(tv,tI,{unique:!1}),t.createIndex(tT,tE,{unique:!1})}(e)})),n<13&&r>=13&&(s=s.next(()=>(function(e){let t=e.createObjectStore(eH,{keyPath:eJ});t.createIndex(eY,eX),t.createIndex(eZ,e0)})(e)).next(()=>this.Ci(e,i)).next(()=>e.deleteObjectStore(eU))),n<14&&r>=14&&(s=s.next(()=>this.Fi(e,i))),n<15&&r>=15&&(s=s.next(()=>{e.createObjectStore(to,{keyPath:"indexId",autoIncrement:!0}).createIndex(tl,"collectionGroup",{unique:!1}),e.createObjectStore(tu,{keyPath:th}).createIndex(tc,td,{unique:!1}),e.createObjectStore(tf,{keyPath:tm}).createIndex(tg,tp,{unique:!1})})),n<16&&r>=16&&(s=s.next(()=>{t.objectStore(tu).clear()}).next(()=>{t.objectStore(tf).clear()})),n<17&&r>=17&&(s=s.next(()=>{!function(e){e.createObjectStore(tb,{keyPath:"name"})}(e)})),n<18&&r>=18&&(0,h.Ov)()&&(s=s.next(()=>{t.objectStore(tu).clear()}).next(()=>{t.objectStore(tf).clear()})),s}wi(e){let t=0;return e.store(eU).ee((e,n)=>{t+=i7(n)}).next(()=>{let n={byteSize:t};return e.store(e1).put(e2,n)})}yi(e){let t=e.store(ez),n=e.store(eK);return t.J().next(t=>ew.forEach(t,t=>{let r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.J(eG,r).next(n=>ew.forEach(n,n=>{N(n.userId===t.userId,18650,"Cannot process batch from unexpected user",{batchId:n.batchId});let r=ix(this.serializer,n);return i9(e,t.userId,r).next(()=>{})}))}))}Si(e){let t=e.store(e3),n=e.store(eU);return e.store(tt).get(te).next(e=>{let r=[];return n.ee((n,i)=>{let s=new j(n),a=[0,eP(s)];r.push(t.get(a).next(n=>n?ew.resolve():t.put({targetId:0,path:eP(s),sequenceNumber:e.highestListenSequenceNumber})))}).next(()=>ew.waitFor(r))})}bi(e,t){e.createObjectStore(tn,{keyPath:tr});let n=t.store(tn),r=new i1,i=e=>{if(r.add(e)){let t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:eP(r)})}};return t.store(eU).ee({X:!0},(e,t)=>i(new j(e).popLast())).next(()=>t.store(eW).ee({X:!0},([e,t,n],r)=>i(eL(t).popLast())))}Di(e){let t=e.store(e4);return t.ee((e,n)=>{let r=iN(n),i=iD(this.serializer,r);return t.put(i)})}Ci(e,t){let n=t.store(eU),r=[];return n.ee((e,n)=>{let i=t.store(eH),s=(n.document?new H(j.fromString(n.document.name).popFirst(5)):n.noDocument?H.fromSegments(n.noDocument.path):n.unknownDocument?H.fromSegments(n.unknownDocument.path):S(36783)).path.toArray(),a={prefixPath:s.slice(0,s.length-2),collectionGroup:s[s.length-2],documentId:s[s.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(i.put(a))}).next(()=>ew.waitFor(r))}Fi(e,t){let n=t.store(eK),r=new sm(this.serializer),i=new sA(sV.mi,this.serializer.yt);return n.J().next(e=>{let n=new Map;return e.forEach(e=>{let t=n.get(e.userId)??ra();ix(this.serializer,e).keys().forEach(e=>t=t.add(e)),n.set(e.userId,t)}),ew.forEach(n,(e,n)=>{let s=new y(n),a=iM.wt(this.serializer,s),o=i.getIndexManager(s);return new sI(r,se.wt(s,this.serializer,o,i.referenceDelegate),a,o).recalculateAndSaveOverlaysForDocumentKeys(new tC(t,eR.ce),e).next()})})}}function sO(e){e.createObjectStore(e3,{keyPath:e8}).createIndex(e9,e7,{unique:!0}),e.createObjectStore(e4,{keyPath:"targetId"}).createIndex(e5,e6,{unique:!0}),e.createObjectStore(tt)}let sF="IndexedDbPersistence",sP="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class sL{constructor(e,t,n,r,i,s,a,o,l,u,h=18){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Mi=i,this.window=s,this.document=a,this.xi=l,this.Oi=u,this.Ni=h,this.ci=null,this.li=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Bi=null,this.inForeground=!1,this.Li=null,this.ki=null,this.qi=Number.NEGATIVE_INFINITY,this.Qi=e=>Promise.resolve(),!sL.v())throw new C(D.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new sc(this,r),this.$i=t+"main",this.serializer=new iT(o),this.Ui=new eT(this.$i,this.Ni,new sM(this.serializer)),this.hi=new iO,this.Pi=new si(this.referenceDelegate,this.serializer),this.remoteDocumentCache=new sm(this.serializer),this.Ii=new iR,this.window&&this.window.localStorage?this.Ki=this.window.localStorage:(this.Ki=null,!1===u&&E(sF,"LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Wi().then(()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new C(D.FAILED_PRECONDITION,sP);return this.Gi(),this.zi(),this.ji(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Pi.getHighestSequenceNumber(e))}).then(e=>{this.ci=new eR(e,this.xi)}).then(()=>{this.li=!0}).catch(e=>(this.Ui&&this.Ui.close(),Promise.reject(e)))}Ji(e){return this.Qi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ui.$(async t=>{null===t.newVersion&&await e()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Mi.enqueueAndForget(async()=>{this.started&&await this.Wi()}))}Wi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",e=>tA(e,ti).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.Hi(e).next(e=>{e||(this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)))})}).next(()=>this.Yi(e)).next(t=>this.isPrimary&&!t?this.Zi(e).next(()=>!1):!!t&&this.Xi(e).next(()=>!0))).catch(e=>{if(eS(e))return T(sF,"Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return T(sF,"Releasing owner lease after error during lease refresh",e),!1}).then(e=>{this.isPrimary!==e&&this.Mi.enqueueRetryable(()=>this.Qi(e)),this.isPrimary=e})}Hi(e){return tA(e,eq).get(eB).next(e=>ew.resolve(this.es(e)))}ts(e){return tA(e,ti).delete(this.clientId)}async ns(){if(this.isPrimary&&!this.rs(this.qi,18e5)){this.qi=Date.now();let e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{let t=tA(e,ti);return t.J().next(e=>{let n=this.ss(e,18e5),r=e.filter(e=>-1===n.indexOf(e));return ew.forEach(r,e=>t.delete(e.clientId)).next(()=>r)})}).catch(()=>[]);if(this.Ki)for(let t of e)this.Ki.removeItem(this._s(t.clientId))}}ji(){this.ki=this.Mi.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.Wi().then(()=>this.ns()).then(()=>this.ji()))}es(e){return!!e&&e.ownerId===this.clientId}Yi(e){return this.Oi?ew.resolve(!0):tA(e,eq).get(eB).next(t=>{if(null!==t&&this.rs(t.leaseTimestampMs,5e3)&&!this.us(t.ownerId)){if(this.es(t)&&this.networkEnabled)return!0;if(!this.es(t)){if(!t.allowTabSynchronization)throw new C(D.FAILED_PRECONDITION,sP);return!1}}return!(!this.networkEnabled||!this.inForeground)||tA(e,ti).J().next(e=>void 0===this.ss(e,5e3).find(e=>{if(this.clientId!==e.clientId){let t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&T(sF,`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.li=!1,this.cs(),this.ki&&(this.ki.cancel(),this.ki=null),this.ls(),this.hs(),await this.Ui.runTransaction("shutdown","readwrite",[eq,ti],e=>{let t=new tC(e,eR.ce);return this.Zi(t).next(()=>this.ts(t))}),this.Ui.close(),this.Ps()}ss(e,t){return e.filter(e=>this.rs(e.updateTimeMs,t)&&!this.us(e.clientId))}Ts(){return this.runTransaction("getActiveClients","readonly",e=>tA(e,ti).J().next(e=>this.ss(e,18e5).map(e=>e.clientId)))}get started(){return this.li}getGlobalsCache(){return this.hi}getMutationQueue(e,t){return se.wt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Pi}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new i5(e,this.serializer.yt.databaseId)}getDocumentOverlayCache(e){return iM.wt(this.serializer,e)}getBundleCache(){return this.Ii}runTransaction(e,t,n){var r;let i;T(sF,"Starting transaction:",e);let s=18===(r=this.Ni)?tD:17===r?tD:16===r?tN:15===r?tN:14===r?tx:13===r?tx:12===r?tS:11===r?t_:void S(60245);return this.Ui.runTransaction(e,"readonly"===t?"readonly":"readwrite",s,r=>(i=new tC(r,this.ci?this.ci.next():eR.ce),"readwrite-primary"===t?this.Hi(i).next(e=>!!e||this.Yi(i)).next(t=>{if(!t)throw E(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.Mi.enqueueRetryable(()=>this.Qi(!1)),new C(D.FAILED_PRECONDITION,eg);return n(i)}).next(e=>this.Xi(i).next(()=>e)):this.Is(i).next(()=>n(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Is(e){return tA(e,eq).get(eB).next(e=>{if(null!==e&&this.rs(e.leaseTimestampMs,5e3)&&!this.us(e.ownerId)&&!this.es(e)&&!(this.Oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new C(D.FAILED_PRECONDITION,sP)})}Xi(e){let t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return tA(e,eq).put(eB,t)}static v(){return eT.v()}Zi(e){let t=tA(e,eq);return t.get(eB).next(e=>this.es(e)?(T(sF,"Releasing primary lease."),t.delete(eB)):ew.resolve())}rs(e,t){let n=Date.now();return!(e<n-t)&&(!(e>n)||(E(`Detected an update time that is in the future: ${e} > ${n}`),!1))}Gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Li=()=>{this.Mi.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.Wi()))},this.document.addEventListener("visibilitychange",this.Li),this.inForeground="visible"===this.document.visibilityState)}ls(){this.Li&&(this.document.removeEventListener("visibilitychange",this.Li),this.Li=null)}zi(){"function"==typeof this.window?.addEventListener&&(this.Bi=()=>{this.cs();let e=/(?:Version|Mobile)\/1[456]/;(0,h.nr)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.Mi.enterRestrictedMode(!0),this.Mi.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Bi))}hs(){this.Bi&&(this.window.removeEventListener("pagehide",this.Bi),this.Bi=null)}us(e){try{let t=null!==this.Ki?.getItem(this._s(e));return T(sF,`Client '${e}' ${t?"is":"is not"} zombied in LocalStorage`),t}catch(e){return E(sF,"Failed to get zombied client id.",e),!1}}cs(){if(this.Ki)try{this.Ki.setItem(this._s(this.clientId),String(Date.now()))}catch(e){E("Failed to set zombie client id.",e)}}Ps(){if(this.Ki)try{this.Ki.removeItem(this._s(this.clientId))}catch(e){}}_s(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function sU(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class sq{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Es=n,this.ds=r}static As(e,t){let n=ra(),r=ra();for(let e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new sq(e,t.fromCache,n,r)}}class sB{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class sz{constructor(){this.Rs=!1,this.Vs=!1,this.fs=100,this.gs=(0,h.nr)()?8:eE((0,h.ZQ)())>0?6:4}initialize(e,t){this.ps=e,this.indexManager=t,this.Rs=!0}getDocumentsMatchingQuery(e,t,n,r){let i={result:null};return this.ys(e,t).next(e=>{i.result=e}).next(()=>{if(!i.result)return this.ws(e,t,r,n).next(e=>{i.result=e})}).next(()=>{if(i.result)return;let n=new sB;return this.Ss(e,t,n).next(r=>{if(i.result=r,this.Vs)return this.bs(e,t,n,r.size)})}).next(()=>i.result)}bs(e,t,n,r){return n.documentReadCount<this.fs?(I()<=u.$b.DEBUG&&T("QueryEngine","SDK will not create cache indexes for query:",n5(t),"since it only creates cache indexes for collection contains","more than or equal to",this.fs,"documents"),ew.resolve()):(I()<=u.$b.DEBUG&&T("QueryEngine","Query:",n5(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.gs*r?(I()<=u.$b.DEBUG&&T("QueryEngine","The SDK decides to create cache indexes for query:",n5(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,nZ(t))):ew.resolve())}ys(e,t){if(nJ(t))return ew.resolve(null);let n=nZ(t);return this.indexManager.getIndexType(e,n).next(r=>0===r?null:(null!==t.limit&&1===r&&(n=nZ(t=n1(t,null,"F"))),this.indexManager.getDocumentsMatchingTarget(e,n).next(r=>{let i=ra(...r);return this.ps.getDocuments(e,i).next(r=>this.indexManager.getMinOffset(e,n).next(n=>{let s=this.Ds(t,r);return this.Cs(t,s,i,n.readTime)?this.ys(e,n1(t,null,"F")):this.vs(e,s,t,n)}))})))}ws(e,t,n,r){return nJ(t)||r.isEqual(es.min())?ew.resolve(null):this.ps.getDocuments(e,n).next(i=>{let s=this.Ds(t,i);return this.Cs(t,s,n,r)?ew.resolve(null):(I()<=u.$b.DEBUG&&T("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),n5(t)),this.vs(e,s,t,ec(r,-1)).next(e=>e))})}Ds(e,t){let n=new tP(n8(e));return t.forEach((t,r)=>{n6(e,r)&&(n=n.add(r))}),n}Cs(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;let i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(r)>0)}Ss(e,t,n){return I()<=u.$b.DEBUG&&T("QueryEngine","Using full collection scan to execute query:",n5(t)),this.ps.getDocumentsMatchingQuery(e,t,ef.min(),n)}vs(e,t,n,r){return this.ps.getDocumentsMatchingQuery(e,n,r).next(e=>(t.forEach(t=>{e=e.insert(t.key,t)}),e))}}let sK="LocalStore";class s${constructor(e,t,n,r){this.persistence=e,this.Fs=t,this.serializer=r,this.Ms=new tM(q),this.xs=new n9(e=>nz(e),nK),this.Os=new Map,this.Ns=e.getRemoteDocumentCache(),this.Pi=e.getTargetCache(),this.Ii=e.getBundleCache(),this.Bs(n)}Bs(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new sI(this.Ns,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ns.setIndexManager(this.indexManager),this.Fs.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",t=>e.collect(t,this.Ms))}}async function sG(e,t){return await e.persistence.runTransaction("Handle user change","readonly",n=>{let r;return e.mutationQueue.getAllMutationBatches(n).next(i=>(r=i,e.Bs(t),e.mutationQueue.getAllMutationBatches(n))).next(t=>{let i=[],s=[],a=ra();for(let e of r)for(let t of(i.push(e.batchId),e.mutations))a=a.add(t.key);for(let e of t)for(let t of(s.push(e.batchId),e.mutations))a=a.add(t.key);return e.localDocuments.getDocuments(n,a).next(e=>({Ls:e,removedBatchIds:i,addedBatchIds:s}))})})}function sj(e){return e.persistence.runTransaction("Get last remote snapshot version","readonly",t=>e.Pi.getLastRemoteSnapshotVersion(t))}function sQ(e,t,n){let r=ra(),i=ra();return n.forEach(e=>r=r.add(e)),t.getEntries(e,r).next(e=>{let r=n7;return n.forEach((n,s)=>{let a=e.get(n);s.isFoundDocument()!==a.isFoundDocument()&&(i=i.add(n)),s.isNoDocument()&&s.version.isEqual(es.min())?(t.removeEntry(n,s.readTime),r=r.insert(n,s)):!a.isValidDocument()||s.version.compareTo(a.version)>0||0===s.version.compareTo(a.version)&&a.hasPendingWrites?(t.addEntry(s),r=r.insert(n,s)):T(sK,"Ignoring outdated watch update for ",n,". Current version:",a.version," Watch version:",s.version)}),{ks:r,qs:i}})}function sW(e,t){return e.persistence.runTransaction("Allocate target","readwrite",n=>{let r;return e.Pi.getTargetData(n,t).next(i=>i?(r=i,ew.resolve(r)):e.Pi.allocateTargetId(n).next(i=>(r=new iI(t,i,"TargetPurposeListen",n.currentSequenceNumber),e.Pi.addTargetData(n,r).next(()=>r))))}).then(n=>{let r=e.Ms.get(n.targetId);return(null===r||n.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(e.Ms=e.Ms.insert(n.targetId,n),e.xs.set(t,n.targetId)),n})}async function sH(e,t,n){let r=e.Ms.get(t);try{n||await e.persistence.runTransaction("Release target",n?"readwrite":"readwrite-primary",t=>e.persistence.referenceDelegate.removeTarget(t,r))}catch(e){if(!eS(e))throw e;T(sK,`Failed to update sequence numbers for target ${t}: ${e}`)}e.Ms=e.Ms.remove(t),e.xs.delete(r.target)}function sJ(e,t,n){let r=es.min(),i=ra();return e.persistence.runTransaction("Execute query","readwrite",s=>(function(e,t,n){let r=e.xs.get(n);return void 0!==r?ew.resolve(e.Ms.get(r)):e.Pi.getTargetData(t,n)})(e,s,nZ(t)).next(t=>{if(t)return r=t.lastLimboFreeSnapshotVersion,e.Pi.getMatchingKeysForTargetId(s,t.targetId).next(e=>{i=e})}).next(()=>e.Fs.getDocumentsMatchingQuery(s,t,n?r:es.min(),n?i:ra())).next(n=>(sZ(e,n3(t),n),{documents:n,Qs:i})))}function sY(e,t){let n=e.Pi,r=e.Ms.get(t);return r?Promise.resolve(r.target):e.persistence.runTransaction("Get target data","readonly",e=>n.At(e,t).next(e=>e?e.target:null))}function sX(e,t){let n=e.Os.get(t)||es.min();return e.persistence.runTransaction("Get new document changes","readonly",r=>e.Ns.getAllFromCollectionGroup(r,t,ec(n,-1),Number.MAX_SAFE_INTEGER)).then(n=>(sZ(e,t,n),n))}function sZ(e,t,n){let r=e.Os.get(t)||es.min();n.forEach((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)}),e.Os.set(t,r)}async function s0(e,t,n,r){let i=ra(),s=n7;for(let e of n){let n=t.$s(e.metadata.name);e.document&&(i=i.add(n));let r=t.Us(e);r.setReadTime(t.Ks(e.metadata.readTime)),s=s.insert(n,r)}let a=e.Ns.newChangeBuffer({trackRemovals:!0}),o=await sW(e,nZ(nH(j.fromString(`__bundle__/docs/${r}`))));return e.persistence.runTransaction("Apply bundle documents","readwrite",t=>sQ(t,a,s).next(e=>(a.apply(t),e)).next(n=>e.Pi.removeMatchingKeysForTargetId(t,o.targetId).next(()=>e.Pi.addMatchingKeys(t,i,o.targetId)).next(()=>e.localDocuments.getLocalViewOfDocuments(t,n.ks,n.qs)).next(()=>n.ks)))}async function s1(e,t,n=ra()){let r=await sW(e,nZ(iC(t.bundledQuery)));return e.persistence.runTransaction("Save named query","readwrite",i=>{let s=r9(t.readTime);if(r.snapshotVersion.compareTo(s)>=0)return e.Ii.saveNamedQuery(i,t);let a=r.withResumeToken(tz.EMPTY_BYTE_STRING,s);return e.Ms=e.Ms.insert(a.targetId,a),e.Pi.updateTargetData(i,a).next(()=>e.Pi.removeMatchingKeysForTargetId(i,r.targetId)).next(()=>e.Pi.addMatchingKeys(i,n,r.targetId)).next(()=>e.Ii.saveNamedQuery(i,t))})}let s2="firestore_clients";function s4(e,t){return`${s2}_${e}_${t}`}let s5="firestore_mutations";function s6(e,t,n){let r=`${s5}_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}let s3="firestore_targets";function s8(e,t){return`${s3}_${e}_${t}`}let s9="SharedClientState";class s7{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ws(e,t,n){let r=JSON.parse(n),i,s="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return s&&r.error&&(s="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(i=new C(r.error.code,r.error.message)),s?new s7(e,t,r.state,i):(E(s9,`Failed to parse mutation state for ID '${t}': ${n}`),null)}Gs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class ae{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ws(e,t){let n=JSON.parse(t),r,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new C(n.error.code,n.error.message)),i?new ae(e,n.state,r):(E(s9,`Failed to parse target state for ID '${e}': ${t}`),null)}Gs(){let e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class at{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ws(e,t){let n=JSON.parse(t),r="object"==typeof n&&n.activeTargetIds instanceof Array,i=ro;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=eF(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return r?new at(e,i):(E(s9,`Failed to parse client data for instance '${e}': ${t}`),null)}}class an{constructor(e,t){this.clientId=e,this.onlineState=t}static Ws(e){let t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new an(t.clientId,t.onlineState):(E(s9,`Failed to parse online state: ${e}`),null)}}class ar{constructor(){this.activeTargetIds=ro}zs(e){this.activeTargetIds=this.activeTargetIds.add(e)}js(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Gs(){return JSON.stringify({activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()})}}class ai{constructor(e,t,n,r,i){var s,a,o;this.window=e,this.Mi=t,this.persistenceKey=n,this.Js=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.Hs=this.Ys.bind(this),this.Zs=new tM(q),this.started=!1,this.Xs=[];let l=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.eo=s4(this.persistenceKey,this.Js),this.no=(s=this.persistenceKey,`firestore_sequence_number_${s}`),this.Zs=this.Zs.insert(this.Js,new ar),this.ro=RegExp(`^${s2}_${l}_([^_]*)$`),this.io=RegExp(`^${s5}_${l}_(\\d+)(?:_(.*))?$`),this.so=RegExp(`^${s3}_${l}_(\\d+)$`),this.oo=(a=this.persistenceKey,`firestore_online_state_${a}`),this._o=(o=this.persistenceKey,`firestore_bundle_loaded_v2_${o}`),this.window.addEventListener("storage",this.Hs)}static v(e){return!(!e||!e.localStorage)}async start(){for(let e of(await this.syncEngine.Ts())){if(e===this.Js)continue;let t=this.getItem(s4(this.persistenceKey,e));if(t){let n=at.Ws(e,t);n&&(this.Zs=this.Zs.insert(n.clientId,n))}}this.ao();let e=this.storage.getItem(this.oo);if(e){let t=this.uo(e);t&&this.co(t)}for(let e of this.Xs)this.Ys(e);this.Xs=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.no,JSON.stringify(e))}getAllActiveQueryTargets(){return this.lo(this.Zs)}isActiveQueryTarget(e){let t=!1;return this.Zs.forEach((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)}),t}addPendingMutation(e){this.ho(e,"pending")}updateMutationState(e,t,n){this.ho(e,t,n),this.Po(e)}addLocalQueryTarget(e,t=!0){let n="not-current";if(this.isActiveQueryTarget(e)){let t=this.storage.getItem(s8(this.persistenceKey,e));if(t){let r=ae.Ws(e,t);r&&(n=r.state)}}return t&&this.To.zs(e),this.ao(),n}removeLocalQueryTarget(e){this.To.js(e),this.ao()}isLocalQueryTarget(e){return this.To.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(s8(this.persistenceKey,e))}updateQueryState(e,t,n){this.Io(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Po(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.Eo(e)}notifyBundleLoaded(e){this.Ao(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.Hs),this.removeItem(this.eo),this.started=!1)}getItem(e){let t=this.storage.getItem(e);return T(s9,"READ",e,t),t}setItem(e,t){T(s9,"SET",e,t),this.storage.setItem(e,t)}removeItem(e){T(s9,"REMOVE",e),this.storage.removeItem(e)}Ys(e){if(e.storageArea===this.storage){if(T(s9,"EVENT",e.key,e.newValue),e.key===this.eo)return void E("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.Mi.enqueueRetryable(async()=>{if(this.started){if(null!==e.key){if(this.ro.test(e.key)){if(null==e.newValue){let t=this.Ro(e.key);return this.Vo(t,null)}{let t=this.mo(e.key,e.newValue);if(t)return this.Vo(t.clientId,t)}}else if(this.io.test(e.key)){if(null!==e.newValue){let t=this.fo(e.key,e.newValue);if(t)return this.po(t)}}else if(this.so.test(e.key)){if(null!==e.newValue){let t=this.yo(e.key,e.newValue);if(t)return this.wo(t)}}else if(e.key===this.oo){if(null!==e.newValue){let t=this.uo(e.newValue);if(t)return this.co(t)}}else if(e.key===this.no){let t=function(e){let t=eR.ce;if(null!=e)try{let n=JSON.parse(e);N("number"==typeof n,30636,{So:e}),t=n}catch(e){E(s9,"Failed to read sequence number from WebStorage",e)}return t}(e.newValue);t!==eR.ce&&this.sequenceNumberHandler(t)}else if(e.key===this._o){let t=this.bo(e.newValue);await Promise.all(t.map(e=>this.syncEngine.Do(e)))}}}else this.Xs.push(e)})}}get To(){return this.Zs.get(this.Js)}ao(){this.setItem(this.eo,this.To.Gs())}ho(e,t,n){let r=new s7(this.currentUser,e,t,n),i=s6(this.persistenceKey,this.currentUser,e);this.setItem(i,r.Gs())}Po(e){let t=s6(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Eo(e){let t={clientId:this.Js,onlineState:e};this.storage.setItem(this.oo,JSON.stringify(t))}Io(e,t,n){let r=s8(this.persistenceKey,e),i=new ae(e,t,n);this.setItem(r,i.Gs())}Ao(e){let t=JSON.stringify(Array.from(e));this.setItem(this._o,t)}Ro(e){let t=this.ro.exec(e);return t?t[1]:null}mo(e,t){let n=this.Ro(e);return at.Ws(n,t)}fo(e,t){let n=this.io.exec(e),r=Number(n[1]),i=void 0!==n[2]?n[2]:null;return s7.Ws(new y(i),r,t)}yo(e,t){let n=Number(this.so.exec(e)[1]);return ae.Ws(n,t)}uo(e){return an.Ws(e)}bo(e){return JSON.parse(e)}async po(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Co(e.batchId,e.state,e.error);T(s9,`Ignoring mutation for non-active user ${e.user.uid}`)}wo(e){return this.syncEngine.vo(e.targetId,e.state,e.error)}Vo(e,t){let n=t?this.Zs.insert(e,t):this.Zs.remove(e),r=this.lo(this.Zs),i=this.lo(n),s=[],a=[];return i.forEach(e=>{r.has(e)||s.push(e)}),r.forEach(e=>{i.has(e)||a.push(e)}),this.syncEngine.Fo(s,a).then(()=>{this.Zs=n})}co(e){this.Zs.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}lo(e){let t=ro;return e.forEach((e,n)=>{t=t.unionWith(n.activeTargetIds)}),t}}class as{constructor(){this.Mo=new ar,this.xo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e,t=!0){return t&&this.Mo.zs(e),this.xo[e]||"not-current"}updateQueryState(e,t,n){this.xo[e]=t}removeLocalQueryTarget(e){this.Mo.js(e)}isLocalQueryTarget(e){return this.Mo.activeTargetIds.has(e)}clearQueryState(e){delete this.xo[e]}getAllActiveQueryTargets(){return this.Mo.activeTargetIds}isActiveQueryTarget(e){return this.Mo.activeTargetIds.has(e)}start(){return this.Mo=new ar,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class aa{Oo(e){}shutdown(){}}let ao="ConnectivityMonitor";class al{constructor(){this.No=()=>this.Bo(),this.Lo=()=>this.ko(),this.qo=[],this.Qo()}Oo(e){this.qo.push(e)}shutdown(){window.removeEventListener("online",this.No),window.removeEventListener("offline",this.Lo)}Qo(){window.addEventListener("online",this.No),window.addEventListener("offline",this.Lo)}Bo(){for(let e of(T(ao,"Network connectivity changed: AVAILABLE"),this.qo))e(0)}ko(){for(let e of(T(ao,"Network connectivity changed: UNAVAILABLE"),this.qo))e(1)}static v(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let au=null;function ah(){return null===au?au=0x10000000+Math.round(0x80000000*Math.random()):au++,"0x"+au.toString(16)}let ac="RestConnection",ad={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class af{get $o(){return!1}constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;let t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.Uo=t+"://"+e.host,this.Ko=`projects/${n}/databases/${r}`,this.Wo=this.databaseId.database===t1?`project_id=${n}`:`project_id=${n}&database_id=${r}`}Go(e,t,n,r,i){let s=ah(),a=this.zo(e,t.toUriEncodedString());T(ac,`Sending RPC '${e}' ${s}:`,a,n);let o={"google-cloud-resource-prefix":this.Ko,"x-goog-request-params":this.Wo};this.jo(o,r,i);let{host:l}=new URL(a),u=(0,h.zJ)(l);return this.Jo(e,a,o,n,u).then(t=>(T(ac,`Received RPC '${e}' ${s}: `,t),t),t=>{throw b(ac,`RPC '${e}' ${s} failed with error: `,t,"url: ",a,"request:",n),t})}Ho(e,t,n,r,i,s){return this.Go(e,t,n,r,i)}jo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+w,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach((t,n)=>e[n]=t),n&&n.headers.forEach((t,n)=>e[n]=t)}zo(e,t){let n=ad[e];return`${this.Uo}/v1/${t}:${n}`}terminate(){}}class am{constructor(e){this.Yo=e.Yo,this.Zo=e.Zo}Xo(e){this.e_=e}t_(e){this.n_=e}r_(e){this.i_=e}onMessage(e){this.s_=e}close(){this.Zo()}send(e){this.Yo(e)}o_(){this.e_()}__(){this.n_()}a_(e){this.i_(e)}u_(e){this.s_(e)}}let ag="WebChannelConnection";class ap extends af{constructor(e){super(e),this.c_=[],this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Jo(e,t,n,r,i){let s=ah();return new Promise((i,a)=>{let o=new d.ZS;o.setWithCredentials(!0),o.listenOnce(d.Bx.COMPLETE,()=>{try{switch(o.getLastErrorCode()){case d.O4.NO_ERROR:let t=o.getResponseJson();T(ag,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case d.O4.TIMEOUT:T(ag,`RPC '${e}' ${s} timed out`),a(new C(D.DEADLINE_EXCEEDED,"Request time out"));break;case d.O4.HTTP_ERROR:let n=o.getStatus();if(T(ag,`RPC '${e}' ${s} failed with status:`,n,"response text:",o.getResponseText()),n>0){let e=o.getResponseJson();Array.isArray(e)&&(e=e[0]);let t=e?.error;if(t&&t.status&&t.message){let e=function(e){let t=e.toLowerCase().replace(/_/g,"-");return Object.values(D).indexOf(t)>=0?t:D.UNKNOWN}(t.status);a(new C(e,t.message))}else a(new C(D.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new C(D.UNAVAILABLE,"Connection failed."));break;default:S(9055,{l_:e,streamId:s,h_:o.getLastErrorCode(),P_:o.getLastError()})}}finally{T(ag,`RPC '${e}' ${s} completed.`)}});let l=JSON.stringify(r);T(ag,`RPC '${e}' ${s} sending request:`,r),o.send(t,"POST",l,n,15)})}T_(e,t,n){let i=ah(),s=[this.Uo,"/","google.firestore.v1.Firestore","/",e,"/channel"],a=(0,d.fF)(),o=(0,d.Ao)(),l={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(l.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(l.useFetchStreams=!0),this.jo(l.initMessageHeaders,t,n),l.encodeInitMessageHeaders=!0;let h=s.join("");T(ag,`Creating RPC '${e}' stream ${i}: ${h}`,l);let c=a.createWebChannel(h,l);this.I_(c);let f=!1,m=!1,g=new am({Yo:t=>{m?T(ag,`Not sending because RPC '${e}' stream ${i} is closed:`,t):(f||(T(ag,`Opening RPC '${e}' stream ${i} transport.`),c.open(),f=!0),T(ag,`RPC '${e}' stream ${i} sending:`,t),c.send(t))},Zo:()=>c.close()}),p=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return p(c,d.iO.EventType.OPEN,()=>{m||(T(ag,`RPC '${e}' stream ${i} transport opened.`),g.o_())}),p(c,d.iO.EventType.CLOSE,()=>{m||(m=!0,T(ag,`RPC '${e}' stream ${i} transport closed`),g.a_(),this.E_(c))}),p(c,d.iO.EventType.ERROR,t=>{m||(m=!0,b(ag,`RPC '${e}' stream ${i} transport errored. Name:`,t.name,"Message:",t.message),g.a_(new C(D.UNAVAILABLE,"The operation could not be completed")))}),p(c,d.iO.EventType.MESSAGE,t=>{if(!m){let n=t.data[0];N(!!n,16349);let s=n?.error||n[0]?.error;if(s){T(ag,`RPC '${e}' stream ${i} received error:`,s);let t=s.status,n=function(e){let t=r[e];if(void 0!==t)return rq(t)}(t),a=s.message;void 0===n&&(n=D.INTERNAL,a="Unknown error status: "+t+" with message "+s.message),m=!0,g.a_(new C(n,a)),c.close()}else T(ag,`RPC '${e}' stream ${i} received:`,n),g.u_(n)}}),p(o,d.Jh.STAT_EVENT,t=>{t.stat===d.ro.PROXY?T(ag,`RPC '${e}' stream ${i} detected buffering proxy`):t.stat===d.ro.NOPROXY&&T(ag,`RPC '${e}' stream ${i} detected no buffering proxy`)}),setTimeout(()=>{g.__()},0),g}terminate(){this.c_.forEach(e=>e.close()),this.c_=[]}I_(e){this.c_.push(e)}E_(e){this.c_=this.c_.filter(t=>t===e)}}function ay(){return"undefined"!=typeof window?window:null}function aw(){return"undefined"!=typeof document?document:null}function av(e){return new r5(e,!0)}class aI{constructor(e,t,n=1e3,r=1.5,i=6e4){this.Mi=e,this.timerId=t,this.d_=n,this.A_=r,this.R_=i,this.V_=0,this.m_=null,this.f_=Date.now(),this.reset()}reset(){this.V_=0}g_(){this.V_=this.R_}p_(e){this.cancel();let t=Math.floor(this.V_+this.y_()),n=Math.max(0,Date.now()-this.f_),r=Math.max(0,t-n);r>0&&T("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.V_} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.m_=this.Mi.enqueueAfterDelay(this.timerId,r,()=>(this.f_=Date.now(),e())),this.V_*=this.A_,this.V_<this.d_&&(this.V_=this.d_),this.V_>this.R_&&(this.V_=this.R_)}w_(){null!==this.m_&&(this.m_.skipDelay(),this.m_=null)}cancel(){null!==this.m_&&(this.m_.cancel(),this.m_=null)}y_(){return(Math.random()-.5)*this.V_}}let aT="PersistentStream";class aE{constructor(e,t,n,r,i,s,a,o){this.Mi=e,this.S_=n,this.b_=r,this.connection=i,this.authCredentialsProvider=s,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.D_=0,this.C_=null,this.v_=null,this.stream=null,this.F_=0,this.M_=new aI(e,t)}x_(){return 1===this.state||5===this.state||this.O_()}O_(){return 2===this.state||3===this.state}start(){this.F_=0,4!==this.state?this.auth():this.N_()}async stop(){this.x_()&&await this.close(0)}B_(){this.state=0,this.M_.reset()}L_(){this.O_()&&null===this.C_&&(this.C_=this.Mi.enqueueAfterDelay(this.S_,6e4,()=>this.k_()))}q_(e){this.Q_(),this.stream.send(e)}async k_(){if(this.O_())return this.close(0)}Q_(){this.C_&&(this.C_.cancel(),this.C_=null)}U_(){this.v_&&(this.v_.cancel(),this.v_=null)}async close(e,t){this.Q_(),this.U_(),this.M_.cancel(),this.D_++,4!==e?this.M_.reset():t&&t.code===D.RESOURCE_EXHAUSTED?(E(t.toString()),E("Using maximum backoff delay to prevent overloading the backend."),this.M_.g_()):t&&t.code===D.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.K_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.r_(t)}K_(){}auth(){this.state=1;let e=this.W_(this.D_),t=this.D_;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,n])=>{this.D_===t&&this.G_(e,n)},t=>{e(()=>{let e=new C(D.UNKNOWN,"Fetching auth token failed: "+t.message);return this.z_(e)})})}G_(e,t){let n=this.W_(this.D_);this.stream=this.j_(e,t),this.stream.Xo(()=>{n(()=>this.listener.Xo())}),this.stream.t_(()=>{n(()=>(this.state=2,this.v_=this.Mi.enqueueAfterDelay(this.b_,1e4,()=>(this.O_()&&(this.state=3),Promise.resolve())),this.listener.t_()))}),this.stream.r_(e=>{n(()=>this.z_(e))}),this.stream.onMessage(e=>{n(()=>1==++this.F_?this.J_(e):this.onNext(e))})}N_(){this.state=5,this.M_.p_(async()=>{this.state=0,this.start()})}z_(e){return T(aT,`close with error: ${e}`),this.stream=null,this.close(4,e)}W_(e){return t=>{this.Mi.enqueueAndForget(()=>this.D_===e?t():(T(aT,"stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class ab extends aE{constructor(e,t,n,r,i,s){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}j_(e,t){return this.connection.T_("Listen",e,t)}J_(e){return this.onNext(e)}onNext(e){this.M_.reset();let t=function(e,t){let n;if("targetChange"in t){var r,i;t.targetChange;let s="NO_CHANGE"===(r=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===r?1:"REMOVE"===r?2:"CURRENT"===r?3:"RESET"===r?4:S(39313,{state:r}),a=t.targetChange.targetIds||[],o=(i=t.targetChange.resumeToken,e.useProto3Json?(N(void 0===i||"string"==typeof i,58123),tz.fromBase64String(i||"")):(N(void 0===i||i instanceof m||i instanceof Uint8Array,16193),tz.fromUint8Array(i||new Uint8Array))),l=t.targetChange.cause;n=new rJ(s,a,o,l&&new C(void 0===l.code?D.UNKNOWN:rq(l.code),l.message||"")||null)}else if("documentChange"in t){t.documentChange;let r=t.documentChange;r.document,r.document.name,r.document.updateTime;let i=ii(e,r.document.name),s=r9(r.document.updateTime),a=r.document.createTime?r9(r.document.createTime):es.min(),o=new nw({mapValue:{fields:r.document.fields}}),l=nv.newFoundDocument(i,s,a,o);n=new rW(r.targetIds||[],r.removedTargetIds||[],l.key,l)}else if("documentDelete"in t){t.documentDelete;let r=t.documentDelete;r.document;let i=ii(e,r.document),s=r.readTime?r9(r.readTime):es.min(),a=nv.newNoDocument(i,s);n=new rW([],r.removedTargetIds||[],a.key,a)}else if("documentRemove"in t){t.documentRemove;let r=t.documentRemove;r.document;let i=ii(e,r.document);n=new rW([],r.removedTargetIds||[],i,null)}else{if(!("filter"in t))return S(11601,{Rt:t});{t.filter;let e=t.filter;e.targetId;let{count:r=0,unchangedNames:i}=e,s=new rU(r,i);n=new rH(e.targetId,s)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return es.min();let t=e.targetChange;return t.targetIds&&t.targetIds.length?es.min():t.readTime?r9(t.readTime):es.min()}(e);return this.listener.H_(t,n)}Y_(e){let t={};t.database=io(this.serializer),t.addTarget=function(e,t){let n;let r=t.target;if((n=n$(r)?{documents:im(e,r)}:{query:ig(e,r).ft}).targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=r8(e,t.resumeToken);let r=r6(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(es.min())>0){n.readTime=r3(e,t.snapshotVersion.toTimestamp());let r=r6(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);let n=function(e,t){let n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return S(28987,{purpose:e})}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.q_(t)}Z_(e){let t={};t.database=io(this.serializer),t.removeTarget=e,this.q_(t)}}class a_ extends aE{constructor(e,t,n,r,i,s){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,s),this.serializer=i}get X_(){return this.F_>0}start(){this.lastStreamToken=void 0,super.start()}K_(){this.X_&&this.ea([])}j_(e,t){return this.connection.T_("Write",e,t)}J_(e){return N(!!e.streamToken,31322),this.lastStreamToken=e.streamToken,N(!e.writeResults||0===e.writeResults.length,55816),this.listener.ta()}onNext(e){var t,n;N(!!e.streamToken,12678),this.lastStreamToken=e.streamToken,this.M_.reset();let r=(t=e.writeResults,n=e.commitTime,t&&t.length>0?(N(void 0!==n,14353),t.map(e=>{let t;return(t=e.updateTime?r9(e.updateTime):r9(n)).isEqual(es.min())&&(t=r9(n)),new rE(t,e.transformResults||[])})):[]),i=r9(e.commitTime);return this.listener.na(i,r)}ra(){let e={};e.database=io(this.serializer),this.q_(e)}ea(e){let t={streamToken:this.lastStreamToken,writes:e.map(e=>ic(this.serializer,e))};this.q_(t)}}class aS{}class ax extends aS{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.ia=!1}sa(){if(this.ia)throw new C(D.FAILED_PRECONDITION,"The client has already been terminated.")}Go(e,t,n,r){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([i,s])=>this.connection.Go(e,ie(t,n),r,i,s)).catch(e=>{throw"FirebaseError"===e.name?(e.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new C(D.UNKNOWN,e.toString())})}Ho(e,t,n,r,i){return this.sa(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([s,a])=>this.connection.Ho(e,ie(t,n),r,s,a,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===D.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new C(D.UNKNOWN,e.toString())})}terminate(){this.ia=!0,this.connection.terminate()}}class aN{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.oa=0,this._a=null,this.aa=!0}ua(){0===this.oa&&(this.ca("Unknown"),this._a=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this._a=null,this.la("Backend didn't respond within 10 seconds."),this.ca("Offline"),Promise.resolve())))}ha(e){"Online"===this.state?this.ca("Unknown"):(this.oa++,this.oa>=1&&(this.Pa(),this.la(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ca("Offline")))}set(e){this.Pa(),this.oa=0,"Online"===e&&(this.aa=!1),this.ca(e)}ca(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}la(e){let t=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.aa?(E(t),this.aa=!1):T("OnlineStateTracker",t)}Pa(){null!==this._a&&(this._a.cancel(),this._a=null)}}let aD="RemoteStore";class aC{constructor(e,t,n,r,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Ta=[],this.Ia=new Map,this.Ea=new Set,this.da=[],this.Aa=i,this.Aa.Oo(e=>{n.enqueueAndForget(async()=>{aL(this)&&(T(aD,"Restarting streams for network reachability change."),await async function(e){e.Ea.add(4),await ak(e),e.Ra.set("Unknown"),e.Ea.delete(4),await aA(e)}(this))})}),this.Ra=new aN(n,r)}}async function aA(e){if(aL(e))for(let t of e.da)await t(!0)}async function ak(e){for(let t of e.da)await t(!1)}function aV(e,t){e.Ia.has(t.targetId)||(e.Ia.set(t.targetId,t),aP(e)?aF(e):a0(e).O_()&&aM(e,t))}function aR(e,t){let n=a0(e);e.Ia.delete(t),n.O_()&&aO(e,t),0===e.Ia.size&&(n.O_()?n.L_():aL(e)&&e.Ra.set("Unknown"))}function aM(e,t){if(e.Va.Ue(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(es.min())>0){let n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}a0(e).Y_(t)}function aO(e,t){e.Va.Ue(t),a0(e).Z_(t)}function aF(e){e.Va=new rX({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),At:t=>e.Ia.get(t)||null,ht:()=>e.datastore.serializer.databaseId}),a0(e).start(),e.Ra.ua()}function aP(e){return aL(e)&&!a0(e).x_()&&e.Ia.size>0}function aL(e){return 0===e.Ea.size}async function aU(e){e.Ra.set("Online")}async function aq(e){e.Ia.forEach((t,n)=>{aM(e,t)})}async function aB(e,t){e.Va=void 0,aP(e)?(e.Ra.ha(t),aF(e)):e.Ra.set("Unknown")}async function az(e,t,n){if(e.Ra.set("Online"),t instanceof rJ&&2===t.state&&t.cause)try{await async function(e,t){let n=t.cause;for(let r of t.targetIds)e.Ia.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.Ia.delete(r),e.Va.removeTarget(r))}(e,t)}catch(n){T(aD,"Failed to remove targets %s: %s ",t.targetIds.join(","),n),await aK(e,n)}else if(t instanceof rW?e.Va.Ze(t):t instanceof rH?e.Va.st(t):e.Va.tt(t),!n.isEqual(es.min()))try{let t=await sj(e.localStore);n.compareTo(t)>=0&&await function(e,t){let n=e.Va.Tt(t);return n.targetChanges.forEach((n,r)=>{if(n.resumeToken.approximateByteSize()>0){let i=e.Ia.get(r);i&&e.Ia.set(r,i.withResumeToken(n.resumeToken,t))}}),n.targetMismatches.forEach((t,n)=>{let r=e.Ia.get(t);if(!r)return;e.Ia.set(t,r.withResumeToken(tz.EMPTY_BYTE_STRING,r.snapshotVersion)),aO(e,t);let i=new iI(r.target,t,n,r.sequenceNumber);aM(e,i)}),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){T(aD,"Failed to raise snapshot:",t),await aK(e,t)}}async function aK(e,t,n){if(!eS(t))throw t;e.Ea.add(1),await ak(e),e.Ra.set("Offline"),n||(n=()=>sj(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{T(aD,"Retrying IndexedDB access"),await n(),e.Ea.delete(1),await aA(e)})}function a$(e,t){return t().catch(n=>aK(e,n,t))}async function aG(e){let t=a1(e),n=e.Ta.length>0?e.Ta[e.Ta.length-1].batchId:-1;for(;aL(e)&&e.Ta.length<10;)try{let r=await function(e,t){return e.persistence.runTransaction("Get next mutation batch","readonly",n=>(void 0===t&&(t=-1),e.mutationQueue.getNextMutationBatchAfterBatchId(n,t)))}(e.localStore,n);if(null===r){0===e.Ta.length&&t.L_();break}n=r.batchId,function(e,t){e.Ta.push(t);let n=a1(e);n.O_()&&n.X_&&n.ea(t.mutations)}(e,r)}catch(t){await aK(e,t)}aj(e)&&aQ(e)}function aj(e){return aL(e)&&!a1(e).x_()&&e.Ta.length>0}function aQ(e){a1(e).start()}async function aW(e){a1(e).ra()}async function aH(e){let t=a1(e);for(let n of e.Ta)t.ea(n.mutations)}async function aJ(e,t,n){let r=e.Ta.shift(),i=rP.from(r,t,n);await a$(e,()=>e.remoteSyncer.applySuccessfulWrite(i)),await aG(e)}async function aY(e,t){t&&a1(e).X_&&await async function(e,t){var n;if(function(e){switch(e){case D.OK:return S(64938);case D.CANCELLED:case D.UNKNOWN:case D.DEADLINE_EXCEEDED:case D.RESOURCE_EXHAUSTED:case D.INTERNAL:case D.UNAVAILABLE:case D.UNAUTHENTICATED:return!1;case D.INVALID_ARGUMENT:case D.NOT_FOUND:case D.ALREADY_EXISTS:case D.PERMISSION_DENIED:case D.FAILED_PRECONDITION:case D.ABORTED:case D.OUT_OF_RANGE:case D.UNIMPLEMENTED:case D.DATA_LOSS:return!0;default:return S(15467,{code:e})}}(n=t.code)&&n!==D.ABORTED){let n=e.Ta.shift();a1(e).B_(),await a$(e,()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t)),await aG(e)}}(e,t),aj(e)&&aQ(e)}async function aX(e,t){e.asyncQueue.verifyOperationInProgress(),T(aD,"RemoteStore received new credentials");let n=aL(e);e.Ea.add(3),await ak(e),n&&e.Ra.set("Unknown"),await e.remoteSyncer.handleCredentialChange(t),e.Ea.delete(3),await aA(e)}async function aZ(e,t){t?(e.Ea.delete(2),await aA(e)):t||(e.Ea.add(2),await ak(e),e.Ra.set("Unknown"))}function a0(e){var t,n,r;return e.ma||(e.ma=(t=e.datastore,n=e.asyncQueue,r={Xo:aU.bind(null,e),t_:aq.bind(null,e),r_:aB.bind(null,e),H_:az.bind(null,e)},t.sa(),new ab(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.da.push(async t=>{t?(e.ma.B_(),aP(e)?aF(e):e.Ra.set("Unknown")):(await e.ma.stop(),e.Va=void 0)})),e.ma}function a1(e){var t,n,r;return e.fa||(e.fa=(t=e.datastore,n=e.asyncQueue,r={Xo:()=>Promise.resolve(),t_:aW.bind(null,e),r_:aY.bind(null,e),ta:aH.bind(null,e),na:aJ.bind(null,e)},t.sa(),new a_(n,t.connection,t.authCredentials,t.appCheckCredentials,t.serializer,r)),e.da.push(async t=>{t?(e.fa.B_(),await aG(e)):(await e.fa.stop(),e.Ta.length>0&&(T(aD,`Stopping write stream with ${e.Ta.length} pending writes`),e.Ta=[]))})),e.fa}class a2{constructor(e,t,n,r,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=i,this.deferred=new A,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,i){let s=new a2(e,t,Date.now()+n,r,i);return s.start(n),s}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new C(D.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function a4(e,t){if(E("AsyncQueue",`${t}: ${e}`),eS(e))return new C(D.UNAVAILABLE,`${t}: ${e}`);throw e}class a5{static emptySet(e){return new a5(e.comparator)}constructor(e){this.comparator=e?(t,n)=>e(t,n)||H.comparator(t.key,n.key):(e,t)=>H.comparator(e.key,t.key),this.keyedMap=rt(),this.sortedSet=new tM(this.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){let t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal((t,n)=>(e(t),!1))}add(e){let t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){let t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof a5)||this.size!==e.size)return!1;let t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){let e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){let e=[];return this.forEach(t=>{e.push(t.toString())}),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){let n=new a5;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class a6{constructor(){this.ga=new tM(H.comparator)}track(e){let t=e.doc.key,n=this.ga.get(t);n?0!==e.type&&3===n.type?this.ga=this.ga.insert(t,e):3===e.type&&1!==n.type?this.ga=this.ga.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.ga=this.ga.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.ga=this.ga.remove(t):1===e.type&&2===n.type?this.ga=this.ga.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.ga=this.ga.insert(t,{type:2,doc:e.doc}):S(63341,{Rt:e,pa:n}):this.ga=this.ga.insert(t,e)}ya(){let e=[];return this.ga.inorderTraversal((t,n)=>{e.push(n)}),e}}class a3{constructor(e,t,n,r,i,s,a,o,l){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=i,this.fromCache=s,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=l}static fromInitialDocuments(e,t,n,r,i){let s=[];return t.forEach(e=>{s.push({type:0,doc:e})}),new a3(e,t,a5.emptySet(t),s,n,r,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&n2(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;let t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class a8{constructor(){this.wa=void 0,this.Sa=[]}ba(){return this.Sa.some(e=>e.Da())}}class a9{constructor(){this.queries=a7(),this.onlineState="Unknown",this.Ca=new Set}terminate(){!function(e,t){let n=e.queries;e.queries=a7(),n.forEach((e,n)=>{for(let e of n.Sa)e.onError(t)})}(this,new C(D.ABORTED,"Firestore shutting down"))}}function a7(){return new n9(e=>n4(e),n2)}async function oe(e,t){let n=3,r=t.query,i=e.queries.get(r);i?!i.ba()&&t.Da()&&(n=2):(i=new a8,n=t.Da()?0:1);try{switch(n){case 0:i.wa=await e.onListen(r,!0);break;case 1:i.wa=await e.onListen(r,!1);break;case 2:await e.onFirstRemoteStoreListen(r)}}catch(n){let e=a4(n,`Initialization of query '${n5(t.query)}' failed`);return void t.onError(e)}e.queries.set(r,i),i.Sa.push(t),t.va(e.onlineState),i.wa&&t.Fa(i.wa)&&oi(e)}async function ot(e,t){let n=t.query,r=3,i=e.queries.get(n);if(i){let e=i.Sa.indexOf(t);e>=0&&(i.Sa.splice(e,1),0===i.Sa.length?r=t.Da()?0:1:!i.ba()&&t.Da()&&(r=2))}switch(r){case 0:return e.queries.delete(n),e.onUnlisten(n,!0);case 1:return e.queries.delete(n),e.onUnlisten(n,!1);case 2:return e.onLastRemoteStoreUnlisten(n);default:return}}function on(e,t){let n=!1;for(let r of t){let t=r.query,i=e.queries.get(t);if(i){for(let e of i.Sa)e.Fa(r)&&(n=!0);i.wa=r}}n&&oi(e)}function or(e,t,n){let r=e.queries.get(t);if(r)for(let e of r.Sa)e.onError(n);e.queries.delete(t)}function oi(e){e.Ca.forEach(e=>{e.next()})}(a=s||(s={})).Ma="default",a.Cache="cache";class os{constructor(e,t,n){this.query=e,this.xa=t,this.Oa=!1,this.Na=null,this.onlineState="Unknown",this.options=n||{}}Fa(e){if(!this.options.includeMetadataChanges){let t=[];for(let n of e.docChanges)3!==n.type&&t.push(n);e=new a3(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Oa?this.Ba(e)&&(this.xa.next(e),t=!0):this.La(e,this.onlineState)&&(this.ka(e),t=!0),this.Na=e,t}onError(e){this.xa.error(e)}va(e){this.onlineState=e;let t=!1;return this.Na&&!this.Oa&&this.La(this.Na,e)&&(this.ka(this.Na),t=!0),t}La(e,t){return!(e.fromCache&&this.Da())||(!this.options.qa||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Ba(e){if(e.docChanges.length>0)return!0;let t=this.Na&&this.Na.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}ka(e){e=a3.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Oa=!0,this.xa.next(e)}Da(){return this.options.source!==s.Cache}}class oa{constructor(e,t){this.Qa=e,this.byteLength=t}$a(){return"metadata"in this.Qa}}class oo{constructor(e){this.serializer=e}$s(e){return ii(this.serializer,e)}Us(e){return e.metadata.exists?ih(this.serializer,e.document,!1):nv.newNoDocument(this.$s(e.metadata.name),this.Ks(e.metadata.readTime))}Ks(e){return r9(e)}}class ol{constructor(e){this.key=e}}class ou{constructor(e){this.key=e}}class oh{constructor(e,t){this.query=e,this.Ya=t,this.Za=null,this.hasCachedResults=!1,this.current=!1,this.Xa=ra(),this.mutatedKeys=ra(),this.eu=n8(e),this.tu=new a5(this.eu)}get nu(){return this.Ya}ru(e,t){let n=t?t.iu:new a6,r=t?t.tu:this.tu,i=t?t.mutatedKeys:this.mutatedKeys,s=r,a=!1,o="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,l="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal((e,t)=>{let u=r.get(e),h=n6(this.query,t)?t:null,c=!!u&&this.mutatedKeys.has(u.key),d=!!h&&(h.hasLocalMutations||this.mutatedKeys.has(h.key)&&h.hasCommittedMutations),f=!1;u&&h?u.data.isEqual(h.data)?c!==d&&(n.track({type:3,doc:h}),f=!0):this.su(u,h)||(n.track({type:2,doc:h}),f=!0,(o&&this.eu(h,o)>0||l&&0>this.eu(h,l))&&(a=!0)):!u&&h?(n.track({type:0,doc:h}),f=!0):u&&!h&&(n.track({type:1,doc:u}),f=!0,(o||l)&&(a=!0)),f&&(h?(s=s.add(h),i=d?i.add(e):i.delete(e)):(s=s.delete(e),i=i.delete(e)))}),null!==this.query.limit)for(;s.size>this.query.limit;){let e="F"===this.query.limitType?s.last():s.first();s=s.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{tu:s,iu:n,Cs:a,mutatedKeys:i}}su(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){let i=this.tu;this.tu=e.tu,this.mutatedKeys=e.mutatedKeys;let s=e.iu.ya();s.sort((e,t)=>(function(e,t){let n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return S(20277,{Rt:e})}};return n(e)-n(t)})(e.type,t.type)||this.eu(e.doc,t.doc)),this.ou(n),r=r??!1;let a=t&&!r?this._u():[],o=0===this.Xa.size&&this.current&&!r?1:0,l=o!==this.Za;return(this.Za=o,0!==s.length||l)?{snapshot:new a3(this.query,e.tu,i,s,e.mutatedKeys,0===o,l,!1,!!n&&n.resumeToken.approximateByteSize()>0),au:a}:{au:a}}va(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({tu:this.tu,iu:new a6,mutatedKeys:this.mutatedKeys,Cs:!1},!1)):{au:[]}}uu(e){return!this.Ya.has(e)&&!!this.tu.has(e)&&!this.tu.get(e).hasLocalMutations}ou(e){e&&(e.addedDocuments.forEach(e=>this.Ya=this.Ya.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Ya=this.Ya.delete(e)),this.current=e.current)}_u(){if(!this.current)return[];let e=this.Xa;this.Xa=ra(),this.tu.forEach(e=>{this.uu(e.key)&&(this.Xa=this.Xa.add(e.key))});let t=[];return e.forEach(e=>{this.Xa.has(e)||t.push(new ou(e))}),this.Xa.forEach(n=>{e.has(n)||t.push(new ol(n))}),t}cu(e){this.Ya=e.Qs,this.Xa=ra();let t=this.ru(e.documents);return this.applyChanges(t,!0)}lu(){return a3.fromInitialDocuments(this.query,this.tu,this.mutatedKeys,0===this.Za,this.hasCachedResults)}}let oc="SyncEngine";class od{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class of{constructor(e){this.key=e,this.hu=!1}}class om{constructor(e,t,n,r,i,s){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=i,this.maxConcurrentLimboResolutions=s,this.Pu={},this.Tu=new n9(e=>n4(e),n2),this.Iu=new Map,this.Eu=new Set,this.du=new tM(H.comparator),this.Au=new Map,this.Ru=new s_,this.Vu={},this.mu=new Map,this.fu=sr.cr(),this.onlineState="Unknown",this.gu=void 0}get isPrimaryClient(){return!0===this.gu}}async function og(e,t,n=!0){let r;let i=oG(e),s=i.Tu.get(t);return s?(i.sharedClientState.addLocalQueryTarget(s.targetId),r=s.view.lu()):r=await oy(i,t,n,!0),r}async function op(e,t){let n=oG(e);await oy(n,t,!0,!1)}async function oy(e,t,n,r){let i;let s=await sW(e.localStore,nZ(t)),a=s.targetId,o=e.sharedClientState.addLocalQueryTarget(a,n);return r&&(i=await ow(e,t,a,"current"===o,s.resumeToken)),e.isPrimaryClient&&n&&aV(e.remoteStore,s),i}async function ow(e,t,n,r,i){e.pu=(t,n,r)=>(async function(e,t,n,r){let i=t.view.ru(n);i.Cs&&(i=await sJ(e.localStore,t.query,!1).then(({documents:e})=>t.view.ru(e,i)));let s=r&&r.targetChanges.get(t.targetId),a=r&&null!=r.targetMismatches.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,s,a);return ok(e,t.targetId,o.au),o.snapshot})(e,t,n,r);let s=await sJ(e.localStore,t,!0),a=new oh(t,s.Qs),o=a.ru(s.documents),l=rQ.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,i),u=a.applyChanges(o,e.isPrimaryClient,l);ok(e,n,u.au);let h=new od(t,n,a);return e.Tu.set(t,h),e.Iu.has(n)?e.Iu.get(n).push(t):e.Iu.set(n,[t]),u.snapshot}async function ov(e,t,n){let r=e.Tu.get(t),i=e.Iu.get(r.targetId);if(i.length>1)return e.Iu.set(r.targetId,i.filter(e=>!n2(e,t))),void e.Tu.delete(t);e.isPrimaryClient?(e.sharedClientState.removeLocalQueryTarget(r.targetId),e.sharedClientState.isActiveQueryTarget(r.targetId)||await sH(e.localStore,r.targetId,!1).then(()=>{e.sharedClientState.clearQueryState(r.targetId),n&&aR(e.remoteStore,r.targetId),oC(e,r.targetId)}).catch(ey)):(oC(e,r.targetId),await sH(e.localStore,r.targetId,!0))}async function oI(e,t){let n=e.Tu.get(t),r=e.Iu.get(n.targetId);e.isPrimaryClient&&1===r.length&&(e.sharedClientState.removeLocalQueryTarget(n.targetId),aR(e.remoteStore,n.targetId))}async function oT(e,t,n){let r=oj(e);try{var i;let e;let s=await function(e,t){let n,r;let i=ei.now(),s=t.reduce((e,t)=>e.add(t.key),ra());return e.persistence.runTransaction("Locally write mutations","readwrite",a=>{let o=n7,l=ra();return e.Ns.getEntries(a,s).next(e=>{(o=e).forEach((e,t)=>{t.isValidDocument()||(l=l.add(e))})}).next(()=>e.localDocuments.getOverlayedDocuments(a,o)).next(r=>{n=r;let s=[];for(let e of t){let t=function(e,t){let n=null;for(let r of e.fieldTransforms){let e=t.data.field(r.field),i=rd(r.transform,e||null);null!=i&&(null===n&&(n=nw.empty()),n.set(r.field,i))}return n||null}(e,n.get(e.key).overlayedDocument);null!=t&&s.push(new rA(e.key,t,function e(t){let n=[];return tV(t.fields,(t,r)=>{let i=new W([t]);if(nc(r)){let t=e(r.mapValue).fields;if(0===t.length)n.push(i);else for(let e of t)n.push(i.child(e))}else n.push(i)}),new tq(n)}(t.value.mapValue),rb.exists(!0)))}return e.mutationQueue.addMutationBatch(a,i,s,t)}).next(t=>{r=t;let i=t.applyToLocalDocumentSet(n,l);return e.documentOverlayCache.saveOverlays(a,t.batchId,i)})}).then(()=>({batchId:r.batchId,changes:rn(n)}))}(r.localStore,t);r.sharedClientState.addPendingMutation(s.batchId),i=s.batchId,(e=r.Vu[r.currentUser.toKey()])||(e=new tM(q)),e=e.insert(i,n),r.Vu[r.currentUser.toKey()]=e,await oR(r,s.changes),await aG(r.remoteStore)}catch(t){let e=a4(t,"Failed to persist write");n.reject(e)}}async function oE(e,t){try{let n=await function(e,t){let n=t.snapshotVersion,r=e.Ms;return e.persistence.runTransaction("Apply remote event","readwrite-primary",i=>{let s=e.Ns.newChangeBuffer({trackRemovals:!0});r=e.Ms;let a=[];t.targetChanges.forEach((s,o)=>{var l;let u=r.get(o);if(!u)return;a.push(e.Pi.removeMatchingKeys(i,s.removedDocuments,o).next(()=>e.Pi.addMatchingKeys(i,s.addedDocuments,o)));let h=u.withSequenceNumber(i.currentSequenceNumber);null!==t.targetMismatches.get(o)?h=h.withResumeToken(tz.EMPTY_BYTE_STRING,es.min()).withLastLimboFreeSnapshotVersion(es.min()):s.resumeToken.approximateByteSize()>0&&(h=h.withResumeToken(s.resumeToken,n)),r=r.insert(o,h),l=h,(0===u.resumeToken.approximateByteSize()||l.snapshotVersion.toMicroseconds()-u.snapshotVersion.toMicroseconds()>=3e8||s.addedDocuments.size+s.modifiedDocuments.size+s.removedDocuments.size>0)&&a.push(e.Pi.updateTargetData(i,h))});let o=n7,l=ra();if(t.documentUpdates.forEach(n=>{t.resolvedLimboDocuments.has(n)&&a.push(e.persistence.referenceDelegate.updateLimboDocument(i,n))}),a.push(sQ(i,s,t.documentUpdates).next(e=>{o=e.ks,l=e.qs})),!n.isEqual(es.min())){let t=e.Pi.getLastRemoteSnapshotVersion(i).next(t=>e.Pi.setTargetsMetadata(i,i.currentSequenceNumber,n));a.push(t)}return ew.waitFor(a).next(()=>s.apply(i)).next(()=>e.localDocuments.getLocalViewOfDocuments(i,o,l)).next(()=>o)}).then(t=>(e.Ms=r,t))}(e.localStore,t);t.targetChanges.forEach((t,n)=>{let r=e.Au.get(n);r&&(N(t.addedDocuments.size+t.modifiedDocuments.size+t.removedDocuments.size<=1,22616),t.addedDocuments.size>0?r.hu=!0:t.modifiedDocuments.size>0?N(r.hu,14607):t.removedDocuments.size>0&&(N(r.hu,42227),r.hu=!1))}),await oR(e,n,t)}catch(e){await ey(e)}}function ob(e,t,n){var r;if(e.isPrimaryClient&&0===n||!e.isPrimaryClient&&1===n){let n;let i=[];e.Tu.forEach((e,n)=>{let r=n.view.va(t);r.snapshot&&i.push(r.snapshot)}),(r=e.eventManager).onlineState=t,n=!1,r.queries.forEach((e,r)=>{for(let e of r.Sa)e.va(t)&&(n=!0)}),n&&oi(r),i.length&&e.Pu.H_(i),e.onlineState=t,e.isPrimaryClient&&e.sharedClientState.setOnlineState(t)}}async function o_(e,t,n){e.sharedClientState.updateQueryState(t,"rejected",n);let r=e.Au.get(t),i=r&&r.key;if(i){let n=new tM(H.comparator);n=n.insert(i,nv.newNoDocument(i,es.min()));let r=ra().add(i),s=new rj(es.min(),new Map,new tM(q),n,r);await oE(e,s),e.du=e.du.remove(i),e.Au.delete(t),oV(e)}else await sH(e.localStore,t,!1).then(()=>oC(e,t,n)).catch(ey)}async function oS(e,t){var n;let r=t.batch.batchId;try{let i=await (n=e.localStore).persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{let r=t.batch.keys(),i=n.Ns.newChangeBuffer({trackRemovals:!0});return(function(e,t,n,r){let i=n.batch,s=i.keys(),a=ew.resolve();return s.forEach(e=>{a=a.next(()=>r.getEntry(t,e)).next(t=>{let s=n.docVersions.get(e);N(null!==s,48541),0>t.version.compareTo(s)&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))})(n,e,t,i).next(()=>i.apply(e)).next(()=>n.mutationQueue.performConsistencyCheck(e)).next(()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId)).next(()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=ra();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t))).next(()=>n.localDocuments.getDocuments(e,r))});oD(e,r,null),oN(e,r),e.sharedClientState.updateMutationState(r,"acknowledged"),await oR(e,i)}catch(e){await ey(e)}}async function ox(e,t,n){var r;try{let i=await (r=e.localStore).persistence.runTransaction("Reject batch","readwrite-primary",e=>{let n;return r.mutationQueue.lookupMutationBatch(e,t).next(t=>(N(null!==t,37113),n=t.keys(),r.mutationQueue.removeMutationBatch(e,t))).next(()=>r.mutationQueue.performConsistencyCheck(e)).next(()=>r.documentOverlayCache.removeOverlaysForBatchId(e,n,t)).next(()=>r.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,n)).next(()=>r.localDocuments.getDocuments(e,n))});oD(e,t,n),oN(e,t),e.sharedClientState.updateMutationState(t,"rejected",n),await oR(e,i)}catch(e){await ey(e)}}function oN(e,t){(e.mu.get(t)||[]).forEach(e=>{e.resolve()}),e.mu.delete(t)}function oD(e,t,n){let r=e.Vu[e.currentUser.toKey()];if(r){let i=r.get(t);i&&(n?i.reject(n):i.resolve(),r=r.remove(t)),e.Vu[e.currentUser.toKey()]=r}}function oC(e,t,n=null){for(let r of(e.sharedClientState.removeLocalQueryTarget(t),e.Iu.get(t)))e.Tu.delete(r),n&&e.Pu.yu(r,n);e.Iu.delete(t),e.isPrimaryClient&&e.Ru.jr(t).forEach(t=>{e.Ru.containsKey(t)||oA(e,t)})}function oA(e,t){e.Eu.delete(t.path.canonicalString());let n=e.du.get(t);null!==n&&(aR(e.remoteStore,n),e.du=e.du.remove(t),e.Au.delete(n),oV(e))}function ok(e,t,n){for(let r of n)r instanceof ol?(e.Ru.addReference(r.key,t),function(e,t){let n=t.key,r=n.path.canonicalString();e.du.get(n)||e.Eu.has(r)||(T(oc,"New document in limbo: "+n),e.Eu.add(r),oV(e))}(e,r)):r instanceof ou?(T(oc,"Document no longer in limbo: "+r.key),e.Ru.removeReference(r.key,t),e.Ru.containsKey(r.key)||oA(e,r.key)):S(19791,{wu:r})}function oV(e){for(;e.Eu.size>0&&e.du.size<e.maxConcurrentLimboResolutions;){let t=e.Eu.values().next().value;e.Eu.delete(t);let n=new H(j.fromString(t)),r=e.fu.next();e.Au.set(r,new of(n)),e.du=e.du.insert(n,r),aV(e.remoteStore,new iI(nZ(nH(n.path)),r,"TargetPurposeLimboResolution",eR.ce))}}async function oR(e,t,n){let r=[],i=[],s=[];e.Tu.isEmpty()||(e.Tu.forEach((a,o)=>{s.push(e.pu(o,t,n).then(t=>{if((t||n)&&e.isPrimaryClient){let r=t?!t.fromCache:n?.targetChanges.get(o.targetId)?.current;e.sharedClientState.updateQueryState(o.targetId,r?"current":"not-current")}if(t){r.push(t);let e=sq.As(o.targetId,t);i.push(e)}}))}),await Promise.all(s),e.Pu.H_(r),await async function(e,t){try{await e.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>ew.forEach(t,t=>ew.forEach(t.Es,r=>e.persistence.referenceDelegate.addReference(n,t.targetId,r)).next(()=>ew.forEach(t.ds,r=>e.persistence.referenceDelegate.removeReference(n,t.targetId,r)))))}catch(e){if(!eS(e))throw e;T(sK,"Failed to update sequence numbers: "+e)}for(let n of t){let t=n.targetId;if(!n.fromCache){let n=e.Ms.get(t),r=n.snapshotVersion,i=n.withLastLimboFreeSnapshotVersion(r);e.Ms=e.Ms.insert(t,i)}}}(e.localStore,i))}async function oM(e,t){var n;if(!e.currentUser.isEqual(t)){T(oc,"User change. New user:",t.toKey());let r=await sG(e.localStore,t);e.currentUser=t,n="'waitForPendingWrites' promise is rejected due to a user change.",e.mu.forEach(e=>{e.forEach(e=>{e.reject(new C(D.CANCELLED,n))})}),e.mu.clear(),e.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await oR(e,r.Ls)}}function oO(e,t){let n=e.Au.get(t);if(n&&n.hu)return ra().add(n.key);{let n=ra(),r=e.Iu.get(t);if(!r)return n;for(let t of r){let r=e.Tu.get(t);n=n.unionWith(r.view.nu)}return n}}async function oF(e,t){let n=await sJ(e.localStore,t.query,!0),r=t.view.cu(n);return e.isPrimaryClient&&ok(e,t.targetId,r.au),r}async function oP(e,t){return sX(e.localStore,t).then(t=>oR(e,t))}async function oL(e,t,n,r){let i=await function(e,t){let n=e.mutationQueue;return e.persistence.runTransaction("Lookup mutation documents","readonly",r=>n.er(r,t).next(t=>t?e.localDocuments.getDocuments(r,t):ew.resolve(null)))}(e.localStore,t);null!==i?("pending"===n?await aG(e.remoteStore):"acknowledged"===n||"rejected"===n?(oD(e,t,r||null),oN(e,t),function(e,t){e.mutationQueue.ir(t)}(e.localStore,t)):S(6720,"Unknown batchState",{Su:n}),await oR(e,i)):T(oc,"Cannot apply mutation batch with id: "+t)}async function oU(e,t){if(oG(e),oj(e),!0===t&&!0!==e.gu){let t=e.sharedClientState.getAllActiveQueryTargets(),n=await oq(e,t.toArray());for(let t of(e.gu=!0,await aZ(e.remoteStore,!0),n))aV(e.remoteStore,t)}else if(!1===t&&!1!==e.gu){let t=[],n=Promise.resolve();e.Iu.forEach((r,i)=>{e.sharedClientState.isLocalQueryTarget(i)?t.push(i):n=n.then(()=>(oC(e,i),sH(e.localStore,i,!0))),aR(e.remoteStore,i)}),await n,await oq(e,t),e.Au.forEach((t,n)=>{aR(e.remoteStore,n)}),e.Ru.Jr(),e.Au=new Map,e.du=new tM(H.comparator),e.gu=!1,await aZ(e.remoteStore,!1)}}async function oq(e,t,n){let r=[],i=[];for(let n of t){let t;let s=e.Iu.get(n);if(s&&0!==s.length)for(let n of(t=await sW(e.localStore,nZ(s[0])),s)){let t=e.Tu.get(n),r=await oF(e,t);r.snapshot&&i.push(r.snapshot)}else{let r=await sY(e.localStore,n);t=await sW(e.localStore,r),await ow(e,oB(r),n,!1,t.resumeToken)}r.push(t)}return e.Pu.H_(i),r}function oB(e){var t,n,r,i;return t=e.path,n=e.collectionGroup,r=e.orderBy,i=e.filters,new nW(t,n,r,i,e.limit,"F",e.startAt,e.endAt)}function oz(e){return e.localStore.persistence.Ts()}async function oK(e,t,n,r){if(e.gu)return void T(oc,"Ignoring unexpected query state notification.");let i=e.Iu.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{let r=await sX(e.localStore,n3(i[0])),s=rj.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,tz.EMPTY_BYTE_STRING);await oR(e,r,s);break}case"rejected":await sH(e.localStore,t,!0),oC(e,t,r);break;default:S(64155,n)}}async function o$(e,t,n){let r=oG(e);if(r.gu){for(let e of t){if(r.Iu.has(e)&&r.sharedClientState.isActiveQueryTarget(e)){T(oc,"Adding an already active target "+e);continue}let t=await sY(r.localStore,e),n=await sW(r.localStore,t);await ow(r,oB(t),n.targetId,!1,n.resumeToken),aV(r.remoteStore,n)}for(let e of n)r.Iu.has(e)&&await sH(r.localStore,e,!1).then(()=>{aR(r.remoteStore,e),oC(r,e)}).catch(ey)}}function oG(e){return e.remoteStore.remoteSyncer.applyRemoteEvent=oE.bind(null,e),e.remoteStore.remoteSyncer.getRemoteKeysForTarget=oO.bind(null,e),e.remoteStore.remoteSyncer.rejectListen=o_.bind(null,e),e.Pu.H_=on.bind(null,e.eventManager),e.Pu.yu=or.bind(null,e.eventManager),e}function oj(e){return e.remoteStore.remoteSyncer.applySuccessfulWrite=oS.bind(null,e),e.remoteStore.remoteSyncer.rejectFailedWrite=ox.bind(null,e),e}class oQ{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(e){this.serializer=av(e.databaseInfo.databaseId),this.sharedClientState=this.Du(e),this.persistence=this.Cu(e),await this.persistence.start(),this.localStore=this.vu(e),this.gcScheduler=this.Fu(e,this.localStore),this.indexBackfillerScheduler=this.Mu(e,this.localStore)}Fu(e,t){return null}Mu(e,t){return null}vu(e){var t;return t=this.persistence,new s$(t,new sz,e.initialUser,this.serializer)}Cu(e){return new sA(sV.mi,this.serializer)}Du(e){return new as}async terminate(){this.gcScheduler?.stop(),this.indexBackfillerScheduler?.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}oQ.provider={build:()=>new oQ};class oW extends oQ{constructor(e){super(),this.cacheSizeBytes=e}Fu(e,t){return N(this.persistence.referenceDelegate instanceof sR,46915),new su(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Cu(e){let t=void 0!==this.cacheSizeBytes?i8.withCacheSize(this.cacheSizeBytes):i8.DEFAULT;return new sA(e=>sR.mi(e,t),this.serializer)}}class oH extends oQ{constructor(e,t,n){super(),this.xu=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.kind="persistent",this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.xu.initialize(this,e),await oj(this.xu.syncEngine),await aG(this.xu.remoteStore),await this.persistence.Ji(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}vu(e){var t;return t=this.persistence,new s$(t,new sz,e.initialUser,this.serializer)}Fu(e,t){return new su(this.persistence.referenceDelegate.garbageCollector,e.asyncQueue,t)}Mu(e,t){let n=new eV(t,this.persistence);return new ek(e.asyncQueue,n)}Cu(e){let t=sU(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?i8.withCacheSize(this.cacheSizeBytes):i8.DEFAULT;return new sL(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,ay(),aw(),this.serializer,this.sharedClientState,!!this.forceOwnership)}Du(e){return new as}}class oJ{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>ob(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=oM.bind(null,this.syncEngine),await aZ(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new a9}createDatastore(e){let t=av(e.databaseInfo.databaseId),n=new ap(e.databaseInfo);return new ax(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){var t;return t=this.localStore,new aC(t,this.datastore,e.asyncQueue,e=>ob(this.syncEngine,e,0),al.v()?new al:new aa)}createSyncEngine(e,t){return function(e,t,n,r,i,s,a){let o=new om(e,t,n,r,i,s);return a&&(o.gu=!0),o}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){await async function(e){T(aD,"RemoteStore shutting down."),e.Ea.add(5),await ak(e),e.Aa.shutdown(),e.Ra.set("Unknown")}(this.remoteStore),this.datastore?.terminate(),this.eventManager?.terminate()}}oJ.provider={build:()=>new oJ};class oY{constructor(e){this.observer=e,this.muted=!1}next(e){this.muted||this.observer.next&&this.Ou(this.observer.next,e)}error(e){this.muted||(this.observer.error?this.Ou(this.observer.error,e):E("Uncaught Error in snapshot listener:",e.toString()))}Nu(){this.muted=!0}Ou(e,t){setTimeout(()=>{this.muted||e(t)},0)}}let oX="FirestoreClient";class oZ{constructor(e,t,n,r,i){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=y.UNAUTHENTICATED,this.clientId=U.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=i,this.authCredentials.start(n,async e=>{T(oX,"Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(T(oX,"Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}terminate(){this.asyncQueue.enterRestrictedMode();let e=new A;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(n){let t=a4(n,"Failed to shutdown persistence");e.reject(t)}}),e.promise}}async function o0(e,t){e.asyncQueue.verifyOperationInProgress(),T(oX,"Initializing OfflineComponentProvider");let n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await sG(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e._offlineComponents=t}async function o1(e,t){e.asyncQueue.verifyOperationInProgress();let n=await o2(e);T(oX,"Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener(e=>aX(t.remoteStore,e)),e.setAppCheckTokenChangeListener((e,n)=>aX(t.remoteStore,n)),e._onlineComponents=t}async function o2(e){if(!e._offlineComponents){if(e._uninitializedComponentsProvider){T(oX,"Using user provided OfflineComponentProvider");try{await o0(e,e._uninitializedComponentsProvider._offline)}catch(t){if(!("FirebaseError"===t.name?t.code===D.FAILED_PRECONDITION||t.code===D.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw t;b("Error using user provided cache. Falling back to memory cache: "+t),await o0(e,new oQ)}}else T(oX,"Using default OfflineComponentProvider"),await o0(e,new oW(void 0))}return e._offlineComponents}async function o4(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(T(oX,"Using user provided OnlineComponentProvider"),await o1(e,e._uninitializedComponentsProvider._online)):(T(oX,"Using default OnlineComponentProvider"),await o1(e,new oJ))),e._onlineComponents}async function o5(e){let t=await o4(e),n=t.eventManager;return n.onListen=og.bind(null,t.syncEngine),n.onUnlisten=ov.bind(null,t.syncEngine),n.onFirstRemoteStoreListen=op.bind(null,t.syncEngine),n.onLastRemoteStoreUnlisten=oI.bind(null,t.syncEngine),n}function o6(e){let t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}let o3=new Map,o8="firestore.googleapis.com";class o9{constructor(e){if(void 0===e.host){if(void 0!==e.ssl)throw new C(D.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host=o8,this.ssl=!0}else this.host=e.host,this.ssl=e.ssl??!0;if(this.isUsingEmulator=void 0!==e.emulatorOptions,this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=0x2800000;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new C(D.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}(function(e,t,n,r){if(!0===t&&!0===r)throw new C(D.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)})("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=o6(e.experimentalLongPollingOptions??{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new C(D.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new C(D.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new C(D.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){var t,n;return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class o7{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new o9({}),this._settingsFrozen=!1,this._emulatorOptions={},this._terminateTask="notTerminated"}get app(){if(!this._app)throw new C(D.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return"notTerminated"!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new C(D.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new o9(e),this._emulatorOptions=e.emulatorOptions||{},void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new V;switch(e.type){case"firstParty":return new F(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new C(D.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_getEmulatorOptions(){return this._emulatorOptions}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return"notTerminated"===this._terminateTask&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){"notTerminated"===this._terminateTask?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){let t=o3.get(e);t&&(T("ComponentProvider","Removing Datastore"),o3.delete(e),t.terminate())}(this),Promise.resolve()}}class le{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new le(this.firestore,e,this._query)}}class lt{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new ln(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new lt(this.firestore,e,this._key)}toJSON(){return{type:lt._jsonSchemaVersion,referencePath:this._key.toString()}}static fromJSON(e,t,n){if(er(t,lt._jsonSchema))return new lt(e,n||null,new H(j.fromString(t.referencePath)))}}lt._jsonSchemaVersion="firestore/documentReference/1.0",lt._jsonSchema={type:en("string",lt._jsonSchemaVersion),referencePath:en("string")};class ln extends le{constructor(e,t,n){super(e,t,nH(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){let e=this._path.popLast();return e.isEmpty()?null:new lt(this.firestore,null,new H(e))}withConverter(e){return new ln(this.firestore,e,this._path)}}function lr(e,t,...n){if(e=(0,h.Ku)(e),J("collection","path",t),e instanceof o7){let r=j.fromString(t,...n);return X(r),new ln(e,null,r)}{if(!(e instanceof lt||e instanceof ln))throw new C(D.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(j.fromString(t,...n));return X(r),new ln(e.firestore,null,r)}}let li="AsyncQueue";class ls{constructor(e=Promise.resolve()){this.Xu=[],this.ec=!1,this.tc=[],this.nc=null,this.rc=!1,this.sc=!1,this.oc=[],this.M_=new aI(this,"async_queue_retry"),this._c=()=>{let e=aw();e&&T(li,"Visibility state changed to "+e.visibilityState),this.M_.w_()},this.ac=e;let t=aw();t&&"function"==typeof t.addEventListener&&t.addEventListener("visibilitychange",this._c)}get isShuttingDown(){return this.ec}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.uc(),this.cc(e)}enterRestrictedMode(e){if(!this.ec){this.ec=!0,this.sc=e||!1;let t=aw();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._c)}}enqueue(e){if(this.uc(),this.ec)return new Promise(()=>{});let t=new A;return this.cc(()=>this.ec&&this.sc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Xu.push(e),this.lc()))}async lc(){if(0!==this.Xu.length){try{await this.Xu[0](),this.Xu.shift(),this.M_.reset()}catch(e){if(!eS(e))throw e;T(li,"Operation failed with retryable error: "+e)}this.Xu.length>0&&this.M_.p_(()=>this.lc())}}cc(e){let t=this.ac.then(()=>(this.rc=!0,e().catch(e=>{throw this.nc=e,this.rc=!1,E("INTERNAL UNHANDLED ERROR: ",la(e)),e}).then(e=>(this.rc=!1,e))));return this.ac=t,t}enqueueAfterDelay(e,t,n){this.uc(),this.oc.indexOf(e)>-1&&(t=0);let r=a2.createAndSchedule(this,e,t,n,e=>this.hc(e));return this.tc.push(r),r}uc(){this.nc&&S(47125,{Pc:la(this.nc)})}verifyOperationInProgress(){}async Tc(){let e;do e=this.ac,await e;while(e!==this.ac)}Ic(e){for(let t of this.tc)if(t.timerId===e)return!0;return!1}Ec(e){return this.Tc().then(()=>{for(let t of(this.tc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs),this.tc))if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.Tc()})}dc(e){this.oc.push(e)}hc(e){let t=this.tc.indexOf(e);this.tc.splice(t,1)}}function la(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}class lo extends o7{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new ls,this._persistenceKey=r?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){let e=this._firestoreClient.terminate();this._queue=new ls(e),this._firestoreClient=void 0,await e}}}function ll(e,t){let n="object"==typeof e?e:(0,o.Sx)(),r=(0,o.j6)(n,"firestore").getImmediate({identifier:"string"==typeof e?e:t||t1});if(!r._initialized){let e=(0,h.yU)("firestore");e&&function(e,t,n,r={}){e=et(e,o7);let i=(0,h.zJ)(t),s=e._getSettings(),a={...s,emulatorOptions:e._getEmulatorOptions()},o=`${t}:${n}`;i&&((0,h.gE)(`https://${o}`),(0,h.P1)("Firestore",!0)),s.host!==o8&&s.host!==o&&b("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used.");let l={...s,host:o,ssl:i,emulatorOptions:r};if(!(0,h.bD)(l,a)&&(e._setSettings(l),r.mockUserToken)){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=y.MOCK_USER;else{t=(0,h.Fy)(r.mockUserToken,e._app?.options.projectId);let i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new C(D.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new y(i)}e._authCredentials=new R(new k(t,n))}}(r,...e)}return r}function lu(e){if(e._terminated)throw new C(D.FAILED_PRECONDITION,"The client has already been terminated.");return e._firestoreClient||function(e){var t;let n=e._freezeSettings(),r=(t=e._databaseId,new t0(t,e._app?.options.appId||"",e._persistenceKey,n.host,n.ssl,n.experimentalForceLongPolling,n.experimentalAutoDetectLongPolling,o6(n.experimentalLongPollingOptions),n.useFetchStreams,n.isUsingEmulator));e._componentsProvider||n.localCache?._offlineComponentProvider&&n.localCache?._onlineComponentProvider&&(e._componentsProvider={_offline:n.localCache._offlineComponentProvider,_online:n.localCache._onlineComponentProvider}),e._firestoreClient=new oZ(e._authCredentials,e._appCheckCredentials,e._queue,r,e._componentsProvider&&function(e){let t=e?._online.build();return{_offline:e?._offline.build(t),_online:t}}(e._componentsProvider))}(e),e._firestoreClient}class lh{constructor(e){this._byteString=e}static fromBase64String(e){try{return new lh(tz.fromBase64String(e))}catch(e){throw new C(D.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new lh(tz.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}toJSON(){return{type:lh._jsonSchemaVersion,bytes:this.toBase64()}}static fromJSON(e){if(er(e,lh._jsonSchema))return lh.fromBase64String(e.bytes)}}lh._jsonSchemaVersion="firestore/bytes/1.0",lh._jsonSchema={type:en("string",lh._jsonSchemaVersion),bytes:en("string")};class lc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new C(D.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class ld{constructor(e){this._methodName=e}}class lf{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new C(D.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new C(D.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}_compareTo(e){return q(this._lat,e._lat)||q(this._long,e._long)}toJSON(){return{latitude:this._lat,longitude:this._long,type:lf._jsonSchemaVersion}}static fromJSON(e){if(er(e,lf._jsonSchema))return new lf(e.latitude,e.longitude)}}lf._jsonSchemaVersion="firestore/geoPoint/1.0",lf._jsonSchema={type:en("string",lf._jsonSchemaVersion),latitude:en("number"),longitude:en("number")};class lm{constructor(e){this._values=(e||[]).map(e=>e)}toArray(){return this._values.map(e=>e)}isEqual(e){return function(e,t){if(e.length!==t.length)return!1;for(let n=0;n<e.length;++n)if(e[n]!==t[n])return!1;return!0}(this._values,e._values)}toJSON(){return{type:lm._jsonSchemaVersion,vectorValues:this._values}}static fromJSON(e){if(er(e,lm._jsonSchema)){if(Array.isArray(e.vectorValues)&&e.vectorValues.every(e=>"number"==typeof e))return new lm(e.vectorValues);throw new C(D.INVALID_ARGUMENT,"Expected 'vectorValues' field to be a number array")}}}lm._jsonSchemaVersion="firestore/vectorValue/1.0",lm._jsonSchema={type:en("string",lm._jsonSchemaVersion),vectorValues:en("object")};let lg=/^__.*__$/;class lp{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new rA(e,this.data,this.fieldMask,t,this.fieldTransforms):new rC(e,this.data,t,this.fieldTransforms)}}class ly{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new rA(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function lw(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw S(40011,{Ac:e})}}class lv{constructor(e,t,n,r,i,s){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===i&&this.Rc(),this.fieldTransforms=i||[],this.fieldMask=s||[]}get path(){return this.settings.path}get Ac(){return this.settings.Ac}Vc(e){return new lv({...this.settings,...e},this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}mc(e){let t=this.path?.child(e),n=this.Vc({path:t,fc:!1});return n.gc(e),n}yc(e){let t=this.path?.child(e),n=this.Vc({path:t,fc:!1});return n.Rc(),n}wc(e){return this.Vc({path:void 0,fc:!0})}Sc(e){return lP(e,this.settings.methodName,this.settings.bc||!1,this.path,this.settings.Dc)}contains(e){return void 0!==this.fieldMask.find(t=>e.isPrefixOf(t))||void 0!==this.fieldTransforms.find(t=>e.isPrefixOf(t.field))}Rc(){if(this.path)for(let e=0;e<this.path.length;e++)this.gc(this.path.get(e))}gc(e){if(0===e.length)throw this.Sc("Document fields must not be empty");if(lw(this.Ac)&&lg.test(e))throw this.Sc('Document fields cannot begin and end with "__"')}}class lI{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||av(e)}Cc(e,t,n,r=!1){return new lv({Ac:e,methodName:t,Dc:n,path:W.emptyPath(),fc:!1,bc:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function lT(e){let t=e._freezeSettings(),n=av(e._databaseId);return new lI(e._databaseId,!!t.ignoreUndefinedProperties,n)}function lE(e,t,n,r,i,s={}){let a,o;let l=e.Cc(s.merge||s.mergeFields?2:0,t,n,i);lR("Data must be an object, but it was:",l,r);let u=lk(r,l);if(s.merge)a=new tq(l.fieldMask),o=l.fieldTransforms;else if(s.mergeFields){let e=[];for(let r of s.mergeFields){let i=lM(t,r,n);if(!l.contains(i))throw new C(D.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);lL(e,i)||e.push(i)}a=new tq(e),o=l.fieldTransforms.filter(e=>a.covers(e.field))}else a=null,o=l.fieldTransforms;return new lp(new nw(u),a,o)}class lb extends ld{_toFieldTransform(e){if(2!==e.Ac)throw 1===e.Ac?e.Sc(`${this._methodName}() can only appear at the top level of your update data`):e.Sc(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof lb}}function l_(e,t,n){return new lv({Ac:3,Dc:t.settings.Dc,methodName:e._methodName,fc:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class lS extends null{_toFieldTransform(e){return new rT(e.path,new rf)}isEqual(e){return e instanceof lS}}class lx extends ld{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){let t=l_(this,e,!0),n=new rm(this.vc.map(e=>lA(e,t)));return new rT(e.path,n)}isEqual(e){return e instanceof lx&&(0,h.bD)(this.vc,e.vc)}}class lN extends ld{constructor(e,t){super(e),this.vc=t}_toFieldTransform(e){let t=l_(this,e,!0),n=new rp(this.vc.map(e=>lA(e,t)));return new rT(e.path,n)}isEqual(e){return e instanceof lN&&(0,h.bD)(this.vc,e.vc)}}class lD extends ld{constructor(e,t){super(e),this.Fc=t}_toFieldTransform(e){let t=new rw(e.serializer,rh(e.serializer,this.Fc));return new rT(e.path,t)}isEqual(e){return e instanceof lD&&this.Fc===e.Fc}}function lC(e,t,n,r=!1){return lA(n,e.Cc(r?4:3,t))}function lA(e,t){if(lV(e=(0,h.Ku)(e)))return lR("Unsupported field value:",t,e),lk(e,t);if(e instanceof ld)return function(e,t){if(!lw(t.Ac))throw t.Sc(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.Sc(`${e._methodName}() is not currently supported inside arrays`);let n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.fc&&4!==t.Ac)throw t.Sc("Nested arrays are not supported");return function(e,t){let n=[],r=0;for(let i of e){let e=lA(i,t.wc(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,h.Ku)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return rh(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){let n=ei.fromDate(e);return{timestampValue:r3(t.serializer,n)}}if(e instanceof ei){let n=new ei(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:r3(t.serializer,n)}}if(e instanceof lf)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof lh)return{bytesValue:r8(t.serializer,e._byteString)};if(e instanceof lt){let n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.Sc(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:r7(e.firestore._databaseId||t.databaseId,e._key.path)}}if(e instanceof lm)return{mapValue:{fields:{[t4]:{stringValue:t3},[t8]:{arrayValue:{values:e.toArray().map(e=>{if("number"!=typeof e)throw t.Sc("VectorValues must only contain numeric values.");return rl(t.serializer,e)})}}}}};throw t.Sc(`Unsupported field value: ${ee(e)}`)}(e,t)}function lk(e,t){let n={};return tR(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):tV(e,(e,r)=>{let i=lA(r,t.mc(e));null!=i&&(n[e]=i)}),{mapValue:{fields:n}}}function lV(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof ei||e instanceof lf||e instanceof lh||e instanceof lt||e instanceof ld||e instanceof lm)}function lR(e,t,n){if(!lV(n)||!Z(n)){let r=ee(n);throw"an object"===r?t.Sc(e+" a custom object"):t.Sc(e+" "+r)}}function lM(e,t,n){if((t=(0,h.Ku)(t))instanceof lc)return t._internalPath;if("string"==typeof t)return lF(e,t);throw lP("Field path arguments must be of type string or ",e,!1,void 0,n)}let lO=RegExp("[~\\*/\\[\\]]");function lF(e,t,n){if(t.search(lO)>=0)throw lP(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new lc(...t.split("."))._internalPath}catch(r){throw lP(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function lP(e,t,n,r,i){let s=r&&!r.isEmpty(),a=void 0!==i,o=`Function ${t}() called with invalid data`;n&&(o+=" (via `toFirestore()`)"),o+=". ";let l="";return(s||a)&&(l+=" (found",s&&(l+=` in field ${r}`),a&&(l+=` in document ${i}`),l+=")"),new C(D.INVALID_ARGUMENT,o+e+l)}function lL(e,t){return e.some(e=>e.isEqual(t))}class lU{constructor(e,t,n,r,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new lt(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){let e=new lq(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){let t=this._document.data.field(lB("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class lq extends lU{data(){return super.data()}}function lB(e,t){return"string"==typeof t?lF(e,t):t instanceof lc?t._internalPath:t._delegate._internalPath}class lz{}class lK extends lz{}function l$(e,t,...n){let r=[];for(let i of(t instanceof lz&&r.push(t),function(e){let t=e.filter(e=>e instanceof lj).length,n=e.filter(e=>e instanceof lG).length;if(t>1||t>0&&n>0)throw new C(D.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r=r.concat(n)),r))e=i._apply(e);return e}class lG extends lK{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new lG(e,t,n)}_apply(e){let t=this._parse(e);return l1(e._query,t),new le(e.firestore,e.converter,n0(e._query,t))}_parse(e){let t=lT(e.firestore);return function(e,t,n,r,i,s,a){let o;if(i.isKeyField()){if("array-contains"===s||"array-contains-any"===s)throw new C(D.INVALID_ARGUMENT,`Invalid Query. You can't perform '${s}' queries on documentId().`);if("in"===s||"not-in"===s){l0(a,s);let t=[];for(let n of a)t.push(lZ(r,e,n));o={arrayValue:{values:t}}}else o=lZ(r,e,a)}else"in"!==s&&"not-in"!==s&&"array-contains-any"!==s||l0(a,s),o=lC(n,t,a,"in"===s||"not-in"===s);return nS.create(i,s,o)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value)}}class lj extends lz{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new lj(e,t)}_parse(e){let t=this._queryConstraints.map(t=>t._parse(e)).filter(e=>e.getFilters().length>0);return 1===t.length?t[0]:nx.create(t,this._getOperator())}_apply(e){let t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;for(let e of t.getFlattenedFilters())l1(n,e),n=n0(n,e)}(e._query,t),new le(e.firestore,e.converter,n0(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class lQ extends lK{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new lQ(e,t)}_apply(e){let t=function(e,t,n){if(null!==e.startAt)throw new C(D.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new C(D.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new nb(t,n)}(e._query,this._field,this._direction);return new le(e.firestore,e.converter,function(e,t){let n=e.explicitOrderBy.concat([t]);return new nW(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function lW(e,t="asc"){let n=lB("orderBy",e);return lQ._create(n,t)}class lH extends lK{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new lH(e,t,n)}_apply(e){return new le(e.firestore,e.converter,n1(e._query,this._limit,this._limitType))}}class lJ extends lK{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lJ(e,t,n)}_apply(e){var t;let n=lX(e,this.type,this._docOrFields,this._inclusive);return new le(e.firestore,e.converter,new nW((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,n,t.endAt))}}class lY extends lK{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new lY(e,t,n)}_apply(e){var t;let n=lX(e,this.type,this._docOrFields,this._inclusive);return new le(e.firestore,e.converter,new nW((t=e._query).path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,n))}}function lX(e,t,n,r){if(n[0]=(0,h.Ku)(n[0]),n[0]instanceof lU)return function(e,t,n,r,i){if(!r)throw new C(D.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);let s=[];for(let n of nX(e))if(n.field.isKeyField())s.push(na(t,r.key));else{let e=r.data.field(n.field);if(tY(e))throw new C(D.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){let e=n.field.canonicalString();throw new C(D.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}s.push(e)}return new nI(s,i)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{let i=lT(e.firestore);return function(e,t,n,r,i,s){let a=e.explicitOrderBy;if(i.length>a.length)throw new C(D.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);let o=[];for(let s=0;s<i.length;s++){let l=i[s];if(a[s].field.isKeyField()){if("string"!=typeof l)throw new C(D.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof l}`);if(!nY(e)&&-1!==l.indexOf("/"))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${l}' contains a slash.`);let n=e.path.child(j.fromString(l));if(!H.isDocumentKey(n))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);let i=new H(n);o.push(na(t,i))}else{let e=lC(n,r,l);o.push(e)}}return new nI(o,s)}(e._query,e.firestore._databaseId,i,t,n,r)}}function lZ(e,t,n){if("string"==typeof(n=(0,h.Ku)(n))){if(""===n)throw new C(D.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!nY(t)&&-1!==n.indexOf("/"))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);let r=t.path.child(j.fromString(n));if(!H.isDocumentKey(r))throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return na(e,new H(r))}if(n instanceof lt)return na(e,n._key);throw new C(D.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${ee(n)}.`)}function l0(e,t){if(!Array.isArray(e)||0===e.length)throw new C(D.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function l1(e,t){let n=function(e,t){for(let n of e)for(let e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new C(D.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new C(D.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}class l2{convertValue(e,t="none"){switch(t7(e)){case 0:return null;case 1:return e.booleanValue;case 2:return tG(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(tj(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 11:return this.convertObject(e.mapValue,t);case 10:return this.convertVectorValue(e.mapValue);default:throw S(62114,{value:e})}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){let n={};return tV(e,(e,r)=>{n[e]=this.convertValue(r,t)}),n}convertVectorValue(e){return new lm(e.fields?.[t8].arrayValue?.values?.map(e=>tG(e.doubleValue)))}convertGeoPoint(e){return new lf(tG(e.latitude),tG(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":let n=tX(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(tZ(e));default:return null}}convertTimestamp(e){let t=t$(e);return new ei(t.seconds,t.nanos)}convertDocumentKey(e,t){let n=j.fromString(e);N(iv(n),9688,{name:e});let r=new t2(n.get(1),n.get(3)),i=new H(n.popFirst(5));return r.isEqual(t)||E(`Document ${i} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function l4(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class l5 extends l2{constructor(e){super(),this.firestore=e}convertBytes(e){return new lh(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lt(this.firestore,null,t)}}class l6{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class l3 extends lU{constructor(e,t,n,r,i,s){super(e,t,n,r,s),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){let t=new l8(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){let n=this._document.data.field(lB("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}toJSON(){if(this.metadata.hasPendingWrites)throw new C(D.FAILED_PRECONDITION,"DocumentSnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e=this._document,t={};return t.type=l3._jsonSchemaVersion,t.bundle="",t.bundleSource="DocumentSnapshot",t.bundleName=this._key.toString(),e&&e.isValidDocument()&&e.isFoundDocument()&&(this._userDataWriter.convertObjectMap(e.data.value.mapValue.fields,"previous"),t.bundle=(this._firestore,this.ref.path,"NOT SUPPORTED")),t}}l3._jsonSchemaVersion="firestore/documentSnapshot/1.0",l3._jsonSchema={type:en("string",l3._jsonSchemaVersion),bundleSource:en("string","DocumentSnapshot"),bundleName:en("string"),bundle:en("string")};class l8 extends l3{data(e={}){return super.data(e)}}class l9{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new l6(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){let e=[];return this.forEach(t=>e.push(t)),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach(n=>{e.call(t,new l8(this._firestore,this._userDataWriter,n.key,n,new l6(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){let t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new C(D.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map(n=>{let r=new l8(e._firestore,e._userDataWriter,n.doc.key,n.doc,new l6(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}})}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter(e=>t||3!==e.type).map(t=>{let r=new l8(e._firestore,e._userDataWriter,t.doc.key,t.doc,new l6(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter),i=-1,s=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(s=(n=n.add(t.doc)).indexOf(t.doc.key)),{type:function(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return S(61501,{type:e})}}(t.type),doc:r,oldIndex:i,newIndex:s}})}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}toJSON(){if(this.metadata.hasPendingWrites)throw new C(D.FAILED_PRECONDITION,"QuerySnapshot.toJSON() attempted to serialize a document with pending writes. Await waitForPendingWrites() before invoking toJSON().");let e={};e.type=l9._jsonSchemaVersion,e.bundleSource="QuerySnapshot",e.bundleName=U.newId(),this._firestore._databaseId.database,this._firestore._databaseId.projectId;let t=[],n=[],r=[];return this.docs.forEach(e=>{null!==e._document&&(t.push(e._document),n.push(this._userDataWriter.convertObjectMap(e._document.data.value.mapValue.fields,"previous")),r.push(e.ref.path))}),e.bundle=(this._firestore,this.query._query,e.bundleName,"NOT SUPPORTED"),e}}l9._jsonSchemaVersion="firestore/querySnapshot/1.0",l9._jsonSchema={type:en("string",l9._jsonSchemaVersion),bundleSource:en("string","QuerySnapshot"),bundleName:en("string"),bundle:en("string")};class l7 extends l2{constructor(e){super(),this.firestore=e}convertBytes(e){return new lh(e)}convertReference(e){let t=this.convertDocumentKey(e,this.firestore._databaseId);return new lt(this.firestore,null,t)}}function ue(e){e=et(e,le);let t=et(e.firestore,lo),n=lu(t),r=new l7(t);return function(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new C(D.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}(e._query),(function(e,t,n={}){let r=new A;return e.asyncQueue.enqueueAndForget(async()=>(function(e,t,n,r,i){let s=new oY({next:n=>{s.Nu(),t.enqueueAndForget(()=>ot(e,a)),n.fromCache&&"server"===r.source?i.reject(new C(D.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),a=new os(n,s,{includeMetadataChanges:!0,qa:!0});return oe(e,a)})(await o5(e),e.asyncQueue,t,n,r)),r.promise})(n,e._query).then(n=>new l9(t,r,e,n))}function ut(e,t){var n,r;let i=et(e.firestore,lo),s=function(e,t,...n){if(e=(0,h.Ku)(e),1==arguments.length&&(t=U.newId()),J("doc","path",t),e instanceof o7){let r=j.fromString(t,...n);return Y(r),new lt(e,null,new H(r))}{if(!(e instanceof lt||e instanceof ln))throw new C(D.INVALID_ARGUMENT,"Expected first argument to doc() to be a CollectionReference, a DocumentReference or FirebaseFirestore");let r=e._path.child(j.fromString(t,...n));return Y(r),new lt(e.firestore,e instanceof ln?e.converter:null,new H(r))}}(e),a=l4(e.converter,t);return(n=i,r=[lE(lT(e.firestore),"addDoc",s._key,a,null!==e.converter,{}).toMutation(s._key,rb.exists(!1))],function(e,t){let n=new A;return e.asyncQueue.enqueueAndForget(async()=>oT(await o4(e).then(e=>e.syncEngine),t,n)),n.promise}(lu(n),r)).then(()=>s)}function un(e,t){if((e=(0,h.Ku)(e)).firestore!==t)throw new C(D.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}new WeakMap,function(e=!0){w=o.MF,(0,o.om)(new l.uA("firestore",(t,{instanceIdentifier:n,options:r})=>{let i=t.getProvider("app").getImmediate(),s=new lo(new M(t.getProvider("auth-internal")),new L(i,t.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new C(D.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new t2(e.options.projectId,t)}(i,n),i);return r={useFetchStreams:e,...r},s._setSettings(r),s},"PUBLIC").setMultipleInstances(!0)),(0,o.KO)(g,p,void 0),(0,o.KO)(g,p,"esm2020")}()}}]);